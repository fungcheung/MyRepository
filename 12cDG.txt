==========================================================================================================================
===  Setup Oracle data guard 12c in Fedora 23 Server and test other implementation stuff for SC/EKEO projects in Azure
==========================================================================================================================

Table of Contents
--------------------------------------------------------------------------
Reference
Environments
Production setup considerations
Setup Fedora 23 server
Setup Oracle 12.1.0.2 Active Data Guard in Fedora 23 with Virtual Box
Setup data guard broker
Create oracle recovery catalog to support DG backup
Test switchover
Test manual failover
Test fast-start failover
Test PSU patching
Test create geodatabase
Problems hit during setup or afterward
. TNSPING failed from dg1 to dg2 and vice versa
. Even /etc/oratab was set 'Y', the oracle database and listenr not started up on reboot
. Failed to create the standby using the duplicate command in rman.txt
. Switchover failed because of ORA-01017
. The pdbseed temp01.dbf not verified due to error ORA-01122 in Primary alertlog
. datapatch on primary failed.catconInit failed, exiting.validate_con_names: PDB$SEED is not open.
. RMAN backup failed.ORA-20079: full resync from primary database is not done.RMAN-03014: implicit resync of recovery catalog failed.
. failed to upgrade catalog in vbgeneric from dg2. error creating dbms_rcvcat package body.
. ORA-16737: the redo transport service for standby database "cdb2" has an error
. RMAN-20051: datafile resync not completed
. RMAN-20999: internal error

FAQ
. How to delay the application of logs to a physical standby?
. How to cancel the apply process?
. How to turn-on, turn-off the transport of redo data to standby database?
. How to turn-on, turn-off the apply of redo data on the standby database?
. How to cleanup applied archived log in primary and standby?
. How to check the current mode of the standby database ?
. Is the tns alias name in tnsnames.ora case sensitive in Linux?
. As the db is in force logging mode, can I do a truncate on a table?
. How to setup the observer?
. How to startup/shutdown the physical standby database?
. How to setup flashback database and prepare the initialization parameters?
. What happen when shut down the observer machine?
. How to refresh the Password File?
. Primary Database Changes That Require Manual Intervention at a Physical Standby
. How to drop online redo logs in Primary and standby?
. If listeners in DG down, does it affect redo transport and log apply?
. Under max performance and max availability modes, can primary still commit txn if standby is down?
. How to alert application in jdbc to switch connection whenever DG role change because of switchover/failover?(pending)
. How to allow seamless access in sqlplus (OCI) in DG failover
. How to set connection failover in JDBC
. What should be the backup/recovery strategy if not using catelog database?
. What is the purpose of flashback database in DG?
. How to enable history function in sqlplus/rman/dgmgrl under Linux?
. LOG_ARCHIVE_FORMAT is ignored in these cases
. How to check log transport status after setup?
. How to remove DG broker?(pending)
. License required for oracle recovery catalog?
. Configuring automatic startup of Oracle Database under systemd on RHEL 7/OEL 7/CentOS 7
. Automating Database Startup and Shutdown on Linux
. Automating Data Guard Database Startup and Shutdown on Linux
. How to backup the recovery catalog?
. How to restore/recover a datafile in pluggable database in DG primary env?
. How to restore/recover a loss controlfile in DG primary env?
. How to restore/recover a loss redo in DG primary env?
. Can manual failover occur if unsynchronized or lag behind?
. How to stop the observer when primary and standby are isolated?
. How to shutdown databases in FSFO env?
. How to startp primary due to FRA is full?
. ORA-16649 "possible failover to another database prevents this database from being opened" on opening primary
. How to re-create physical standby database?
. How to allow oracle user to execute root command using sudo?
. How to add/drop logfile memeber?
. How to send mail from Linux(fedora) through Gmail SMTP?
. Why the NAT interface does not work when the HOST-ONLY interface is up?(pending)
. How to prevent "Network error: Software caused connection abort" in Putty
. How to detect switchover,failover,fsfo
Appendix
Incidents

==========================================================================================================================
===  Reference
==========================================================================================================================
 ADG VM scripts (very useful)
 D:\shared\ADG\

 Data Guard Concepts and Administration -> Creating a Physical Standby Database
 https://docs.oracle.com/database/121/SBYDB/create_ps.htm#SBYDB00200

 Data Guard Physical Standby Setup in Oracle Database 11g Release 2 (very useful)
 https://oracle-base.com/articles/11g/data-guard-setup-11gr2
 
 DG introduction, please refer to 
 http://docs.oracle.com/cd/E11882_01/server.112/e25608/concepts.htm#i1039416

 Oracle Patch Assurance - Data Guard Standby-First Patch Apply (Doc ID 1265700.1)
 How do you apply a Patchset,PSU or CPU in a Data Guard Physical Standby configuration (Doc ID 278641.1)
 
==========================================================================================================================
===  Environments
==========================================================================================================================
The testing are all done in oracle virtual box using two VMs dg1 and dg2

dg1 192.168.56.101 cdb1
dg2 192.168.56.102 cdb2

root/oracle
oracle/oracle

Assumptions
 dg1 has a running instance.
 dg2 has a software only installation.

==========================================================================================================================
===  Production setup considerations
==========================================================================================================================
1. Configure 3 redo log groups, each with 2 logfiles of 300M each. So total size is 1.8G
2. Store Oracle binary, data files and archived logs in 3 different filesystems/hard disks.
3. Set the FastStartFailoverThreshold to 600 seconds for production.
4. Set the FastStartFailoverLagLimit to allow failover to fall behind the primary in terms of redo applied, beyond which a fast-start failover will not be allowed. It is for Maximum performance mode.
5. Set the ApplyLagThreshold to log warning when threshold exceeds
6. Set the TransportLag to log warning when threshold exceeds
7. Place one member of the online redo log group in FRA
8. Put the Oracle base in /u01/app/oracle, size 50G (binary 10G, logs 10G, buffer of future upgrade 20G) 
   FRA under /u02/app/oracle/fast_recovery_area, size 100G
   and datafiles under /u03/app/oracle/oradata, size 50G (redo 3G[500M * 2 * 3], SLR 2G[500M * 4],  undo 4G, temp 4G, system 2G, sysaux 2G, data 20G) 
9. Assign 14G ram, so swap space require about 14G
10. set number of processes to 2000 or higher value
11. Check v$datafile status as a routine healthcheck. Should have no offline or SYSOFF status
12. log_buffer size to 256M
13. Make sure shmall is larger than the total SGA size
14. The FSFO machine should be in the same ESXi as the Primary so as to isolate the network or hardware issue in the Standby ESXi.

alter system set log_buffer=8M scope=spfile;
alter system set sga_max_size=1G scope=spfile;
alter system set sga_target=1G scope=spfile;
alter system set memory_target=0 scope=both;
alter system set processes=1000 scope=spfile;

alter system set nls_language='AMERICAN' scope=spfile;
alter system set nls_territory='AMERICA'scope=spfile;



==========================================================================================================================
===  Setup Fedora 23 server 
==========================================================================================================================
1. Download fedora 23 ISO from fedora website
2. Use oracle virtualbox to create the vm
3. Run below command to install x-window
   yum install gnome*
   yum install kde*  
   yum install X*  
   yum install xorg* 
4. Run "startx" in command line to start x-window
5. Run below command if it does start x-window on boot. At this point, the x-window should be working. xclock can be launched.
   rm -f /etc/systemd/system/default.target
   ln -s /lib/systemd/system/graphical.target /etc/systemd/system/default.target
6. Shutdown the vm, add two more disks each at least 10GB. Issue below command to make the disks available
   "fdisk /dev/sdb" to create a partition
   mkfs -t ext3 /dev/sdb1
   mkdir /u01
   mount -t ext3 /dev/sdb1 /u01
   "fdisk /dev/sdc" to create a partition
   mkfs -t ext3 /dev/sdc1
   mkdir /u02
   mount -t ext3 /dev/sdc1 /u02

Reference
http://unix.stackexchange.com/questions/224477/how-to-boot-gui-on-a-fedora-21-server-through-the-command-line
https://docs.fedoraproject.org/en-US/Fedora/20/html/Installation_Guide/sn-switching-to-gui-login.html

Note: It is better to use ext4 rather than ext3.

==========================================================================================================================
===  Setup Oracle 12.1.0.2 Active Data Guard in Fedora 23 with Virtual Box
==========================================================================================================================
1. Install oracle 12.1.0.2   
		Base on https://oracle-base.com/articles/12c/oracle-db-12cr1-installation-on-fedora-23 to preprae the pre-requisites
		./runInstaller to install
		installation option -> install software only
		create inventory -> select "oinstall" group
		During installation, as prompted login as root to run /u01/app/orainventory/orainstRoot.sh, /u01/app/oracle/product/12.1.0.2/db_1/root.sh
		./netca to setup a listener
		./dbca to create a database
		choose "advanced" mode in Creation Mode
		global database name = cdb1.lands
		sid = cdb1
		pdb = gisp
		sys/system/PDBADMIN all has "oracle" as passwd.
		Store both data and archive logs in /u02. In production, use different filesystems.
		Choose "Use Unicode (al32utf8)" and "al16utf16" ad national character set.
		In "Character Sets" tabl, select "Traditional Chinese" as default language and "Hong Kong" as default territory.
		In Creation Options, choose "Customize Storage Locations" to add more redo logs
2. At this point, cdb1 is up and running. Now we need to clone dg1 to make dg2 using virtualbox. After cloning, then delete the cdb1 in dg2.
3. Change the cloned vm hostname to dg2. Modify the /etc/hosts,/etc/hostname,oracle related .ora files. Regenerate new mac address for the cloned machine so new IP will be assigned.
4. Make sure ping/tnsping are working between dg1 and dg2 before next steps. netmgr to add database service in both dg1 and dg2. Set local_listener to null in dg1.
5. Follow the 1-setup.sh (steps 1-10) to create the standby database.


==========================================================================================================================
===  Setup data guard broker 
==========================================================================================================================
To use Fast-start failover you must install DGMGRL and run the observer software. 
On a separate machine from the primary and standby systems. 
To install DGMGRL on the observer computer, use one of the methods described in the following list:

Install the complete Oracle Client Administrator by choosing the Administrator option from Oracle Universal Installer.
Install the full Oracle Database Enterprise Edition or Personal Edition software kit

After setup of DGMGRL, the log_archive_dest_2 in standby is null. Check whether this is normal.

Should not make changes to the redo transport services initialization parameters through SQL statements. 
Doing so will cause an inconsistency between the database and the broker.

Maximum Availability Mode
SYNC/AFFIRM or SYNC/NOAFFIRM (FastSync) in log_archive_dest_2
Using SYNC/AFFIRM, had written to disk. No data loss.
Using SYNC/NOAFFIRM, acknowledgement received on the standby, not that it has been written to disk. Can be data loss.

Maximum Performance Mode
Allowing transactions to commit as soon as all redo data generated by those transactions has been written to the online log. 
Redo data is also written to one or more standby databases, but this is done asynchronously with respect to transaction commitment, 
so primary database performance is unaffected by the time required to transmit redo data and receive acknowledgment from a standby database.

If you are more concerned about the performance of the primary database than a minimal loss of data, 
consider enabling fast-start failover when the configuration protection mode is set to maximum performance. 
In this mode you will need to consider how much data loss is acceptable in terms of seconds and set 
the FastStartFailoverLagLimit configuration property accordingly. This property specifies the amount of data, in seconds, 
that the target standby database can lag behind the primary database in terms of redo applied. If the standby database's redo applied point 
is within that many seconds of the primary database's redo generation point, a fast-start failover will be allowed. 
The FastStartFailoverLagLimit configuration property is only used by the broker when enabling fast-start failover for 
configurations operating in maximum performance mode. The default value is 30 seconds and the lowest possible value is 10 seconds.


Maximum Protection Mode
Unlike maximum availability, which allows the primary to continue processing if it is unable to receive acknowledgement from a standby database, 
maximum protection shuts the primary database down rather than allowing it to continue processing transactions that are unprotected.



A restart of the primary database is not required when changing the protection mode from:
maximum performance to maximum availability or maximum availability to maximum protection



-- To disable fast start failover in DGMGRL
disable fast_start failover [force]

-- To disable DG configuration. Cannot disable if fast start failover is enabled. Disable configuration does not affect redo transport and apply
disable configuration


Fast-start failover can be enabled for either maximum availability mode or maximum performance mode. 
If you cannot tolerate any loss of data, then ensure that the configuration protection mode is set to maximum availability. 
To do this, the LogXptMode database property for both the primary and target standby database must be set to SYNC.

-- Change from max performance mode to max availability mode
disable fast_start failover
edit database cdb1 set property 'LogXptMode'='SYNC';
edit database cdb2 set property 'LogXptMode'='SYNC';
EDIT CONFIGURATION SET PROTECTION MODE AS MaxAvailability;
enable fast_start failover


-- Change from max availability mode to max performance mode 
disable fast_start failover
edit database cdb1 set property 'LogXptMode'='ASYNC';
edit database cdb2 set property 'LogXptMode'='ASYNC';
EDIT CONFIGURATION SET PROTECTION MODE AS MaxPerformance;
enable fast_start failover

-- fast start failover parameters. It will failover if losing connection with the primary for 45s.Default is 30s.
EDIT CONFIGURATION SET PROPERTY FastStartFailoverThreshold = 600;
EDIT CONFIGURATION SET PROPERTY FastStartFailoverAutoReinstate = FALSE;

-- Shutdown the primary
If the FastStartFailoverPmyShutdown configuration property is set to TRUE, the primary database will shut down after 
FastStartFailoverThreshold seconds has elapsed if redo generation has been stalled and the primary database is unable to 
reestablish connectivity with either the observer or target standby database.

-- Show fast start failover configuration
SHOW FAST_START FAILOVER;

-- Check whether observer has been started. It shows "Warning: ORA-16819: fast-start failover observer not started" if not started
show fast_start failover

-- Stop Redo Apply on a physical standby. Redo data is still being received
EDIT DATABASE cdb2 SET STATE='APPLY-OFF';

-- Stop the transmittal of redo data to the standby database
EDIT DATABASE cdb1 SET STATE=TRANSPORT-OFF;

-- Disable configuration or database. Need to disable fast start failover first
disable configuration
disable database


-- Validate database
validate database cdb1
validate database cdb2

-- Switchover to cdb2
switchover to cdb2;

-- Reset database property to default
EDIT DATABASE cdb1 RESET PROPERTY LogXptMode;

-- Reset configuration property to default
EDIT CONFIGURATION RESET PROPERTY TraceLevel;

-- Manage delay apply, set below property
DelayMins

-- Set database configurable property to generate a health check warning when a standby database lags behind the data in the primary database.
ApplyLagThreshold 

-- LogXptStatus lists all log transport errors detected on all instances of the primary database
SHOW DATABASE cdb1 'LogXptStatus';
-- InconsistentProperties lists all properties that have inconsistent values between the broker configuration file and the database settings
SHOW DATABASE cdb1 'InconsistentLogXptProps';
-- InconsistentLogXptProps lists all redo transport-related properties of standby databases that have inconsistent values between the broker configuration file and the redo transport settings.
SHOW DATABASE cdb1 'InconsistentProperties';

-- show instance configuration
show instance verbose cdb1




==========================================================================================================================
===  Create oracle recovery catalog to support DG backup
==========================================================================================================================
The recovery catalog should be setup in separate machine other than the DG environment.

In my test case, i create it in below env.
vbgeneric 192.168.56.103
service_name orcl12c
pdb ORCL

-- Connect to the PDB ORCL as sys to create the rman user, rman tablespace and grant priv
create tablespace rman_data datafile '/u01/app/oracle/oradata/orcl12c/orcl/rman_data01.dbf' size 100M 
autoextend on next 100M maxsize 2G;

create user rmancat identified by rmancat
default tablespace rman_data
quota unlimited on rman_data;

grant connect, recovery_catalog_owner to rmancat;



-- connect as rmancat to the catalog and create the catalog
rman catalog rmancat@orcl
create catalog;

-- Connect to the PDB ORCL as sys to grant priv as required in 12.1.0.2
spool /tmp/out.txt
@?/rdbms/admin/dbmsrmansys.sql
@?/rdbms/admin/dbmsrmanvpc.sql -all


-- Check table catalog tables have been created.
SELECT TABLE_NAME FROM USER_TABLES;

-- Check current catalog version
SQL> select * from rcver;

VERSION
------------
12.01.00.02

Now, the catalog database has been created. The next step is to register the DG databases to it.

-- Now, cdb2 is the primary, we login to dg2 to register the primary database
rman TARGET / CATALOG rmancat/rmancat@orcl;
REGISTER DATABASE;
-- Run below command to verify registration ok. It should display CDB2 tablespaces/datafiles
report schema;


-- Now, let's register the standby database, it is easy, just login to dg1(now standby) and connect as target.
rman target / catalog rmancat/rmancat@orcl
-- Run below command to verify registration ok. It should display CDB1 tablespaces/datafiles
report schema;

-- configure the connect identifiers for all datbases in the primary database connected to catalog
configure db_unique_name cdb2 connect identifier 'cdb2';
configure db_unique_name cdb1 connect identifier 'cdb1';
list db_unique_name of database;


Reference
Database Backup and Recovery User's Guide -> Managing a Recovery Catalog
http://docs.oracle.com/database/121/BRADV/rcmcatdb.htm#BRADV89647
http://docs.oracle.com/database/121/BRADV/rcmcatdb.htm#BRADV89654
http://www.dummies.com/how-to/content/basics-of-the-oracle-12c-recovery-manager-rman-cat.html

==========================================================================================================================
===  Test switchover
==========================================================================================================================
In a DG env with different types of standbys(physical standby, logical standby, snapshot standby), 
the choice to failover to which standby is physical standby(with least redo apply). Failover to 
logical standby requires re-create other standbys afterwards. Failover to snapshot standby takes most time 
becasue it will convert the snapshot standby to physical standby first and then apply the accumulated redo logs.

1. If standby in real-time query mode, bring it to mount mode first for faster redo apply 
2. Switchover should be arranged at time with smallest redo lag - less busy hour
3. The broker will verify the primary in transport-on state and standby in apply-on state before switching
4. The new primary will be re-started in the switching. The old primary won't.
5. If in maximum protection mode, not allow switchover to a logical standby database.

Perform switchover in dgmgrl. Assume current primary is cdb1.
validate database cdb1
validate database cdb2
switchover to cdb2

Let's test a switchover from cdb2 to cdb1. Also test what will happen during the switchover when 
1. User connected but being idle.
2. User connected and SQL is being executed.

After the switchover has started, both the idle and busy sessions are terminated. The currently executed SQL statement is terminated. So, we know that in switchover, Oracle uses "shutdown abort" to shutdown the database.


==========================================================================================================================
===  Test manual failover
==========================================================================================================================
About manual failover
1. If fast_start failover is enabled, you can still perform manual failover. You need to shutdown the primary first.
2. There are complete and immediate failovers. The default is complete.
3. Complete failover automatically recovers the maximum amount of redo data for the current protection mode
4. If the primary database can be mounted, it may be possible to flush any unsent redo data from the primary database to the target standby database using the ALTER SYSTEM FLUSH REDO SQL statement. If this operation is successful, a zero data loss failover may be possible even if the primary database is not in a zero data loss protection mode.
5. An immediate failover is the fastest. However, no additional data is applied on the standby database once you invoke the failover. All other databases in the configuration are disabled and must be reinstated or re-created afterward.
6. If complete failover failed, you may invoke immediate failover.
7. The broker allows an immediate failover to proceed even if there are errors present on the standby database.
8. The old primary databases requires reinstate or re-create after failover.
9. If at maximum protection mode, it is reset to maximum performance after failover.

Caution
1. Always try to perform a complete failover first unless redo apply has stopped at the failover target due to an ORA-752 or ORA-600 [3020] error. If one of these errors has occurred, follow the guidelines in "Resolving ORA-752 or ORA-600 [3020] During Standby Recovery" in My Oracle Support Note 1265884.1 before proceeding.
2. An immediate failover should only be performed when a complete failover is unsuccessful or in the case just noted above. A complete failover can occur without any data loss, depending on the destination attributes of redo transport services, but an immediate failover usually results in some data loss.

Manual Failover Using DGMGRL:
1. Ensure the primary database is shut down before manual failover.
2. DGMGRL> FAILOVER TO <database-name>;
3. Specify the optional IMMEDIATE clause to perform an immediate failover if any of the the following conditions are true:
   . An ORA-752 error has occurred at the standby database
   . An ORA-600 [3020] error has occurred at the standby database and Oracle support has determined that it was caused by a lost write at the primary database
   . A complete failover is not possible
4. Reinstate or re-create the original primary database to act as a standby database in the new configuration.
Note: Still work even primary not shutdown beforehand.

How to reinstate a database 
1. Mount the old primary
startup mount;
2. Connect to new primary and run below where <db_unique_name> is for the old primary
REINSTATE DATABASE <db_unique_name>;

Note: 
If just use "startup", oracle is intelligent enough to detect that and it will only be mounted.
SQL> startup
Total System Global Area 7247757312 bytes
Fixed Size                  2941096 bytes
Variable Size            1862274904 bytes
Database Buffers         5100273664 bytes
Redo Buffers              282267648 bytes
Database mounted.
ORA-16649: possible failover to another database prevents this database from being opened

Caution:
1. Do not attempt to reinstate the old primary database if an ORA-752 or ORA-600 [3020] error has occurred at the failover target, because doing so may lead to data loss. Instead, the old primary database must be re-created as a standby from a backup of the new primary using the procedure described in Section 5.4.3.2.


Test extreme manual failover when it is outsync
1. Shutdown standby cdb2 first.
2. Perform huge dml in primary cdb1 to create redo lag.
3. stop observer.
4. startup cdb2 in mount mode.
5. start observer.
6. DGMGRL> show database cdb1
Database Status:
DGM-17016: failed to retrieve status for database "cdb1"
ORA-12543: TNS:destination host unreachable
ORA-16625: cannot reach database "cdb1"
7. DGMGRL> show database cdb2
  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: 0 Byte/s
  Database Warning(s):
    ORA-16858: last communication time from redo source could not be determined
    ORA-16817: unsynchronized fast-start failover configuration
8. Although fsfo is enabled, it is not started because FSFO_STATUS is "UNSYNCHRONIZED". It is normal.
9. Let's perform complete failover to see if it is possible first.
10. DGMGRL> failover to cdb2
Performing failover NOW, please wait...
Error: ORA-16817: unsynchronized fast-start failover configuration
Failed.
Unable to failover
11. Let's perform immediate failover then
DGMGRL> failover to cdb2 immediate
Performing failover NOW, please wait...
Error: ORA-16654: fast-start failover is enabled
Failed.
Unable to failover
12. then disable fsfo and try again. need to use "force" option because primary is down.
DGMGRL> disable fast_start failover force
Disabled.
DGMGRL> failover to cdb2
Performing failover NOW, please wait...
Failover succeeded, new primary is "cdb2"
13. Check status.
DGMGRL> show configuration
  cdb2 - Primary database
    Warning: ORA-16629: database reports a different protection level from the protection mode

    cdb1 - Physical standby database (disabled)
      ORA-16661: the standby database needs to be reinstated

Fast-Start Failover: DISABLED
14. As it said cdb1 needs to be reinstated. So start it up in mount mode and reinstate it.
DGMGRL> reinstate database cdb1
Reinstating database "cdb1", please wait...
Reinstatement of database "cdb1" succeeded
15. Enable fsfo
DGMGRL> enable fast_start failover
Enabled.
16. Although this manaul failver succeeded, there is data loss. The hugh dml in step 2 was lost. fsfo must be disabled first before an unsync DG configuration can perform manual failover.


	
Reference
Resolving ORA-752 or ORA-600 [3020] During Standby Recovery" in My Oracle Support Note 1265884.1

==========================================================================================================================
===  Test fast-start failover
==========================================================================================================================
1. Only for maximum availability mode or maximum performance mode
2. Maximum availability mode provides an automatic failover environment guaranteed to lose no data. ???
3. Maximum performance mode guaranteed to lose no more than the amount of data (in seconds) specified by the FastStartFailoverLagLimit configuration property.
4. for maximum availability, all missing redo data must be received before automatic failover can be restored.
5. for maximum performance, FastStartFailoverLagLimit must be satisfied before automatic failover can be restored.
6. If both the standby and observer fail to communicate with primary, fsfo will start. Put observer in different network if possible to prevent fsfo due to netowrk issue.
7. primary and target standby databases must be running to enable fsfo
8. Fast-start failover cannot occur if
   . fsfo not enabled
   . observer can't connect to target
   . observer and target are inconsistent in broker config
   . observer not running
   . in maximum availability, but standby db not synchronized at the time primary failed.
   . in maximum performance and lag behind faststartfailoverlaglimit.
   . target has contact with primary.
   . v$database.fs_failover_status shows a reason.
   . a manual failover already in progress.
   . primary shutdown without abort option.
9. Can't do following when fsfo is enabled.
   . change protection mode,logxptmode, faststartfailovertarget
   . disable or delete broker config or standby db
   . perform manual failover unless primay is shut down
10. Run DISABLE FAST_START FAILOVER [FORCE] on the target to disable fsfo or kill the observer process

-- Test fsfo by killing the ps_smon process in primary.
1. Kill the smon process in primary.
2. FSFO started and when it is done. Check configuration...
3. DGMGRL> show configuration
  Members:
  cdb1 - Primary database
    Warning: ORA-16817: unsynchronized fast-start failover configuration

    cdb2 - (*) Physical standby database (disabled)
      ORA-16661: the standby database needs to be reinstated

Fast-Start Failover: ENABLED
4. Reinstate cdb2 as advised. Start cdb2 up as mounted and then run "reinstate database cdb2"
SQL> startup mount;
DGMGRL> reinstate database cdb2
Reinstating database "cdb2", please wait...
Reinstatement of database "cdb2" succeeded


==========================================================================================================================
===  Test PSU patching
==========================================================================================================================
We will followt the "Oracle patch assurance - data guard standby-first patch apply (doc id 1265700.1)
to apply the patch. According to this doc, it has following prerequisites
1. database patch releases that are a max of one year apart based on patch release date.
2. the max supported duration to have different database home software between primary and standby is 31 days.

Release dates
12.1.0.2 linux x86-64 on 22-jul-2014
CPUJUL2015(Patch 20831110, PSU 12.1.0.2.4) on 14-jul-2015
CPUAPR2016(Patch 22291127, PSU 12.1.0.2.160419) on 19-april-2016
CPUJUL2016 on 

So, before SC/EKEO production we should patch it with CPUJUL2016.
For this case, let patch 12.1.0.2 with CPUJUL2015 first.

Let's apply 20831110 first. It needs opatch at least 12.1.0.1.4, so need to apply new opatch, say OPatch patch of version 12.1.0.1.12 for Oracle.

We follow the 12102_CPUJUL2015_Linux(x64)_DG.txt for the detailed steps.

As recommended by Oracle, it's better to convert the standby to snapshot standby and then apply the SQL and then to test the application. Once it's fine, revert the snapshot standby to physical standby and continue the remaining steps. So let's do it.

Let's apply the patch to standby first. So we follow "Apply patch to standby server(dg2) first" procedure
We don't disable the redo apply as it is not mentioned in 1265700.1.

While cdb2 is being patched with the binary, we do a insert into cdb1 to simulate txn in primary.
SQL> insert into a values(999999);
1 row created.

OPatch succeeded.
Log file location: /u01/app/oracle/product/12.1.0.2/db_1/cfgtoollogs/opatch/opatch2016-05-31_15-00-49PM_1.log

So, right now the cdb2 is startup in mount and the DG env is normal. Now, let's convert the physical standby to snapshot standby to perform the CPU testing.

DGMGRL> convert database cdb2 to snapshot standby;
Error: ORA-16668: operation cannot be performed on the fast-start failover target standby database

Let's disable fsfo then and continue...
DGMGRL> disable fast_start failover
Disabled.
DGMGRL> convert database cdb2 to snapshot standby;
Database "cdb2" converted successfully

Now, cdb2 is a snapshot standby. Let's test SQL installation steps.

[oracle@dg2 OPatch]$ ./datapatch -verbose
Log file for this invocation: /u01/app/oracle/cfgtoollogs/sqlpatch/sqlpatch_9324_2016_05_31_15_29_54/sqlpatch_invocation.log
Note:  Datapatch will only apply or rollback SQL fixes for PDBs
       that are in an open state, no patches will be applied to closed PDBs.
       Please refer to Note: Datapatch: Database 12c Post Patch SQL Automation
       (Doc ID 1585822.1)

	   Bootstrapping registry and package to current versions...done
Determining current state...      <--------- Stay in this step for a long time, around 20 minutes...
done

Current state of SQL patches:
Bundle series PSU:
  ID 4 in the binary registry and not installed in any PDB

Adding patches to installation queue and performing prereq checks...
Installation queue:
  For the following PDBs: CDB$ROOT PDB$SEED GISP
    Nothing to roll back
    The following patches will be applied:
      20831110 (Database Patch Set Update : 12.1.0.2.4 (20831110))

Installing patches...
Patch installation complete.  Total patches installed: 3

So, the SQL installation completed with no error. Do some connection tests and dml test. It's fine and let's convert the snaphot standby back to physical standby and then continue the patching in the primary.

DGMGRL> connect sys/oracle@cdb2
DGMGRL> CONVERT DATABASE cdb2 to PHYSICAL STANDBY;
Database "cdb2" converted successfully

Now, we continue the patching steps in 12102_CPUJUL2015_Linux(x64)_DG.txt to perform a switchover. If no unapplied redo, the switchover process is really fast, about 5 minutes.
DGMGRL> connect sys/oracle@cdb1
DGMGRL> switchover to cdb2
Switchover succeeded, new primary is "cdb2"

DGMGRL> show configuration
  cdb2 - Primary database
    cdb1 - Physical standby database
Fast-Start Failover: DISABLED

Let's do a re-boot of both machines to see whether it can survive under different binaries version. It can survive.
Now, next step is to apply binary patch to the old primary.
 
OPatch succeeded.
Log file location: /u01/app/oracle/product/12.1.0.2/db_1/cfgtoollogs/opatch/opatch2016-05-31_17-43-57PM_1.log

How, the DG config is normal.
DGMGRL> show configuration
  Members:
  cdb2 - Primary database
    cdb1 - Physical standby database

Now, the next step is to apply the SQL installation at the new primary cdb2. Now it is fine.

Let's switch to cdb1 to check that the SQL installation(the registry) is also updated. It is fine.

Note: There is no need to "upgrade catalog" after PSU. But it requires "upgrade catalog" after patchset upgrade say from 12.1.0.1 to 12.2.0.2 because the catalog version is on PS, not PSU.
 

==========================================================================================================================
===  Test create geodatabase
==========================================================================================================================
Let's setup geodatabase for the DG env(dg1 and dg2). Ideally, it should be setup before using rman to duplicate the standby.

-- login as sys in primary gisp pdb, create tablespace and user
CREATE TABLESPACE SDE
DATAFILE '/u02/oradata/cdb1/gisp/SDE01.DBF' SIZE 419430400 REUSE
EXTENT MANAGEMENT LOCAL
AUTOALLOCATE
ONLINE;

create user SDE
identified by abc123
default tablespace SDE
temporary tablespace TEMP
account unlock ;

grant CONNECT to sde ;
grant RESOURCE to sde ;

- In gdat8141, use arcpy to create the geodatabase. gdat8141 has ArcGIS desktop 10.2.2 installed.
D:\download\setup_geodatabase>geodbdg1.py
Installing St_Geometry ....
Successfully installed St_Geometry.

-- login as sys in primary gisp pdb, create SCAPP and EKEAPP schemas
CREATE TABLESPACE ekeapp
DATAFILE '/u02/oradata/cdb1/gisp/ekeapp01.DBF' SIZE 536870912 REUSE
EXTENT MANAGEMENT LOCAL
UNIFORM SIZE 524288
ONLINE;

create user ekeapp
identified by ekeapp123
default tablespace ekeapp
temporary tablespace TEMP
account unlock ;

grant CONNECT to ekeapp ;
grant RESOURCE to ekeapp ;
grant CREATE VIEW to ekeapp ;
ALTER USER ekeapp quota unlimited on ekeapp;
grant SELECT_CATALOG_ROLE to ekeapp;


CREATE TABLESPACE scapp
DATAFILE '/u02/oradata/cdb1/gisp/scapp01.DBF' SIZE 536870912 REUSE
EXTENT MANAGEMENT LOCAL
UNIFORM SIZE 524288
ONLINE;

create user scapp
identified by scapp123
default tablespace scapp
temporary tablespace TEMP
account unlock ;

grant CONNECT to scapp ;
grant RESOURCE to scapp ;
grant CREATE VIEW to scapp ;
ALTER USER scapp quota unlimited on scapp;
grant SELECT_CATALOG_ROLE to scapp;

-- Ask sky and john to import scapp and ekeapp spatial data into it.
-- The spatial data imported in primary can be viewed in ArcDesktop. It's also found in standby. All object names are aligned.
-- Now perform a switchover to standby and see whether the spatial data can be viewed in ArcDesktop. Yes, it's.

Conclusion: Geodatabase creation succeeded. Spatial data worked fine in DG environment. 

About tablespace creation in DG environment...
The SDE,SCAPP,EKEAPP datafiles are added in the standby as follows, not aligned with Primary path???
Datafile #10: '/u02/oradata/cdb2/CDB2/30E9657629F07312E0536538A8C08F04/datafile/o1_mf_sde_cob9l6lg_.dbf'
Datafile #11: '/u02/oradata/cdb2/CDB2/30E9657629F07312E0536538A8C08F04/datafile/o1_mf_ekeapp_cobgdyy3_.dbf'
Datafile #12: '/u02/oradata/cdb2/CDB2/30E9657629F07312E0536538A8C08F04/datafile/o1_mf_scapp_cobggr52_.dbf'

I guess it is using oracle managed-file because the db_create_file_dest parameter was set. Let's reset it to null and test again by creating a new dump tablespace.

-- login the primary gisp pdb as sys
CREATE TABLESPACE test
DATAFILE '/u02/oradata/cdb1/gisp/test01.DBF' SIZE 50M REUSE
EXTENT MANAGEMENT LOCAL
UNIFORM SIZE 524288
ONLINE;

-- Yeah, it is created correctly! From cdb2 alertlog we see..
ALTER SYSTEM SET db_create_file_dest='' SCOPE=BOTH;
Tue Jun 07 10:11:20 2016
Recovery created file /u02/oradata/cdb2/gisp/test01.DBF
Datafile 13 added to flashback set
Successfully added datafile 13 to media recovery
Datafile #13: '/u02/oradata/cdb2/gisp/test01.DBF'

 
==========================================================================================================================
===  Problems hit during setup or afterward
==========================================================================================================================

Problem
TNSPING failed from dg1 to dg2 and vice versa

Solution
The firewalld was found started and running even it has been disabled and stopped in the pre-requisites
systemctl stop firewalld
systemctl disable firewalld

Temporary solution is to stop the firewalld manuall.
systemctl stop firewalld

Need to figure out why the disable does not work.
The rolekit starts up the firewall service. So need to disable the rolekit service also
systemctl stop rolekit
systemctl disable rolekit
https://bugzilla.redhat.com/show_bug.cgi?id=1288758

To list all active services
systemctl list-units --type=service


--------------------------------------------------------------------------------------------------------------------------
Problem
Even /etc/oratab was set 'Y', the oracle database and listenr not started up on reboot

Solution

Refer to "Automating Database Startup and Shutdown on Linux" 
https://oracle-base.com/articles/linux/automating-database-startup-and-shutdown-on-linux



--------------------------------------------------------------------------------------------------------------------------

Problem
Failed to create the standby using the duplicate command in rman.txt

run {
duplicate target database for standby from active database
spfile
parameter_value_convert 'cdb1','cdb2'
set db_unique_name='cdb2'
set db_create_file_dest='/u02/oradata/cdb2'
set db_recovery_file_dest='/u02/oradata/cdb2'
set db_file_name_convert='/cdb1/','/cdb2/'
set log_file_name_convert='/cdb1/','/cdb2/'
set log_archive_max_processes='5'
set fal_client='cdb2'
set fal_server='cdb1'
set standby_file_management='AUTO'
set log_archive_config='dg_config=(cdb1,cdb2)'
set log_archive_dest_2='service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'
;
}

Solution
1. When using active duplicate, the standby server requires static listener configuration in a "listener.ora" file.
   Need to add database service in the netmgr for both dg1 and dg2. Restart the dg1 and dg2 listeners afterward.
2. Make sure local_listener parameter is set to null in dg1. otherwise, it failed with "RMAN-04014: startup failed: ORA-00119: invalid specification for system parameter LOCAL_LISTENER"

--------------------------------------------------------------------------------------------------------------------------
Problem
Switchover failed because of ORA-01017

DGMGRL> switchover to CDB2
Performing switchover NOW, please wait...
Operation requires a connection to instance "cdb2" on database "cdb2"
Connecting to instance "cdb2"...
ORA-01017: ?????/????; ????

Warning: You are no longer connected to ORACLE.

        connect to instance "cdb2" of database "cdb2"

DGMGRL>

Solution
Modify the listener.ora as follows according to Chapter 2 of the installation in both dg1 and dg2.

In dg1 listener.ora
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = cdb1.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0.2/db_1)
      (SID_NAME = cdb1)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = cdb1_DGMGRL.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0.2/db_1)
      (SID_NAME = cdb1)
    )
  )

In dg2 listener.ora
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = cdb2.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0.2/db_1)
      (SID_NAME = cdb2)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = cdb2_DGMGRL.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0.2/db_1)
      (SID_NAME = cdb2)
    )
  )

Then restart the listners in both dg1 and dg2.
Then stop and start the Observer again.
Then run the swtichover again

DGMGRL> switchover to cdb2
Performing switchover NOW, please wait...
Operation requires a connection to instance "cdb2" on database "cdb2"
Connecting to instance "cdb2"...
Connected as SYSDBA.
New primary database "cdb2" is opening...
Operation requires start up of instance "cdb1" on database "cdb1"
Starting instance "cdb1"...
ORACLE instance started.
Database mounted.
Database opened.
Switchover succeeded, new primary is "cdb2"

--------------------------------------------------------------------------------------------------------------------------
Problem
The pdbseed temp01.dbf not verified due to error ORA-01122 in Primary alertlog

Errors in file /u01/app/oracle/diag/rdbms/cdb2/cdb2/trace/cdb2_dbw0_7991.trc:
ORA-01186: �ɮ� 202 ���q�L���Ҵ���
ORA-01122: ��Ʈw�� 202 ���q�L�����ˬd
ORA-01110: ����� 202: '/u02/oradata/cdb2/pdbseed/temp01.dbf'
ORA-01203: ���ɮת����������T - �إ� SCN ���~
File 202 not verified due to error ORA-01122
Tue May 31 15:30:03 2016
Cannot re-create tempfile /u02/oradata/cdb2/pdbseed/temp01.dbf, the same name file exists


As the alertlog said it failed to re-create it because already exists. Then we just delete it and let it re-create on re-boot.
shutdown the primary
mv /u02/oradata/cdb2/pdbseed/temp01.dbf /u02/oradata/cdb2/pdbseed/temp01.dbf.ori
restart oracle
it works.


--------------------------------------------------------------------------------------------------------------------------
Problem
datapatch on primary failed.catconInit failed, exiting.validate_con_names: PDB$SEED is not open.

[oracle@dg2 OPatch]$ ./datapatch -verbose

-- output
catconInit failed, exiting
-- In /u01/app/oracle/cfgtoollogs/sqlpatch/sqlpatch_29027_2016_06_01_15_46_02/sqlpatch_invocation.log 
validate_con_names: PDB$SEED is not open
catconInit: Unexpected error returned by validate_con_names for inclusive Container list

-- try to open the pdbseed...
alter session set "_oracle_script"=TRUE;
SQL> ALTER PLUGGABLE DATABASE pdb$seed open read write;
ALTER PLUGGABLE DATABASE pdb$seed open read write
*
ERROR at line 1:
ORA-01147: SYSTEM tablespace file 2 is offline

-- In alertlog, it has...
ALTER PLUGGABLE DATABASE pdb$seed open read write
Wed Jun 01 15:47:05 2016
Pdb PDB$SEED hit error 1147 during open read write (1) and will be closed.
Wed Jun 01 15:47:05 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb2/cdb2/trace/cdb2_ora_29105.trc:
ORA-01147: SYSTEM tablespace file 2 is offline

-- As we can see from the v$datafile, File# 2 and 4 are of abnormal status.
set lines 200 pages 80
column name format a80
select file#,name,status from v$datafile;

     FILE# NAME                                                                             STATUS
---------- -------------------------------------------------------------------------------- -------
         1 /u02/oradata/cdb2/system01.dbf                                                   SYSTEM
         2 /u02/oradata/cdb2/pdbseed/system01.dbf                                           SYSOFF
         3 /u02/oradata/cdb2/sysaux01.dbf                                                   ONLINE
         4 /u02/oradata/cdb2/pdbseed/sysaux01.dbf                                           OFFLINE
         5 /u02/oradata/cdb2/undotbs01.dbf                                                  ONLINE
         6 /u02/oradata/cdb2/users01.dbf                                                    ONLINE
         7 /u02/oradata/cdb2/gisp/system01.dbf                                              SYSTEM
         8 /u02/oradata/cdb2/gisp/sysaux01.dbf                                              ONLINE
         9 /u02/oradata/cdb2/gisp/gisp_users01.dbf                                          ONLINE

-- Let's use the standby pdbseed backup to recover the primary pdbseed. Let's backup the standby pdbseed first
backup database "pdb$seed" format '/u02/fast_recovery_area/adhocbkup/cdb1_seed_%U.bkp';

-- transfer the backup to primary
scp -p /u02/fast_recovery_area/adhocbkup/cdb1_seed_52r74jj8_1_1.bkp oracle@dg2:/u02/fast_recovery_area/adhocbkup

-- Now catalog the backup into primary database
rman target / catalog rmancat/rmancat@orcl
catalog backuppiece '/u02/fast_recovery_area/adhocbkup/cdb1_seed_52r74jj8_1_1.bkp';

-- Now take the two datafiles 2,4 offline if they are not
alter session set "_oracle_script"=true;
alter pluggable database "pdb$seed" close;

-- Take a look at the backup of datafile 2 and 4 in the catalog first.
list backup of datafile 2;
        Piece Name: /u02/fast_recovery_area/CDB2/30E7316C6C3747CCE0536538A8C0816E/backupset/2016_06_01/o1_mf_nnnd0_WEEKLY_FULL_cnxj8hz0_.bkp
        BP Key: 9889   Status: AVAILABLE  Compressed: YES  Tag: WEEKLY_FULL

        Piece Name: /u02/fast_recovery_area/adhocbkup/cdb1_seed_52r74jj8_1_1.bkp
        BP Key: 10805   Status: AVAILABLE  Compressed: NO  Tag: TAG20160602T110720

-- Let's run preview to see what piece it use
restore datafile 2 preview;
Well, it uses the first one which is not what we want. Let's use the FROM TAG to force it using another one
restore datafile 2 from TAG 'TAG20160602T110720' preview;
it is fine. So let's do it now.
restore datafile 2 from TAG 'TAG20160602T110720';
restore datafile 4 from TAG 'TAG20160602T110720';

-- Let's open it now. But still failed...
alter session set "_oracle_script"=true;
SQL> alter pluggable database "pdb$seed" open read only;
ERROR at line 1:
ORA-01147: SYSTEM tablespace file 2 is offline

-- Let's do a switchover and see whether we have any luck...
DGMGRL> show database cdb1
  Database Error(s):
    ORA-16783: cannot resolve gap for database cdb2
DGMGRL> show database cdb2
  Database Error(s):
    ORA-16700: the standby database has diverged from the primary database
    ORA-16766: Redo Apply is stopped

-- In standby(cdb2) alertlog	
Managed Standby Recovery starting Real Time Apply
Warning: Recovery target destination is in a sibling branch
of the controlfile checkpoint. Recovery will only recover
changes to datafiles.
MRP0: Background Media Recovery terminated with error 19912
Thu Jun 02 15:57:21 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb2/cdb2/trace/cdb2_pr00_13851.trc:
ORA-19912: �L�k�_�즨�ؼЫ��� 5
Managed Standby Recovery not using Real Time Apply

-- Maybe we did a restore/recover in cdb2 before switchover and it didn't succeeded. So after switchover, it got stucked.

-- Let's shutdown cdb2 and mount it and then do a reinstate to see how it goes...
DGMGRL> reinstate database cdb2
Reinstating database "cdb2", please wait...
Error: ORA-16653: failed to reinstate database

DGMGRL> validate database cdb1
  Database Role:    Primary database
  Ready for Switchover:  Yes

DGMGRL> validate database cdb2
  Database Role:     Physical standby database
  Primary Database:  cdb1

  Ready for Switchover:  No
  Ready for Failover:    Yes (Primary Running)

DGMGRL> failover to cdb2 immediate
Performing failover NOW, please wait...
Error: ORA-16754: failed to activate physical standby database

SQL Execution error=604, sql=[ALTER DATABASE ACTIVATE PHYSICAL STANDBY DATABASE]. See error stack below.
  ORA-00604: ���j SQL �h�� 1 �o�Ϳ��~
  ORA-01190: �����ɩθ���� 1 �b�W�@�� RESETLOGS ���e
  ORA-01110: ����� 1: '/u02/oradata/cdb2/system01.dbf'

-- I guess the only way now is to re-create the standby database.

-- Shutdown the standby cdb2

-- disable DG configuration
DGMGRL> disable configuration
Disabled.

-- rman target / to cdb1 to delete existing backups first
rman target /
delete backup;

-- Then do a backup in cdb1
backup database plus archivelog;

-- Startup cdb2 as follows. initcdb2.ora only contains one line "DB_NAME=cdb2"
startup nomount pfile=/u01/app/oracle/product/12.1.0.2/db_1/dbs/initcdb2.ora

-- in cdb1, duplicate the standby using rman
export ORACLE_SID=cdb1
rman<<EOF
connect target sys/oracle
connect auxiliary sys/oracle@cdb2
@rman.txt
EOF

-- output log
RMAN>
RMAN> run {
2> duplicate target database for standby from active database
3> spfile
4> parameter_value_convert 'cdb1','cdb2'
5> set db_unique_name='cdb2'
6> set db_create_file_dest='/u02/oradata/cdb2'
7> set db_recovery_file_dest='/u02/oradata/cdb2'
8> set db_file_name_convert='/cdb1/','/cdb2/'
9> set log_file_name_convert='/cdb1/','/cdb2/'
10> set log_archive_max_processes='5'
11> set fal_client='cdb2'
12> set fal_server='cdb1'
13> set standby_file_management='AUTO'
14> set log_archive_config='dg_config=(cdb1,cdb2)'
15> set log_archive_dest_2='service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'
16> ;
17> }
Starting Duplicate Db at 02-JUN-16
using target database control file instead of recovery catalog
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=173 device type=DISK

contents of Memory Script:
{
   backup as copy reuse
   targetfile  '/u01/app/oracle/product/12.1.0.2/db_1/dbs/orapwcdb1' auxiliary format
 '/u01/app/oracle/product/12.1.0.2/db_1/dbs/orapwcdb2'   targetfile
 '/u01/app/oracle/product/12.1.0.2/db_1/dbs/spfilecdb1.ora' auxiliary format
 '/u01/app/oracle/product/12.1.0.2/db_1/dbs/spfilecdb2.ora'   ;
   sql clone "alter system set spfile= ''/u01/app/oracle/product/12.1.0.2/db_1/dbs/spfilecdb2.ora''";
}
executing Memory Script

Starting backup at 02-JUN-16
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=42 device type=DISK
Finished backup at 02-JUN-16

sql statement: alter system set spfile= ''/u01/app/oracle/product/12.1.0.2/db_1/dbs/spfilecdb2.ora''

contents of Memory Script:
{
   sql clone "alter system set  audit_file_dest =
 ''/u01/app/oracle/admin/cdb2/adump'' comment=
 '''' scope=spfile";
   sql clone "alter system set  control_files =
 ''/u02/oradata/cdb2/control01.ctl'', ''/u02/fast_recovery_area/cdb2/control02.ctl'' comment=
 '''' scope=spfile";
   sql clone "alter system set  dispatchers =
 ''(PROTOCOL=TCP) (SERVICE=cdb2XDB)'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_unique_name =
 ''cdb2'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_create_file_dest =
 ''/u02/oradata/cdb2'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_recovery_file_dest =
 ''/u02/oradata/cdb2'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_file_name_convert =
 ''/cdb1/'', ''/cdb2/'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_file_name_convert =
 ''/cdb1/'', ''/cdb2/'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_archive_max_processes =
 5 comment=
 '''' scope=spfile";
   sql clone "alter system set  fal_client =
 ''cdb2'' comment=
 '''' scope=spfile";
   sql clone "alter system set  fal_server =
 ''cdb1'' comment=
 '''' scope=spfile";
   sql clone "alter system set  standby_file_management =
 ''AUTO'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_archive_config =
 ''dg_config=(cdb1,cdb2)'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_archive_dest_2 =
 ''service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'' comment=
 '''' scope=spfile";
   shutdown clone immediate;
   startup clone nomount;
}
executing Memory Script

sql statement: alter system set  audit_file_dest =  ''/u01/app/oracle/admin/cdb2/adump'' comment= '''' scope=spfile

sql statement: alter system set  control_files =  ''/u02/oradata/cdb2/control01.ctl'', ''/u02/fast_recovery_area/cdb2/control02.ctl'' comment= '''' scope=spfile

sql statement: alter system set  dispatchers =  ''(PROTOCOL=TCP) (SERVICE=cdb2XDB)'' comment= '''' scope=spfile

sql statement: alter system set  db_unique_name =  ''cdb2'' comment= '''' scope=spfile

sql statement: alter system set  db_create_file_dest =  ''/u02/oradata/cdb2'' comment= '''' scope=spfile

sql statement: alter system set  db_recovery_file_dest =  ''/u02/oradata/cdb2'' comment= '''' scope=spfile

sql statement: alter system set  db_file_name_convert =  ''/cdb1/'', ''/cdb2/'' comment= '''' scope=spfile

sql statement: alter system set  log_file_name_convert =  ''/cdb1/'', ''/cdb2/'' comment= '''' scope=spfile

sql statement: alter system set  log_archive_max_processes =  5 comment= '''' scope=spfile

sql statement: alter system set  fal_client =  ''cdb2'' comment= '''' scope=spfile

sql statement: alter system set  fal_server =  ''cdb1'' comment= '''' scope=spfile

sql statement: alter system set  standby_file_management =  ''AUTO'' comment= '''' scope=spfile

sql statement: alter system set  log_archive_config =  ''dg_config=(cdb1,cdb2)'' comment= '''' scope=spfile

sql statement: alter system set  log_archive_dest_2 =  ''service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'' comment= '''' scope=spfile

Oracle instance shut down

connected to auxiliary database (not started)
Oracle instance started

Total System Global Area     838860800 bytes

Fixed Size                     2929936 bytes
Variable Size                666897136 bytes
Database Buffers             163577856 bytes
Redo Buffers                   5455872 bytes

contents of Memory Script:
{
   backup as copy current controlfile for standby auxiliary format  '/u02/oradata/cdb2/control01.ctl';
   restore clone primary controlfile to  '/u02/fast_recovery_area/cdb2/control02.ctl' from
 '/u02/oradata/cdb2/control01.ctl';
}
executing Memory Script

Starting backup at 02-JUN-16
using channel ORA_DISK_1
channel ORA_DISK_1: starting datafile copy
copying standby control file
output file name=/u01/app/oracle/product/12.1.0.2/db_1/dbs/snapcf_cdb1.f tag=TAG20160602T165805
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:03
Finished backup at 02-JUN-16

Starting restore at 02-JUN-16
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=13 device type=DISK

channel ORA_AUX_DISK_1: copied control file copy
Finished restore at 02-JUN-16

contents of Memory Script:
{
   sql clone 'alter database mount standby database';
}
executing Memory Script

sql statement: alter database mount standby database

contents of Memory Script:
{
   set newname for tempfile  1 to
 "/u02/oradata/cdb2/temp01.dbf";
   set newname for tempfile  2 to
 "/u02/oradata/cdb2/pdbseed/temp01.dbf";
   set newname for tempfile  3 to
 "/u02/oradata/cdb2/gisp/temp01.dbf";
   switch clone tempfile all;
   set newname for datafile  1 to
 "/u02/oradata/cdb2/system01.dbf";
   set newname for datafile  2 to
 "/u02/oradata/cdb2/pdbseed/system01.dbf";
   set newname for datafile  3 to
 "/u02/oradata/cdb2/sysaux01.dbf";
   set newname for datafile  4 to
 "/u02/oradata/cdb2/pdbseed/sysaux01.dbf";
   set newname for datafile  5 to
 "/u02/oradata/cdb2/undotbs01.dbf";
   set newname for datafile  6 to
 "/u02/oradata/cdb2/users01.dbf";
   set newname for datafile  7 to
 "/u02/oradata/cdb2/gisp/system01.dbf";
   set newname for datafile  8 to
 "/u02/oradata/cdb2/gisp/sysaux01.dbf";
   set newname for datafile  9 to
 "/u02/oradata/cdb2/gisp/gisp_users01.dbf";
   backup as copy reuse
   datafile  1 auxiliary format
 "/u02/oradata/cdb2/system01.dbf"   datafile
 2 auxiliary format
 "/u02/oradata/cdb2/pdbseed/system01.dbf"   datafile
 3 auxiliary format
 "/u02/oradata/cdb2/sysaux01.dbf"   datafile
 4 auxiliary format
 "/u02/oradata/cdb2/pdbseed/sysaux01.dbf"   datafile
 5 auxiliary format
 "/u02/oradata/cdb2/undotbs01.dbf"   datafile
 6 auxiliary format
 "/u02/oradata/cdb2/users01.dbf"   datafile
 7 auxiliary format
 "/u02/oradata/cdb2/gisp/system01.dbf"   datafile
 8 auxiliary format
 "/u02/oradata/cdb2/gisp/sysaux01.dbf"   datafile
 9 auxiliary format
 "/u02/oradata/cdb2/gisp/gisp_users01.dbf"   ;
   sql 'alter system archive log current';
}
executing Memory Script

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

renamed tempfile 1 to /u02/oradata/cdb2/temp01.dbf in control file
renamed tempfile 2 to /u02/oradata/cdb2/pdbseed/temp01.dbf in control file
renamed tempfile 3 to /u02/oradata/cdb2/gisp/temp01.dbf in control file

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

Starting backup at 02-JUN-16
using channel ORA_DISK_1
channel ORA_DISK_1: starting datafile copy
input datafile file number=00003 name=/u02/oradata/cdb1/sysaux01.dbf
output file name=/u02/oradata/cdb2/sysaux01.dbf tag=TAG20160602T165815
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:01:25
channel ORA_DISK_1: starting datafile copy
input datafile file number=00001 name=/u02/oradata/cdb1/system01.dbf
output file name=/u02/oradata/cdb2/system01.dbf tag=TAG20160602T165815
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:01:05
channel ORA_DISK_1: starting datafile copy
input datafile file number=00008 name=/u02/oradata/cdb1/gisp/sysaux01.dbf
output file name=/u02/oradata/cdb2/gisp/sysaux01.dbf tag=TAG20160602T165815
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:01:25
channel ORA_DISK_1: starting datafile copy
input datafile file number=00004 name=/u02/oradata/cdb1/pdbseed/sysaux01.dbf
output file name=/u02/oradata/cdb2/pdbseed/sysaux01.dbf tag=TAG20160602T165815
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:25
channel ORA_DISK_1: starting datafile copy
input datafile file number=00005 name=/u02/oradata/cdb1/undotbs01.dbf
output file name=/u02/oradata/cdb2/undotbs01.dbf tag=TAG20160602T165815
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:01:05
channel ORA_DISK_1: starting datafile copy
input datafile file number=00007 name=/u02/oradata/cdb1/gisp/system01.dbf
output file name=/u02/oradata/cdb2/gisp/system01.dbf tag=TAG20160602T165815
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:25
channel ORA_DISK_1: starting datafile copy
input datafile file number=00002 name=/u02/oradata/cdb1/pdbseed/system01.dbf
output file name=/u02/oradata/cdb2/pdbseed/system01.dbf tag=TAG20160602T165815
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:15
channel ORA_DISK_1: starting datafile copy
input datafile file number=00006 name=/u02/oradata/cdb1/users01.dbf
output file name=/u02/oradata/cdb2/users01.dbf tag=TAG20160602T165815
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:03
channel ORA_DISK_1: starting datafile copy
input datafile file number=00009 name=/u02/oradata/cdb1/gisp/gisp_users01.dbf
output file name=/u02/oradata/cdb2/gisp/gisp_users01.dbf tag=TAG20160602T165815
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:01
Finished backup at 02-JUN-16

sql statement: alter system archive log current

contents of Memory Script:
{
   switch clone datafile all;
}
executing Memory Script

datafile 1 switched to datafile copy
input datafile copy RECID=1 STAMP=913482264 file name=/u02/oradata/cdb2/system01.dbf
datafile 2 switched to datafile copy
input datafile copy RECID=2 STAMP=913482264 file name=/u02/oradata/cdb2/pdbseed/system01.dbf
datafile 3 switched to datafile copy
input datafile copy RECID=3 STAMP=913482264 file name=/u02/oradata/cdb2/sysaux01.dbf
datafile 4 switched to datafile copy
input datafile copy RECID=4 STAMP=913482264 file name=/u02/oradata/cdb2/pdbseed/sysaux01.dbf
datafile 5 switched to datafile copy
input datafile copy RECID=5 STAMP=913482264 file name=/u02/oradata/cdb2/undotbs01.dbf
datafile 6 switched to datafile copy
input datafile copy RECID=6 STAMP=913482264 file name=/u02/oradata/cdb2/users01.dbf
datafile 7 switched to datafile copy
input datafile copy RECID=7 STAMP=913482264 file name=/u02/oradata/cdb2/gisp/system01.dbf
datafile 8 switched to datafile copy
input datafile copy RECID=8 STAMP=913482264 file name=/u02/oradata/cdb2/gisp/sysaux01.dbf
datafile 9 switched to datafile copy
input datafile copy RECID=9 STAMP=913482264 file name=/u02/oradata/cdb2/gisp/gisp_users01.dbf
Finished Duplicate Db at 02-JUN-16

RMAN>
RMAN> **end-of-file**

RMAN>
RMAN>

Recovery Manager complete.

-- Remove the original DG configuration
DGMGRL> remove configuration
Removed configuration

-- In standby, start the redo apply
SQL> alter database recover managed standby database using current logfile disconnect;

-- The cdb1 log_archive_dest_state_2 was found "RESET", so need to enable for redo transport to work.
SQL> ALTER SYSTEM SET log_archive_dest_state_2='ENABLE' SCOPE=BOTH;

-- Turn on flashback on both db if not already

-- Add DG config.
dgmgrl <<EOF
connect sys/oracle@cdb1
create configuration 'DGCONFIG' as primary database is 'cdb1' connect identifier is cdb1;
add database 'cdb2' as connect identifier is cdb2;
enable configuration;
EOF
sqlplus sys/oracle@cdb1 as sysdba <<EOF
alter system set log_archive_dest_2='service=cdb2 async valid_for=(online_logfile,primary_role) db_unique_name=cdb2';
EOF

-- Set fsfo property
dgmgrl <<EOF
connect sys/oracle@cdb1
edit database cdb1 set property FastStartFailoverTarget=cdb2;
edit database cdb2 set property FastStartFailoverTarget=cdb1;
EOF

-- check config
DGMGRL> show configuration

  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    Warning: ORA-16629: database reports a different protection level from the protection mode
    cdb2 - Physical standby database


DGMGRL> show database verbose cdb1
  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1

	Database Warning(s):
    ORA-16629: database reports a different protection level from the protection mode

  Properties:
    DGConnectIdentifier             = 'cdb1'
    ObserverConnectIdentifier       = ''
    LogXptMode                      = 'SYNC'      
    RedoRoutes                      = ''
	
DGMGRL> show database verbose cdb2
Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      0 seconds (computed 1 second ago)
  Apply Lag:          0 seconds (computed 1 second ago)
  Average Apply Rate: 1.00 KByte/s
  Active Apply Rate:  0 Byte/s
  Maximum Apply Rate: 0 Byte/s
  Real Time Query:    ON
  Instance(s):
    cdb2

  Properties:
    DGConnectIdentifier             = 'cdb2'
    ObserverConnectIdentifier       = ''
    LogXptMode                      = 'ASYNC'        <---- Should be SYNC
    RedoRoutes                      = ''

-- Change cdb2 logxptmode to SYNC because it was set to 'ASYNC' in the rman.txt
DGMGRL> edit database cdb2 set property 'LogXptMode'='SYNC';
Property "LogXptMode" updated

-- Everything is fine. The DG config is re-created and the DG is normal.
DGMGRL> show configuration
  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    cdb2 - Physical standby database
Fast-Start Failover: DISABLED
Configuration Status:
SUCCESS   (status updated 2 seconds ago)

  
  
--------------------------------------------------------------------------------------------------------------------------
Problem
RMAN backup failed.ORA-20079: .RMAN-03014: implicit resync of recovery catalog failed.

RMAN> backup database "pdb$seed" format '/u02/fast_recovery_area/adhocbkup/cdb1_seed_%U.bkp';
ORA-20079: full resync from primary database is not done

doing automatic resync from primary
resyncing from database with DB_UNIQUE_NAME cdb2
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of backup command at 06/01/2016 16:38:23
RMAN-03014: implicit resync of recovery catalog failed
RMAN-03009: failure of partial resync command on default channel at 06/01/2016 16:38:23
ORA-17629: Cannot connect to the remote database server
ORA-17628: Oracle error 17629 returned by remote Oracle server
ORA-17629: Cannot connect to the remote database server

Reason
Files have been added at the Primary site
 
RMAN is trying to implicitly resync from the Primary using db_unique_name as it is aware that structural changes have been made.
However, RMAN is unable to connect to the primary because no connect string was used when connecting to the standby - in order to resync from another host in a Data Guard configuration , the connection to target must be made with a username, password and alias.
 
Solution:
Use a TNS connect string when connecting to the standby, eg.
CONNECT TARGET "sys/oracle@target AS SYSDBA";
CONNECT CATALOG "rmancat/rmancat@orcl";



How to manually resync catalog
-- connect to standby
$ rman target sys/oracle@target catalog rmancat/rmancat@orcl
-- resync catalog from primary
resync catalog from db_unique_name <primary db_unique_name>;


Reference
http://selvathiruppathi.blogspot.hk/2016/01/ora-20079-full-resync-from-primary.html
https://aprakash.wordpress.com/2015/04/11/ora-17629-ora-20079-2/

--------------------------------------------------------------------------------------------------------------------------
Problem
tempfiles errors ora-01186 ora-01122 in standby after duplicate from primary

ORA-01186: �ɮ� 201 ���q�L���Ҵ���
ORA-01122: ��Ʈw�� 201 ���q�L�����ˬd
ORA-01110: ����� 201: '/u02/oradata/cdb2/temp01.dbf'
ORA-01203: ���ɮת����������T - �إ� SCN ���~
File 201 not verified due to error ORA-01122

ORA-01186: �ɮ� 203 ���q�L���Ҵ���
ORA-01122: ��Ʈw�� 203 ���q�L�����ˬd
ORA-01110: ����� 203: '/u02/oradata/cdb2/gisp/temp01.dbf'
ORA-01203: ���ɮת����������T - �إ� SCN ���~
File 203 not verified due to error ORA-01122

ORA-01186: �ɮ� 202 ���q�L���Ҵ���
ORA-01122: ��Ʈw�� 202 ���q�L�����ˬd
ORA-01110: ����� 202: '/u02/oradata/cdb2/pdbseed/temp01.dbf'
ORA-01203: ���ɮת����������T - �إ� SCN ���~
File 202 not verified due to error ORA-01122



--------------------------------------------------------------------------------------------------------------------------
Problem: failed to upgrade catalog in vbgeneric from dg2. error creating dbms_rcvcat package body

Reason:
vbgeneric is of 12.1.0.2 version and CPUOCT2015 applied and dg2 is of 12.1.0.2 version and with CPUJUL2015 applied. The reason maybe due to CPUOCT2015 is newer than CPUJUL2015...

[oracle@dg2 setup_dg]$ rman catalog rmancat/rmancat@orcl
Recovery Manager: Release 12.1.0.2.0 - Production on Mon Jun 6 12:01:13 2016
Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights reserved.
connected to target database: CDB1 (DBID=883395141)
connected to recovery catalog database

RMAN> upgrade catalog;
RMAN> upgrade catalog;

error creating dbms_rcvcat package body
RMAN-571: ===========================================================
RMAN-569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-571: ===========================================================
RMAN-6443: error upgrading recovery catalog

Reference
	Known Issues with RMAN Oracle12c Catalog (Doc ID 2039848.1)


--------------------------------------------------------------------------------------------------------------------------
Problem: ORA-16737: the redo transport service for standby database "cdb2" has an error

After re-start the standby database, the redo transport has error, but it recover automatically after 5 minutes.

DGMGRL> show database cdb1
  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1
      Error: ORA-16737: the redo transport service for standby database "cdb2" has an error

DGMGRL> show database cdb2
  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      1 minute 8 seconds (computed 120 seconds ago)
  Apply Lag:          1 minute 8 seconds (computed 120 seconds ago)
  Average Apply Rate: 0 Byte/s
  Real Time Query:    ON
  Instance(s):
    cdb2
  Database Warning(s):
    ORA-16857: standby disconnected from redo source for longer than specified threshold


	
Archived dest,SCNs and Gap (Run in Primary only)
The STATUS must be VALID and ERROR should be null in normal status

   DEST_ID STATUS          DEST       APPLIED_SCN APPLIED_SCN_TIME     CURRENT_SCN CURRENT_SCN_TIME     ERROR
---------- --------------- ---------- ----------- -------------------- ----------- -------------------- ------------------------------
         2 ERROR           cdb2          12903014 06-06-2016 16:15:26     12903232 06-06-2016 16:17:34  ORA-16198: Timeout incurred
                                                                                                        on internal channel during
                                                                                                        remote archival


1 row selected.


   DEST_ID STATUS          GAP_STATUS
---------- --------------- --------------------
         2 ERROR           RESOLVABLE GAP


-- In cdb1 alertlog...		 
ORA-16198: LGWR received timedout error from KSR
Mon Jun 06 16:16:38 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb1/cdb1/trace/cdb1_lgwr_2964.trc:
ORA-16198: �i�滷�ݦs�ɮɤ����q�D�O��
Error 16198 for archive log file 2 to 'cdb2'
LGWR: Failed to archive log 2 thread 1 sequence 156 (16198)

After 5 minutes, it resolve the gap automatically...

Archived Log entry 829 added for thread 1 sequence 156 ID 0x34e261e3 dest 1:
Mon Jun 06 16:21:44 2016
ARC2: Standby redo logfile selected for thread 1 sequence 156 for destination LOG_ARCHIVE_DEST_2
Mon Jun 06 16:21:47 2016
Destination LOG_ARCHIVE_DEST_2 is SYNCHRONIZED


--------------------------------------------------------------------------------------------------------------------------
RMAN-20051: datafile resync not completed

RMAN error on standby database when issuing RMAN command

RMAN> list backup;

ORA-20079: full resync from primary database is not done

doing automatic resync from primary
resyncing from database with DB_UNIQUE_NAME cdb1
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of list command at 06/15/2016 15:34:47
RMAN-03014: implicit resync of recovery catalog failed
RMAN-03009: failure of partial resync command on default channel at 06/15/2016 15:34:47
RMAN-20051: datafile resync not completed


Reason
Bug 20848335 - ORA-20079 / RMAN-20051 raised by rman on standby (Doc ID 20848335.8)

Bug 20848335  ORA-20079 / RMAN-20051 raised by rman on standby

 This note gives a brief overview of bug 20848335. 
 The content was last updated on: 08-FEB-2016
 Click here for details of each of the sections below.
Affects:

Product (Component)	Oracle Server (Rdbms)
Range of versions believed to be affected	Versions >= 12 but BELOW 12.2
Versions confirmed as being affected	
12.1.0.2 (Server Patch Set)
Platforms affected	Generic (all / most platforms affected)
Fixed:

The fix for 20848335 is first included in	
12.2 (Future Release)
12.1.0.2.160119 (Jan 2016) Bundle Patch for Engineered Systems / DB In-Memory (DBBP)

Description

In CDB+ADG, first resync from standby will fail with RMAN-20051 if curent_scn of standby has risen from last_full_ckp_scn.
 
Rediscovery Notes
 
RMAN> resync catalog;
RMAN-01005: starting partial resync of recovery catalog
RMAN-01005: ORA-20079: full resync from primary database is not done
 
RMAN-01005: doing automatic resync from primary
....
RMAN-20051: datafile resync not completed


--------------------------------------------------------------------------------------------------------------------------
RMAN-20999: internal error

[oracle@gdat9119 script]$ rman <<EOF
CONNECT TARGET "sys/Gisp201606@target AS SYSDBA";
CONNECT CATALOG "rmancat/rmancat@rmancat";
resync catalog from db_unique_name cdb1;
list backup;
EOF

Recovery Manager: Release 12.1.0.2.0 - Production on Fri Sep 9 09:36:06 2016
Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights reserved.
RMAN>
connected to target database: CDB1 (DBID=895471538, not open)
RMAN>
connected to recovery catalog database
RMAN>
RMAN>
resyncing from database with DB_UNIQUE_NAME CDB1
starting full resync of recovery catalog
full resync complete

RMAN>
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of list command at 09/09/2016 09:36:09
RMAN-03014: implicit resync of recovery catalog failed
RMAN-03009: failure of partial resync command on default channel at 09/09/2016 09:36:09
RMAN-20999: internal error

RMAN>
RMAN>


Solution:

-- Login to primary to unregister the primary database
rman TARGET / CATALOG rmancat/rmancat@orcl;
UNREGISTER DATABASE;

-- Login to primary to register the primary database again
rman TARGET / CATALOG rmancat/rmancat@orcl;
REGISTER DATABASE;

-- Run below command to verify registration ok. It should display tablespaces/datafiles
report schema;


--------------------------------------------------------------------------------------------------------------------------
-- gdat9118(cdb1) primary database failed to open after server reboot due to failure in infra device.

cdb1 started up at Nov 25 09:05
cdb2 started up at Nov 25 09:03

-- cdb1 alertlog indicates network(NI) error, cdb1 could not reach cdb2
LGWR: Primary database is in MAXIMUM AVAILABILITY mode
Mon Nov 25 09:06:42 2019
Destination LOG_ARCHIVE_DEST_2 is UNSYNCHRONIZED
LGWR: Destination LOG_ARCHIVE_DEST_1 is not serviced by LGWR

Fatal NI connect error 12543, connecting to:
 (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=gdat9119)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=cdb2_DGB.lands)(CID=(PROGRAM=oracle)(HOST=gdat9118)(USER=oracle))))
  Time: 25-NOV-2019 09:08:31
  Tracing not turned on.

-- db restarted again 
Mon Nov 25 09:14:17 2019
Starting ORACLE instance (normal) (OS id: 2578)
Mon Nov 25 09:14:18 2019
CLI notifier numLatches:7 maxDescs:2499
Mon Nov 25 09:14:18 2019
**********************************************************************
Mon Nov 25 09:14:18 2019
Dump of system resources acquired for SHARED GLOBAL AREA (SGA)

Mon Nov 25 09:14:50 2019
Data Guard: version check completed
Data Guard: primary role verified
Data Guard: the primary database open may proceed.

-- Still network issue..
Fatal NI connect error 12543, connecting to:
 (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=gdat9119)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=cdb2_DGB.lands)(CID=(PROGRAM=oracle)(HOST=gdat9118)(USER=oracle))))

  VERSION INFORMATION:
        TNS for Linux: Version 12.1.0.2.0 - Production
        TCP/IP NT Protocol Adapter for Linux: Version 12.1.0.2.0 - Production
  Time: 25-NOV-2019 09:24:53
  Tracing not turned on.
  Tns error struct:
    ns main err code: 12543

-- Primary(cdb1) shut down itself because it could not connect with cdb2 and observer in FastStartFailoverThreshold seconds.
Mon Nov 25 09:24:55 2019
Primary has heard from neither observer nor target standby within FastStartFailoverThreshold seconds.
It is likely an automatic failover has already occurred. Primary is shutting down.
Mon Nov 25 09:24:55 2019
Errors in file /u01/app/oracle/diag/rdbms/cdb1/cdb1/trace/cdb1_lgwr_2605.trc:
ORA-16830: ???????????????????????? FastStartFailoverThreshold ????: ??
LGWR (ospid: 2605): terminating the instance due to error 16830
Mon Nov 25 09:24:55 2019

-- cdb1 started up again, but marked itself as old primary, and in mounted state.
Starting ORACLE instance (normal) (OS id: 2342)
Mon Nov 25 11:07:44 2019
CLI notifier numLatches:7 maxDescs:2499
Mon Nov 25 11:07:44 2019

Mon Nov 25 11:08:17 2019
Data Guard: version check completed
Data Guard: primary role verified
Data Guard: detected that a role change has occurred or is likely to have occurred. This is an old primary in need of reinstatement. Database will not be opened.
ORA-16649 signalled during: ALTER DATABASE OPEN...

-- Still network error
Fatal NI connect error 12543, connecting to:
 (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=gdat9119)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=cdb2_DGB.lands)(CID=(PROGRAM=oracle)(HOST=gdat9118)(USER=oracle))))

  VERSION INFORMATION:
        TNS for Linux: Version 12.1.0.2.0 - Production
        TCP/IP NT Protocol Adapter for Linux: Version 12.1.0.2.0 - Production
  Time: 25-NOV-2019 11:37:48
  Tracing not turned on.
  Tns error struct:
    ns main err code: 12543

-- I disabled FSFO. Tried to open cdb1 but failed.
Mon Nov 25 12:05:34 2019
Fast-Start Failover (FSFO) has been disabled on "cdb1"
Mon Nov 25 12:06:16 2019
alter database open
ORA-65054 signalled during: alter database open...
Mon Nov 25 12:30:37 2019
ALTER SYSTEM SET log_archive_dest_state_2='RESET' SCOPE=BOTH;



DGMGRL> show configuration verbose;

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    Error: ORA-16782: instance not open for read and write access

    cdb2 - Physical standby database
      Warning: ORA-16858: last communication time from redo source could not be determined


Solution:
Once the network resumed, shutdown both cdb1 and cdb2, and then restarted them.

	
==========================================================================================================================
===  FAQ
==========================================================================================================================

How to delay the application of logs to a physical standby?

The following is an example of how to add a 1-hour delay: Run in primary.
SQL> ALTER SYSTEM SET LOG_ARCHIVE_DEST_2='SERVICE=stdby_srvc DELAY=60';

or 

ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DELAY 60 DISCONNECT FROM SESSION;

ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE NODELAY DISCONNECT FROM SESSION;


--------------------------------------------------------------------------------------------------------------------------

How to cancel the apply process?

ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;

--------------------------------------------------------------------------------------------------------------------------
How to turn-on, turn-off the transport of redo data to standby database?

Suppose the primary database is cdb1

-- To turn off the transport. Need to change the protection mode to maxPerformance first.
DGMGRL> EDIT DATABASE cdb1 SET STATE=TRANSPORT-OFF;

-- To turn on the transport
DGMGRL> EDIT DATABASE cdb1 SET STATE=TRANSPORT-ON;

--------------------------------------------------------------------------------------------------------------------------
How to turn-on, turn-off the apply of redo data on the standby database?

Suppose the standby database is cdb2

-- To turn off the apply of redo data
EDIT DATABASE cdb2 SET STATE='APPLY-OFF';

-- To turn on the apply of redo data
EDIT DATABASE cdb2 SET STATE='APPLY-ON';

--------------------------------------------------------------------------------------------------------------------------

How to cleanup applied archived log in primary and standby?

Check the lastest applied archived log sequence number and then run below command in rman.

rman> delete archivelog until sequence=<seq_no>;

or use until time
rman> delete archivelog until time 'sysdate-1';

--------------------------------------------------------------------------------------------------------------------------

How to check the current mode of the standby database ?

sql > @db

OPEN_MODE
----------------------------------------
READ ONLY WITH APPLY


DATABASE_ROLE
--------------------------------
PHYSICAL STANDBY


Note: 
1. It seems by default the standby was opened in read only mode. So, archived log are not applied. Need to run 
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT FROM SESSION;
in Standby database.

2. The /etc/hosts defines the IPs of the primary/standby machines. May need to modify it according to the dynamically assigned IPs by VirtualBox.

--------------------------------------------------------------------------------------------------------------------------
Is the tns alias name in tnsnames.ora case sensitive in Linux?

Although Linux is a case sensitive OS, the tns alias name is not. So both work as belows

sqlplus <login>/<pwd>@cdb1 
sqlplus <login>/<pwd>@CDB1 

However, for $ORACLE_SID, it is case sensitive.

--------------------------------------------------------------------------------------------------------------------------
As the db is in force logging mode, can I do a truncate on a table?

Yes, truncate table is supported. Actually, truncate table is logged by Oracle although it cannot be undo.

--------------------------------------------------------------------------------------------------------------------------
How to setup the observer?

Install same version of Oracle client as the Oracle database in another machine(other than the primary/standby).
Choose the Administrator option when install. 

The observer can be run from any platform that supports it, and that platform can be different from the platform of the primary or target standby database.

To start the observer, you must be able to log in to DGMGRL with an account that has the SYSDBA privilege. 
The observer is an OCI client that connects to the primary and target standby databases using the same SYS credentials you used 
when you connected to the Data Guard configuration with DGMGRL.

FS_FAILOVER_OBSERVER_HOST shows the name of the computer on which the observer is running
FS_FAILOVER_OBSERVER_PRESENT shows whether or not the observer is connected to the local database

To determine if fast-start failover can occur, the FS_FAILOVER_STATUS column displays either SYNCHRONIZED or TARGET UNDER LAG LIMIT 
and the FS_FAILOVER_OBSERVER_PRESENT column displays YES for the target standby database. 

To stop the observer when fast-start failover is enabled, the primary database and target standby database must be 
connected and communicating with each other. Stopping the observer does not disable fast-start failover. 
However, fast-start failover cannot occur when the target standby database is in the unobserved state.

To stop the observer when fast-start failover is enabled, but the primary and standby are isolated from each other, 
you must first disable fast-start failover by using the FORCE option, and then stop the observer.
Always disable fast-start failover in the target standby database.

So, in my case, I will install oracle 12c(12.1.0.2) Oracle client in another machine with Oracle ID.
Setup the tnsnames.ora with cdb1 and cdb2 entries.
Then, run below command to start the observer.

nohup dgmgrl -logfile observer.log sys/oracle@cdb1 "start observer" &

--------------------------------------------------------------------------------------------------------------------------
How to startup/shutdown the physical standby database?

Conclusion: To shutdown standby, need to stop redo apply first, then shutdown. To startup, use startup mount 
and then resume redo apply. A quick way is to use "shutdown immediate" - No need to stop redo apply.

See appendix for details
--------------------------------------------------------------------------------------------------------------------------

How to setup flashback database and prepare the initialization parameters?

ALTER SYSTEM SET UNDO_RETENTION=3600 SCOPE=SPFILE;
ALTER SYSTEM SET UNDO_MANAGEMENT='AUTO' SCOPE=SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
SHOW PARAMETER UNDO;
ALTER SYSTEM SET DB_FLASHBACK_RETENTION_TARGET=4320 SCOPE=BOTH;
ALTER DATABASE ARCHIVELOG;
ALTER SYSTEM SET db_recovery_file_dest_size=<size>;
ALTER SYSTEM SET db_recovery_file_dest=<directory-specification>;
ALTER DATABASE FLASHBACK ON;
ALTER DATABASE OPEN;

Ensure the UNDO_RETENTION and DB_FLASHBACK_RETENTION_TARGET initialization parameters 
are set to sufficiently large values so that reinstatement is still possible after a prolonged outage.

--------------------------------------------------------------------------------------------------------------------------
What happen when shut down the observer machine?

The primary database still work even the observer is power down.

Don't put the observer and standby in the SAME machine, otherwise the
primary database will be shutdown when the standby and observer machine is power off.

See appendix for details
--------------------------------------------------------------------------------------------------------------------------
How to refresh the Password File?

The password file must be recopied whenever an administrative privilege (SYSDG, SYSOPER, SYSDBA, and so on) 
is granted or revoked, and after the password of any user with administrative privileges is changed.

For example, the SYS password is changed in primary(cdb1), then the password file must be copied to the standby.

scp -p orapwcdb1 oracle@dg2:/u01/app/oracle/product/12.1.0.2/db_1/dbs/orapwcdb2

The SYS password in the data dictionary will be synchronized to standby through DG.
There is no need to change it in the standby. Also, the standby cannot be opened for read write also.

Note: As the Observer use the SYS to login, the Observer must be stopped beforehand. 
Modify the Observer startup script using the new SYS password to connect. Otherwise, the Observer 
will fail to logon and the observer.log will show "Authentication failed".

--------------------------------------------------------------------------------------------------------------------------
Primary Database Changes That Require Manual Intervention at a Physical Standby
http://docs.oracle.com/database/121/SBYDB/manage_ps.htm#SBYDB4784

0. Refresh the Password File
If the REMOTE_LOGIN_PASSWORDFILE database initialization parameter is set to SHARED or EXCLUSIVE, 
the password file on a physical standby database must be replaced with a fresh copy from the primary database 
after granting or revoking administrative privileges or changing the password of a user with administrative privileges.

Failure to refresh the password file on the physical standby database may cause authentication of redo transport sessions 
or connections as SYSDG, SYSDBA, or SYSOPER to the physical standby database to fail.

1. Adding a Data File or Creating a Tablespace
if STANDBY_FILE_MANAGEMENT=auto, nothing need to do

2. Dropping Tablespaces and Deleting Data Files
SQL> DROP TABLESPACE tbs_4 INCLUDING CONTENTS AND DATAFILES;
SQL> ALTER SYSTEM SWITCH LOGFILE;
Note: The STANDBY_FILE_MANAGEMENT=auto is required

3. Using Transportable Tablespaces with a Physical Standby Database
Need manual intervention. Read the manual for details

4. Renaming a Data File in the Primary Database
Need manual intervention. Read the manual for details

5. Add or Drop a Redo Log File Group
Need manual intervention. Read the manual for details

6. NOLOGGING or Unrecoverable Operations
When you perform a DML or DDL operation using the NOLOGGING or UNRECOVERABLE clause, the standby database is invalidated 
and may require substantial DBA administrative activities to repair. You can specify the SQL ALTER DATABASE or SQL ALTER TABLESPACE statement 
with the FORCE LOGGING clause to override the NOLOGGING setting. However, this statement will not repair an already invalidated database.

See Section 15.4 for information about recovering after the NOLOGGING clause is used.

7. Reset the TDE Master Encryption Key
Need manual intervention. Read the manual for details

--------------------------------------------------------------------------------------------------------------------------
How to drop online redo logs in Primary and standby?

As suggested by Oracle, standby redo logs must be same size as online redo logs and also should be one more.
For example, if there are 5 online redo logs, then there should be 6 standby redo logs of same size.

In primary
1. select group#,status from v$log
2. Make sure status is 'INACTIVE' to the logs to drop. For example, to drop groups 4-8 as follows:
ALTER DATABASE CLEAR LOGFILE GROUP 4;
ALTER DATABASE CLEAR LOGFILE GROUP 5;
ALTER DATABASE CLEAR LOGFILE GROUP 6;
ALTER DATABASE CLEAR LOGFILE GROUP 7;
ALTER DATABASE CLEAR LOGFILE GROUP 8;

ALTER DATABASE DROP LOGFILE GROUP 4;
ALTER DATABASE DROP LOGFILE GROUP 5;
ALTER DATABASE DROP LOGFILE GROUP 6;
ALTER DATABASE DROP LOGFILE GROUP 7;
ALTER DATABASE DROP LOGFILE GROUP 8;

In standby
EDIT DATABASE cdb2 SET STATE='APPLY-OFF';

alter system set standby_file_management='MANUAL' scope=both;

ALTER DATABASE CLEAR LOGFILE GROUP 4;
ALTER DATABASE CLEAR LOGFILE GROUP 5;
ALTER DATABASE CLEAR LOGFILE GROUP 6;
ALTER DATABASE CLEAR LOGFILE GROUP 7;
ALTER DATABASE CLEAR LOGFILE GROUP 8;

ALTER DATABASE DROP LOGFILE GROUP 4;
ALTER DATABASE DROP LOGFILE GROUP 5;
ALTER DATABASE DROP LOGFILE GROUP 6;
ALTER DATABASE DROP LOGFILE GROUP 7;
ALTER DATABASE DROP LOGFILE GROUP 8;

alter system set standby_file_management='AUTO' scope=both;

EDIT DATABASE cdb2 SET STATE='APPLY-ON';

--------------------------------------------------------------------------------------------------------------------------
If listeners in DG down, does it affect redo transport and log apply?

Conclusion: Make sure both listeners are up before switchover. Redo transport and log apply are independent 
of listeners in normal run because by default dgmgrl use a dedicated connection to the databases.

See appendix for details

--------------------------------------------------------------------------------------------------------------------------
Under max performance and max availability modes, can primary still commit txn if standby is down?

Yes.

See appendix for details

--------------------------------------------------------------------------------------------------------------------------
How to alert application in jdbc to switch connection whenever DG role change because of switchover/failover?

This requires configurations in different tiers, application and database tiers. Temporarily not setting this in 
SC/APP applications.

--------------------------------------------------------------------------------------------------------------------------
How to allow seamless access in sqlplus (OCI) in DG failover

Reference
http://facedba.blogspot.hk/2014/08/faststart-failover-using-dataguard.html
https://www.youtube.com/watch?v=VvYoz9trVnI


Perform the following steps.

-- Create service in primary pdb where service resides. It will be created in standby automatically through DG.
EXEC DBMS_SERVICE.CREATE_SERVICE(SERVICE_NAME => 'GISPSERVICE', NETWORK_NAME => 'GISPSERVICE', FAILOVER_METHOD => 'BASIC',  FAILOVER_TYPE => 'SELECT', FAILOVER_RETRIES => 120, FAILOVER_DELAY => 1);
/

-- You can drop service with below command
EXEC DBMS_SERVICE.DELETE_SERVICE(service_name => 'GISPSERVICE');
/
   
-- Start the service in primary pdb where service was created
sql> exec dbms_service.START_SERVICE('GISPSERVICE');

-- You can drop service with below command
sql> exec dbms_service.STOP_SERVICE('GISPSERVICE');

-- Check service created
SELECT NAME FROM DBA_SERVICES;

-- Create procedure in primary pdb to trigger for starting/ stopping service in case of shut down of Primary database.
SQL> 
create or replace procedure p_cmc_taf_service is
  v_role VARCHAR(30);
begin
  select DATABASE_ROLE into v_role from V$DATABASE;
  if v_role = 'PRIMARY' then
    DBMS_SERVICE.START_SERVICE('GISPSERVICE');
  else
    DBMS_SERVICE.STOP_SERVICE('GISPSERVICE');
  end if;
end;
/

-- Create triggers in primary pdb to call above procedure when start the database
SQL>  
create or replace TRIGGER trg_cmc_taf_service_startup
  after startup on database
begin
  p_cmc_taf_service;
end;
/

-- Create triggers in cdb$root to call above procedure when database role will be changed in the database
-- The db_role_change trigger can only be created in cdb$root. But it need to call the p_cmc_taf_service
-- in the primary pdb, so need to figure out how. So in this moment, db_role_change has not been created yet.
SQL> 
create or replace TRIGGER trg_cmc_taf_manage_rolechange
  after db_role_change on database
begin
  p_cmc_taf_service;
end;
/


-- For Application to access seamlessly, in client machine add below entry in tnsnames.ora

GISPSERVICE =
(DESCRIPTION =
   (ADDRESS_LIST=
     (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.101)(PORT = 1521))
     (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.102)(PORT = 1521))
   )
     (CONNECT_DATA = 
    (SERVER = DEDICATED)
    (SERVICE_NAME = GISPSERVICE.lands)
    (FAILOVER_MODE=(TYPE=SELECT)(METHOD=BASIC)(RETRIES=30)(DELAY=5))
     )
)

OR 

GISPSERVICE =
(DESCRIPTION =
   (ADDRESS_LIST=
     (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.101)(PORT = 1521))
     (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.102)(PORT = 1521))
   )
   (CONNECT_DATA = 
    (SERVICE_NAME = GISPSERVICE.lands)
   )
)


-- For Application(sqlplus) to access seamlessly, in client machine add below entry in sqlnet.ora
-- It specifies the connection timeout to 3 seconds
SQLNET.OUTBOUND_CONNECT_TIME=3

--------------------------------------------------------------------------------------------------------------------------
How to set connection failover in JDBC



--------------------------------------------------------------------------------------------------------------------------
What should be the backup/recovery strategy if not using catelog database?

Reference
http://aliyagmur.blogspot.hk/2014/09/backup-strategy-in-dataguard-enviroment.html

Perform backup on both primary and standby databases as follows:

In primary and standby
--------------------------------------------------------------------------
CONFIGURE RETENTION POLICY TO REDUNDANCY 1;
CONFIGURE ARCHIVELOG DELETION POLICY TO APPLIED ON ALL STANDBY BACKED UP 1 TIMES TO DEVICE TYPE DISK;

sql "alter session set nls_date_format=''dd.mm.yyyy hh24:mi:ss''";
run {
allocate channel t1 device type disk;
set limit channel t1 kbytes 1800000; 
backup incremental level 0 as compressed backupset database tag=weekly_full plus archivelog;
release channel t1;
}

delete noprompt force expired backup;
delete noprompt force expired archivelog all;
delete noprompt force obsolete;

crosscheck archivelog all;
crosscheck backup;

report obsolete;
LIST EXPIRED backup;
LIST EXPIRED archivelog all;

restore database validate;
validate archivelog all;
restore controlfile validate;

Note: The archivelog deletion policy is set to "APPLIED ON ALL STANDBY BACKED UP 1 TIMES TO DEVICE TYPE DISK".
Actually, rman does not mark the backed up archived log as "obsolete" if there is no space pressure 
in the FRA.

Reference: Configure RMAN to purge archivelogs after applied on standby (Doc ID 728053.1)

--------------------------------------------------------------------------------------------------------------------------
What is the purpose of flashback database in DG?

Flashback Database removes the need to re-create the primary database after a failover. 
Flashback Database enables you to return a database to its state at a time in the recent past 
much faster than traditional point-in-time recovery, because it does not require restoring 
data files from backup nor the extensive application of redo data. 

--------------------------------------------------------------------------------------------------------------------------
How to enable history function in sqlplus/rman/dgmgrl under Linux?

https://blogs.oracle.com/middleware/entry/getting_history_from_sqlplus_using

--------------------------------------------------------------------------------------------------------------------------
LOG_ARCHIVE_FORMAT is ignored in these cases:

For archived log files that go to the fast recovery area

When LOG_ARCHIVE_DEST[_n] points to the root of an Oracle ASM disk group (for example, +DATA). 
The directory of a disk group (for example, +DATA/logs) must be specified for the parameter to be honored.

--------------------------------------------------------------------------------------------------------------------------
How to check log transport status after setup?

# On the primary server

ALTER SESSION SET nls_date_format='DD-MM-YYYY HH24:MI:SS';
SELECT sequence#,REGISTRAR,first_time,next_time,archived,applied FROM v$archived_log ORDER BY sequence#;
ALTER SYSTEM SWITCH LOGFILE;

# On the standby server

ALTER SESSION SET nls_date_format='DD-MM-YYYY HH24:MI:SS';
SELECT sequence#, REGISTRAR, applied, status, COMPLETION_TIME FROM v$archived_log ORDER BY sequence#;
select thread#,max(sequence#) from v$archived_log where applied='YES' group by thread#;

--------------------------------------------------------------------------------------------------------------------------
License required for oracle recovery catalog?

No.

Infrastructure Repository Databases
http://download.oracle.com/docs/cd/B28359_01/license.111/b28287/editions.htm#DBLIC130

"A separate Oracle Database can be installed and used as a Recovery Manager (RMAN) repository 
without additional license requirements, provided that all the Oracle databases managed 
in this repository are correctly licensed. This repository database may also be used for 
the Oracle Enterprise Grid Control repository. It may not be used or deployed for other uses."

RMAN Catalog requires Enterprise Edition (EE) since Oracle Database 12.1.0.2
https://blogs.oracle.com/UPGRADE/entry/rman_catalog_requires_ee_in

--------------------------------------------------------------------------------------------------------------------------
Configuring automatic startup of Oracle Database under systemd on RHEL 7/OEL 7/CentOS 7

http://ivan.kartik.sk/index.php?controller=post&action=view&id_post=65
--------------------------------------------------------------------------------------------------------------------------
Automating Database Startup and Shutdown on Linux

1. Log in as root
2. Modify /etc/oratab to 'Y' to startup oracle on restart
3. create /etc/init.d/dbora
4. # chgrp oinstall dbora
5. # chmod 750 dbora
6. # ln -s /etc/init.d/dbora /etc/rc.d/rc0.d/K01dbora
7. # ln -s /etc/init.d/dbora /etc/rc.d/rc3.d/S99dbora
8. # ln -s /etc/init.d/dbora /etc/rc.d/rc3.d/K01dbora
9. # ln -s /etc/init.d/dbora /etc/rc.d/rc5.d/S99dbora
10. # ln -s /etc/init.d/dbora /etc/rc.d/rc5.d/K01dbora

--------------------------- dbora ----------------------------
#! /bin/sh 
#
# Change the value of ORACLE_HOME to specify the correct Oracle home
# directory for your installation.

ORACLE_HOME=/u01/app/oracle/product/12.1.0/dbhome_1
#
# Change the value of ORACLE to the login name of the
# oracle owner at your site.
#
ORACLE=oracle

PATH=${PATH}:$ORACLE_HOME/bin
HOST=`hostname`
PLATFORM=`uname`
export ORACLE_HOME PATH
#
if [ ! "$2" = "ORA_DB" ] ; then
      runuser -l $ORACLE  $0 $1 ORA_DB
      if [ "$PLATFORM" = "Linux" ] && [ "$1" = "start" ] ; then
         touch /var/lock/subsys/dbora
        elif [ "$PLATFORM" = "Linux" ] && [ "$1" = "stop" ] ; then
          rm -f /var/lock/subsys/dbora
      fi
      exit
   fi
#
case $1 in
'start')
        $ORACLE_HOME/bin/dbstart $ORACLE_HOME &
        ;;
'stop')
        $ORACLE_HOME/bin/dbshut $ORACLE_HOME &
        rm -f /var/lock/subsys/dbora
        ;;
*)
        echo "usage: $0 {start|stop}"
        exit
        ;;
esac
#
exit
--------------------------- dbora ----------------------------

Reference
http://docs.oracle.com/database/121/UNXAR/strt_stp.htm#UNXAR002
https://oracle-base.com/articles/linux/automating-database-startup-and-shutdown-on-linux#Top
--------------------------------------------------------------------------------------------------------------------------
Automating Data Guard Database Startup and Shutdown on Linux

By default, when standby is startup, it is in read-only with apply mode which requires ADG license. It need to be made in mounted recovery mode.
The pdb(gisp) by default will be in mount state. 

By default, when the primary is startup, it is in read write mode, but the pdb(gisp) by default in mount state. 
It needs to be made in read write mode.

May need below logic 


-- In CDB, create below trigger to startup GISP database if it's not yet.
CREATE OR REPLACE TRIGGER startup_gisp_on_role_change
AFTER db_role_change on database
  v_role VARCHAR2(20);
  v_mode varchar2(20);
BEGIN
  select DATABASE_ROLE into v_role from V$DATABASE;
  if v_role = 'PRIMARY' then
    select open_mode into v_mode from v$pdbs where name='GISP';
    if v_mode <> 'READ WRITE' then
      EXECUTE IMMEDIATE 'ALTER PLUGGABLE DATABASE GISP OPEN READ WRITE';
	end if;
  end if;
END;
/


# open_dg.sql
begin 
declare 
  v_role VARCHAR(30);
BEGIN
  select DATABASE_ROLE into v_role from V$DATABASE;
  if v_role = 'PRIMARY' then
	EXECUTE IMMEDIATE 'ALTER DATABASE OPEN';
	EXECUTE IMMEDIATE 'ALTER PLUGGABLE DATABASE GISP OPEN READ WRITE';
  else
    EXECUTE IMMEDIATE 'ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT FROM SESSION'; 
  end if;
END;
/

# Start Database
sqlplus / as sysdba << EOF
STARTUP MOUNT;
@open_dg.sql
EXIT;
EOF

--------------------------------------------------------------------------------------------------------------------------

How to backup the recovery catalog?

Follow below guideline on setting up the backup of recovery catalog

Run the recovery catalog database in ARCHIVELOG mode so that you can do point-in-time recovery if needed.
Set the retention policy to a REDUNDANCY value greater than 1.
Back up the database to two separate media (for example, disk and tape).
Run BACKUP DATABASE PLUS ARCHIVELOG at regular intervals, to a media manager if available, or just to disk.
Do not use another recovery catalog as the repository for the backups.
Configure the control file autobackup feature to ON.

CONFIGURE RETENTION POLICY TO REDUNDANCY 7;
CONFIGURE CONTROLFILE AUTOBACKUP ON;

Note: A redundancy-based retention policy specifies how many backups of each datafile must be retained.

Turn on flashback database for the recovery catalog.
As the catalog backup won't be large, let's keep 7 copies of it.
The backup will be scheduled after the backup of DG environment.
Let's use the DG(standby) to store the offline copies.
Automate the backup and housekeeping jobs.

ALTER SYSTEM SET UNDO_RETENTION=3600 SCOPE=SPFILE;
ALTER SYSTEM SET UNDO_MANAGEMENT='AUTO' SCOPE=SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
SHOW PARAMETER UNDO;
-- Flashback retention target in minute. 4320 = 3 days
ALTER SYSTEM SET DB_FLASHBACK_RETENTION_TARGET=4320 SCOPE=BOTH;
ALTER DATABASE ARCHIVELOG;
ALTER SYSTEM SET db_recovery_file_dest_size=10G;
ALTER SYSTEM SET db_recovery_file_dest='/u01/app/oracle/fast_recovery_area';
ALTER DATABASE FLASHBACK ON;
ALTER DATABASE OPEN;


--------------------------------------------------------------------------------------------------------------------------
How to restore/recover a datafile in pluggable database in DG primary env?

Let's demo how to restore the /u02/oradata/cdb2/gisp/gisp_users01.dbf datafile in the gisp PDB.
This gisp_users01.dbf is under the USERS tablespace in GISP pdb.

Let's corrupt/delete the datafile first, in this case, I rename it to gisp_users01_bak.dbf
mv /u02/oradata/cdb2/gisp/gisp_users01.dbf /u02/oradata/cdb2/gisp/gisp_users01_bak.dbf

Now, try to create a table on this tablespace to simulate error

alter session set container=gisp;
create table test (a int) tablespace USERS;
insert into test values(1);

ORA-01116: error in opening database file 9
ORA-01110: data file 9: '/u02/oradata/cdb2/gisp/gisp_users01.dbf'
ORA-27041: unable to open file
Linux-x86_64 Error: 2: No such file or directory

It is fine as expected. So, let's restore the datafile. The file# can be retrieved from v$datafile 
which stores all datafiles in both CDB and PDBs. Each has a unique file#.

rman target / catalog rmancat/rmancat@orcl
alter database datafile 9 offline;
restore datafile 9;
recover datafile 9;
alter database datafile 9 online;

Try the insert again after the restore/recover
SQL> insert into test values(1);

1 row created.

In the DG log, it shows "One or more user data files are missing on this database".
But the dgmgrl show healthy status. The recovery does not affects the DG env. 
The inserted record can be transported/applied in standby.


Note: Because datafile offline will trigger FSFO. If it is the case, then the old primary need reinstate. But it requires 
restore the datafile 9 first before reinstate database. Otherwise, the reinstate failed with Error: ORA-16653: failed to reinstate database.

How to reinstate the old Primary as a Standby after Failover in #Oracle
https://uhesse.com/2016/09/21/how-to-reinstate-the-old-primary-as-a-standby-after-failover-in-oracle/

--------------------------------------------------------------------------------------------------------------------------
How to restore/recover a loss controlfile in DG primary env?

Assumped that there are two copies of controlfile.

Let's corrupt one of the controlfile first in primary. Right now, there are two as follows:
/u02/oradata/cdb1/control01.ctl
/u02/fast_recovery_area/cdb1/control02.ctl

cat /dev/null > /u02/fast_recovery_area/cdb1/control02.ctl

Well, the alert log will detect "ORA-00227: corrupt block detected in control file: (block , # blocks )" and FSFO triggered because abnormal shutdown.
Now, let's startup old primary in mount mode to reinstate the old primary. Cannot do it becasue in alert log it shows "ORA-00205: error in identifying control file, check alert log for more info". Okay, let's copy the good copy

cp -p /u02/oradata/cdb1/control01.ctl /u02/fast_recovery_area/cdb1/control02.ctl

and then startup mount again. Then we reinstate the old primary.
--------------------------------------------------------------------------------------------------------------------------
How to restore/recover a loss redo in DG primary env?

Assumped that there are two copies of redo in each group. Current redo and standby redo log groups as follows:

    GROUP# STATUS     TYPE    MEMBER                                   IS_     CON_ID
---------- ---------- ------- ---------------------------------------- --- ----------
         1            ONLINE  /u02/oradata/cdb1/redo01a.log            NO           0
         2            ONLINE  /u02/oradata/cdb1/redo02a.log            NO           0
         3            ONLINE  /u02/oradata/cdb1/redo03a.log            NO           0
         1            ONLINE  /u02/fast_recovery_area/cdb1/redo01b.log NO           0
         9            STANDBY /u02/oradata/cdb1/srl01.log              NO           0
        10            STANDBY /u02/oradata/cdb1/srl02.log              NO           0
        11            STANDBY /u02/oradata/cdb1/srl03.log              NO           0
        12            STANDBY /u02/oradata/cdb1/srl04.log              NO           0
         2            ONLINE  /u02/fast_recovery_area/cdb1/redo02b.log NO           0
         3            ONLINE  /u02/fast_recovery_area/cdb1/redo03b.log NO           0


Let's corrupt following redo logs and see what happen... The default FSFO won't trigger FSFO on redo failure.

cat /dev/null > /u02/fast_recovery_area/cdb1/redo01b.log
cat /dev/null > /u02/fast_recovery_area/cdb1/redo02b.log
cat /dev/null > /u02/fast_recovery_area/cdb1/redo03b.log

Note, you can also delete them, rather corrupt them. The result is the same.
rm /u02/fast_recovery_area/cdb1/redo01b.log
rm /u02/fast_recovery_area/cdb1/redo02b.log
rm /u02/fast_recovery_area/cdb1/redo03b.log

Well, the alert log show redo error in the affected redo logs. But they did not affect the database operations.

Let's do a switchover to cdb2 and then fix the redo logs.

switchover to cdb2

After the switchover, let's shutdown the standby (cdb1) and then copy the good rede logs  and then startup mount again.

shutdown immediate;

cp -p /u02/oradata/cdb1/redo01a.log /u02/fast_recovery_area/cdb1/redo01b.log
cp -p /u02/oradata/cdb1/redo02a.log /u02/fast_recovery_area/cdb1/redo02b.log
cp -p /u02/oradata/cdb1/redo03a.log /u02/fast_recovery_area/cdb1/redo03b.log

startup mount;

Now, let's switchover back to cdb1

switchover to cdb1

Now, perform a few logfile switch and make sure no redo logfile error in alert log.

alter system switch logfile;
alter system switch logfile;
alter system switch logfile;
alter system switch logfile;

Let's let test the extreme case, delete all redo logfiles to see what happens...

rm /u02/oradata/cdb1/redo01a.log
rm /u02/oradata/cdb1/redo02a.log
rm /u02/oradata/cdb1/redo03a.log
rm /u02/fast_recovery_area/cdb1/redo01b.log
rm /u02/fast_recovery_area/cdb1/redo02b.log
rm /u02/fast_recovery_area/cdb1/redo03b.log

After some time, the database will hang, select statement, log switch etc will failed. Extract like below in alert log...The instance got shut down... and FSFO triggered.

Errors in file /u01/app/oracle/diag/rdbms/cdb1/cdb1/trace/cdb1_arc2_1733.trc:
ORA-00313: open failed for members of log group 1 of thread 1
ORA-00312: online log 1 thread 1: '/u02/oradata/cdb1/redo01a.log'
ORA-27041: unable to open file
Linux-x86_64 Error: 2: No such file or directory
Additional information: 3
ORA-00312: online log 1 thread 1: '/u02/fast_recovery_area/cdb1/redo01b.log'
ORA-27041: unable to open file
Linux-x86_64 Error: 2: No such file or directory
Additional information: 3
Master background archival failure: 313

Fri May 05 16:02:21 2017
Instance terminated by USER, pid = 1633
Fri May 05 16:02:21 2017
Errors in file /u01/app/oracle/diag/rdbms/cdb1/cdb1/trace/cdb1_pmon_1633.trc:
ORA-27300: OS system dependent operation:semctl failed with status: 22
ORA-27301: OS failure message: Invalid argument
ORA-27302: failure occurred at: sskgpwrm1
ORA-27157: OS post/wait facility removed
ORA-27300: OS system dependent operation:semop failed with status: 43
ORA-27301: OS failure message: Identifier removed
ORA-27302: failure occurred at: sskgpwwait1


DGMGRL> show configuration verbose

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    Warning: ORA-16817: unsynchronized fast-start failover configuration

    cdb1 - (*) Physical standby database (disabled)
      ORA-16661: the standby database needs to be reinstated

  (*) Fast-Start Failover target


Ok, let do a reinstate of the old primary. First startup mount old primary first...

startup mount;

As the redo logfiles have been deleted, we need to restore and recover the database first... Just no way to recover the standby.
The only way is to re-create the standby. Please refer to "How to re-create physical standby database?".

--------------------------------------------------------------------------------------------------------------------------
Can manual failover occur if unsynchronized or lag behind?

--------------------------------------------------------------------------------------------------------------------------
How to stop the observer when primary and standby are isolated?

1. Login to the standby machine 
2. disable fast_start failover FORCE
3. stop observer

Note: If the observer is stopped abnormally (for example, by typing CTRL/C), restart it and reference the existing fsfo.dat file with the FILE qualifier.

--------------------------------------------------------------------------------------------------------------------------
How to shutdown databases in FSFO env?

1. Stop the observer. Wait until FS_FAILOVER_OBSERVER_PRESENT = "NO" for both the primary and target standby databases. 
2. Shut down the primary/standby database

--------------------------------------------------------------------------------------------------------------------------
How to startp primary due to FRA is full?

Primary won't start if FRA is full. Need to clear up space in RMAN first.

-- startup the primary in mount mode --
startup mount;
-- connect to rman to clear backups/archivelogs to free space
report obsolete;
LIST EXPIRED backup;
LIST EXPIRED archivelog all;
delete noprompt force expired backup;
delete noprompt force expired archivelog all;
delete noprompt force obsolete;
-- crosscheck to refresh 
crosscheck archivelog all;
crosscheck backup;
-- startup the primary
alter database open;
--------------------------------------------------------------------------------------------------------------------------
ORA-16649 "possible failover to another database prevents this database from being opened" on opening primary

Versions 11.2, 12.1

Error:  ORA-16649 possible failover to another database prevents this database from being opened 
---------------------------------------------------------------------------
Cause:  An attempt to open the primary database was made either after a 
	failover occurred, or when it was likely to have occurred as the result 
	of the primary being isolated from the fast-start failover target 
	standby database and from the fast-start failover observer. 
Action: Check if a failover did occur. If fast-start failover is enabled, and 
	a failover did not occur, ensure that connectivity exists between the 
	primary database and either the observer or the target standby 
	database. Then, try opening the database again. 
	
--------------------------------------------------------------------------------------------------------------------------
How to re-create physical standby database?


-- Shutdown the standby cdb2
shutdown immediate;

-- disable DG configuration
DGMGRL> disable configuration
Disabled.

-- Remove the original DG configuration
DGMGRL> remove configuration
Removed configuration


-- rman target / to cdb1 to delete existing backups first
rman target /
delete backup;

-- Then do a backup in cdb1
backup database plus archivelog;

-- Startup cdb2 as follows. initcdb2.ora only contains one line "DB_NAME=cdb1"
startup nomount pfile=/u01/app/oracle/product/12.1.0.2/db_1/dbs/initcdb2.ora

-- in cdb1, duplicate the standby using rman. Note the db_create_file_dest and db_recovery_file_dest should be changed.
export ORACLE_SID=cdb1
[oracle@dg1 setup_dg]$ rman<<EOF
> connect target sys/oracle
> connect auxiliary sys/oracle@cdb2
> @rman.txt
> EOF

Recovery Manager: Release 12.1.0.2.0 - Production on Wed Jun 15 10:54:09 2016

Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights reserved.

RMAN>
connected to target database: CDB1 (DBID=883395141)

RMAN>
connected to auxiliary database: CDB2 (not mounted)

RMAN>
RMAN> run {
2> duplicate target database for standby from active database
3> dorecover
4> spfile
5> parameter_value_convert 'cdb1','cdb2'
6> set db_unique_name='cdb2'
7> set db_recovery_file_dest='/u02/fast_recovery_area'
8> set db_file_name_convert='/cdb1/','/cdb2/'
9> set log_file_name_convert='/cdb1/','/cdb2/'
10> set log_archive_max_processes='5'
11> set fal_client='cdb2'
12> set fal_server='cdb1'
13> set standby_file_management='AUTO'
14> set log_archive_config='dg_config=(cdb1,cdb2)'
15> set log_archive_dest_2='service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'
16> ;
17> }
Starting Duplicate Db at 15-JUN-16
using target database control file instead of recovery catalog
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=14 device type=DISK
current log archived

contents of Memory Script:
{
   backup as copy reuse
   targetfile  '/u01/app/oracle/product/12.1.0.2/db_1/dbs/orapwcdb1' auxiliary format
 '/u01/app/oracle/product/12.1.0.2/db_1/dbs/orapwcdb2'   targetfile
 '/u01/app/oracle/product/12.1.0.2/db_1/dbs/spfilecdb1.ora' auxiliary format
 '/u01/app/oracle/product/12.1.0.2/db_1/dbs/spfilecdb2.ora'   ;
   sql clone "alter system set spfile= ''/u01/app/oracle/product/12.1.0.2/db_1/dbs/spfilecdb2.ora''";
}
executing Memory Script

Starting backup at 15-JUN-16
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=799 device type=DISK
Finished backup at 15-JUN-16

sql statement: alter system set spfile= ''/u01/app/oracle/product/12.1.0.2/db_1/dbs/spfilecdb2.ora''

contents of Memory Script:
{
   sql clone "alter system set  audit_file_dest =
 ''/u01/app/oracle/admin/cdb2/adump'' comment=
 '''' scope=spfile";
   sql clone "alter system set  control_files =
 ''/u02/oradata/cdb2/control01.ctl'', ''/u02/fast_recovery_area/cdb2/control02.ctl'' comment=
 '''' scope=spfile";
   sql clone "alter system set  dispatchers =
 ''(PROTOCOL=TCP) (SERVICE=cdb2XDB)'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_unique_name =
 ''cdb2'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_recovery_file_dest =
 ''/u02/fast_recovery_area'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_file_name_convert =
 ''/cdb1/'', ''/cdb2/'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_file_name_convert =
 ''/cdb1/'', ''/cdb2/'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_archive_max_processes =
 5 comment=
 '''' scope=spfile";
   sql clone "alter system set  fal_client =
 ''cdb2'' comment=
 '''' scope=spfile";
   sql clone "alter system set  fal_server =
 ''cdb1'' comment=
 '''' scope=spfile";
   sql clone "alter system set  standby_file_management =
 ''AUTO'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_archive_config =
 ''dg_config=(cdb1,cdb2)'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_archive_dest_2 =
 ''service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'' comment=
 '''' scope=spfile";
   shutdown clone immediate;
   startup clone nomount;
}
executing Memory Script

sql statement: alter system set  audit_file_dest =  ''/u01/app/oracle/admin/cdb2/adump'' comment= '''' scope=spfile

sql statement: alter system set  control_files =  ''/u02/oradata/cdb2/control01.ctl'', ''/u02/fast_recovery_area/cdb2/control02.ctl'' comment= '''' scope=spfile

sql statement: alter system set  dispatchers =  ''(PROTOCOL=TCP) (SERVICE=cdb2XDB)'' comment= '''' scope=spfile

sql statement: alter system set  db_unique_name =  ''cdb2'' comment= '''' scope=spfile

sql statement: alter system set  db_recovery_file_dest =  ''/u02/fast_recovery_area'' comment= '''' scope=spfile

sql statement: alter system set  db_file_name_convert =  ''/cdb1/'', ''/cdb2/'' comment= '''' scope=spfile

sql statement: alter system set  log_file_name_convert =  ''/cdb1/'', ''/cdb2/'' comment= '''' scope=spfile

sql statement: alter system set  log_archive_max_processes =  5 comment= '''' scope=spfile

sql statement: alter system set  fal_client =  ''cdb2'' comment= '''' scope=spfile

sql statement: alter system set  fal_server =  ''cdb1'' comment= '''' scope=spfile

sql statement: alter system set  standby_file_management =  ''AUTO'' comment= '''' scope=spfile

sql statement: alter system set  log_archive_config =  ''dg_config=(cdb1,cdb2)'' comment= '''' scope=spfile

sql statement: alter system set  log_archive_dest_2 =  ''service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'' comment= '''' scope=spfile

Oracle instance shut down

connected to auxiliary database (not started)
Oracle instance started

Total System Global Area    1073741824 bytes

Fixed Size                     2932632 bytes
Variable Size                645922920 bytes
Database Buffers             415236096 bytes
Redo Buffers                   9650176 bytes

contents of Memory Script:
{
   backup as copy current controlfile for standby auxiliary format  '/u02/oradata/cdb2/control01.ctl';
   restore clone primary controlfile to  '/u02/fast_recovery_area/cdb2/control02.ctl' from
 '/u02/oradata/cdb2/control01.ctl';
}
executing Memory Script

Starting backup at 15-JUN-16
using channel ORA_DISK_1
channel ORA_DISK_1: starting datafile copy
copying standby control file
output file name=/u01/app/oracle/product/12.1.0.2/db_1/dbs/snapcf_cdb1.f tag=TAG20160615T105434
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:03
Finished backup at 15-JUN-16

Starting restore at 15-JUN-16
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=14 device type=DISK

channel ORA_AUX_DISK_1: copied control file copy
Finished restore at 15-JUN-16

contents of Memory Script:
{
   sql clone 'alter database mount standby database';
}
executing Memory Script

sql statement: alter database mount standby database

contents of Memory Script:
{
   set newname for tempfile  1 to
 "/u02/oradata/cdb2/temp01.dbf";
   set newname for tempfile  2 to
 "/u02/oradata/cdb2/pdbseed/temp01.dbf";
   set newname for tempfile  3 to
 "/u02/oradata/cdb2/gisp/temp01.dbf";
   switch clone tempfile all;
   set newname for datafile  1 to
 "/u02/oradata/cdb2/system01.dbf";
   set newname for datafile  2 to
 "/u02/oradata/cdb2/pdbseed/system01.dbf";
   set newname for datafile  3 to
 "/u02/oradata/cdb2/sysaux01.dbf";
   set newname for datafile  4 to
 "/u02/oradata/cdb2/pdbseed/sysaux01.dbf";
   set newname for datafile  5 to
 "/u02/oradata/cdb2/undotbs01.dbf";
   set newname for datafile  6 to
 "/u02/oradata/cdb2/users01.dbf";
   set newname for datafile  7 to
 "/u02/oradata/cdb2/gisp/system01.dbf";
   set newname for datafile  8 to
 "/u02/oradata/cdb2/gisp/sysaux01.dbf";
   set newname for datafile  9 to
 "/u02/oradata/cdb2/gisp/gisp_users01.dbf";
   set newname for datafile  10 to
 "/u02/oradata/cdb2/gisp/SDE01.DBF";
   set newname for datafile  11 to
 "/u02/oradata/cdb2/gisp/ekeapp01.DBF";
   set newname for datafile  12 to
 "/u02/oradata/cdb2/gisp/scapp01.DBF";
   set newname for datafile  13 to
 "/u02/oradata/cdb2/gisp/test01.DBF";
   backup as copy reuse
   datafile  1 auxiliary format
 "/u02/oradata/cdb2/system01.dbf"   datafile
 2 auxiliary format
 "/u02/oradata/cdb2/pdbseed/system01.dbf"   datafile
 3 auxiliary format
 "/u02/oradata/cdb2/sysaux01.dbf"   datafile
 4 auxiliary format
 "/u02/oradata/cdb2/pdbseed/sysaux01.dbf"   datafile
 5 auxiliary format
 "/u02/oradata/cdb2/undotbs01.dbf"   datafile
 6 auxiliary format
 "/u02/oradata/cdb2/users01.dbf"   datafile
 7 auxiliary format
 "/u02/oradata/cdb2/gisp/system01.dbf"   datafile
 8 auxiliary format
 "/u02/oradata/cdb2/gisp/sysaux01.dbf"   datafile
 9 auxiliary format
 "/u02/oradata/cdb2/gisp/gisp_users01.dbf"   datafile
 10 auxiliary format
 "/u02/oradata/cdb2/gisp/SDE01.DBF"   datafile
 11 auxiliary format
 "/u02/oradata/cdb2/gisp/ekeapp01.DBF"   datafile
 12 auxiliary format
 "/u02/oradata/cdb2/gisp/scapp01.DBF"   datafile
 13 auxiliary format
 "/u02/oradata/cdb2/gisp/test01.DBF"   ;
   sql 'alter system archive log current';
}
executing Memory Script

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

renamed tempfile 1 to /u02/oradata/cdb2/temp01.dbf in control file
renamed tempfile 2 to /u02/oradata/cdb2/pdbseed/temp01.dbf in control file
renamed tempfile 3 to /u02/oradata/cdb2/gisp/temp01.dbf in control file

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

Starting backup at 15-JUN-16
using channel ORA_DISK_1
channel ORA_DISK_1: starting datafile copy
input datafile file number=00003 name=/u02/oradata/cdb1/sysaux01.dbf
output file name=/u02/oradata/cdb2/sysaux01.dbf tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:01:35
channel ORA_DISK_1: starting datafile copy
input datafile file number=00001 name=/u02/oradata/cdb1/system01.dbf
output file name=/u02/oradata/cdb2/system01.dbf tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:01:05
channel ORA_DISK_1: starting datafile copy
input datafile file number=00008 name=/u02/oradata/cdb1/gisp/sysaux01.dbf
output file name=/u02/oradata/cdb2/gisp/sysaux01.dbf tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:01:15
channel ORA_DISK_1: starting datafile copy
input datafile file number=00004 name=/u02/oradata/cdb1/pdbseed/sysaux01.dbf
output file name=/u02/oradata/cdb2/pdbseed/sysaux01.dbf tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:01:05
channel ORA_DISK_1: starting datafile copy
input datafile file number=00005 name=/u02/oradata/cdb1/undotbs01.dbf
output file name=/u02/oradata/cdb2/undotbs01.dbf tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:45
channel ORA_DISK_1: starting datafile copy
input datafile file number=00011 name=/u02/oradata/cdb1/gisp/ekeapp01.DBF
output file name=/u02/oradata/cdb2/gisp/ekeapp01.DBF tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:45
channel ORA_DISK_1: starting datafile copy
input datafile file number=00012 name=/u02/oradata/cdb1/gisp/scapp01.DBF
output file name=/u02/oradata/cdb2/gisp/scapp01.DBF tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:55
channel ORA_DISK_1: starting datafile copy
input datafile file number=00010 name=/u02/oradata/cdb1/gisp/SDE01.DBF
output file name=/u02/oradata/cdb2/gisp/SDE01.DBF tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:35
channel ORA_DISK_1: starting datafile copy
input datafile file number=00007 name=/u02/oradata/cdb1/gisp/system01.dbf
output file name=/u02/oradata/cdb2/gisp/system01.dbf tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:25
channel ORA_DISK_1: starting datafile copy
input datafile file number=00002 name=/u02/oradata/cdb1/pdbseed/system01.dbf
output file name=/u02/oradata/cdb2/pdbseed/system01.dbf tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:25
channel ORA_DISK_1: starting datafile copy
input datafile file number=00006 name=/u02/oradata/cdb1/users01.dbf
output file name=/u02/oradata/cdb2/users01.dbf tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:03
channel ORA_DISK_1: starting datafile copy
input datafile file number=00013 name=/u02/oradata/cdb1/gisp/test01.DBF
output file name=/u02/oradata/cdb2/gisp/test01.DBF tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:03
channel ORA_DISK_1: starting datafile copy
input datafile file number=00009 name=/u02/oradata/cdb1/gisp/gisp_users01.dbf
output file name=/u02/oradata/cdb2/gisp/gisp_users01.dbf tag=TAG20160615T105446
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:01
Finished backup at 15-JUN-16

sql statement: alter system archive log current
current log archived

contents of Memory Script:
{
   backup as copy reuse
   archivelog like  "/u02/fast_recovery_area/CDB1/archivelog/2016_06_15/o1_mf_1_257_cp1jvtcm_.arc" auxiliary format
 "/u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_257_%u_.arc"   archivelog like
 "/u02/fast_recovery_area/CDB1/archivelog/2016_06_15/o1_mf_1_258_cp1kdkmd_.arc" auxiliary format
 "/u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_258_%u_.arc"   archivelog like
 "/u02/fast_recovery_area/CDB1/archivelog/2016_06_15/o1_mf_1_259_cp1kdkz6_.arc" auxiliary format
 "/u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_259_%u_.arc"   ;
   catalog clone recovery area;
   switch clone datafile all;
}
executing Memory Script

Starting backup at 15-JUN-16
using channel ORA_DISK_1
channel ORA_DISK_1: starting archived log copy
input archived log thread=1 sequence=258 RECID=1017 STAMP=914583825
output file name=/u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_258_9er86s8i_.arc RECID=0 STAMP=0
channel ORA_DISK_1: archived log copy complete, elapsed time: 00:00:01
channel ORA_DISK_1: starting archived log copy
input archived log thread=1 sequence=257 RECID=1016 STAMP=914583290
output file name=/u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_257_9fr86s8j_.arc RECID=0 STAMP=0
channel ORA_DISK_1: archived log copy complete, elapsed time: 00:00:01
channel ORA_DISK_1: starting archived log copy
input archived log thread=1 sequence=259 RECID=1018 STAMP=914583826
output file name=/u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_259_9gr86s8k_.arc RECID=0 STAMP=0
channel ORA_DISK_1: archived log copy complete, elapsed time: 00:00:01
Finished backup at 15-JUN-16

searching for all files in the recovery area

List of Files Unknown to the Database
=====================================
File Name: /u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_257_9fr86s8j_.arc
File Name: /u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_259_9gr86s8k_.arc
File Name: /u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_258_9er86s8i_.arc
cataloging files...
cataloging done

List of Cataloged Files
=======================
File Name: /u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_257_9fr86s8j_.arc
File Name: /u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_259_9gr86s8k_.arc
File Name: /u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_258_9er86s8i_.arc

datafile 1 switched to datafile copy
input datafile copy RECID=1 STAMP=914583829 file name=/u02/oradata/cdb2/system01.dbf
datafile 2 switched to datafile copy
input datafile copy RECID=2 STAMP=914583829 file name=/u02/oradata/cdb2/pdbseed/system01.dbf
datafile 3 switched to datafile copy
input datafile copy RECID=3 STAMP=914583829 file name=/u02/oradata/cdb2/sysaux01.dbf
datafile 4 switched to datafile copy
input datafile copy RECID=4 STAMP=914583829 file name=/u02/oradata/cdb2/pdbseed/sysaux01.dbf
datafile 5 switched to datafile copy
input datafile copy RECID=5 STAMP=914583829 file name=/u02/oradata/cdb2/undotbs01.dbf
datafile 6 switched to datafile copy
input datafile copy RECID=6 STAMP=914583829 file name=/u02/oradata/cdb2/users01.dbf
datafile 7 switched to datafile copy
input datafile copy RECID=7 STAMP=914583829 file name=/u02/oradata/cdb2/gisp/system01.dbf
datafile 8 switched to datafile copy
input datafile copy RECID=8 STAMP=914583829 file name=/u02/oradata/cdb2/gisp/sysaux01.dbf
datafile 9 switched to datafile copy
input datafile copy RECID=9 STAMP=914583829 file name=/u02/oradata/cdb2/gisp/gisp_users01.dbf
datafile 10 switched to datafile copy
input datafile copy RECID=10 STAMP=914583829 file name=/u02/oradata/cdb2/gisp/SDE01.DBF
datafile 11 switched to datafile copy
input datafile copy RECID=11 STAMP=914583829 file name=/u02/oradata/cdb2/gisp/ekeapp01.DBF
datafile 12 switched to datafile copy
input datafile copy RECID=12 STAMP=914583829 file name=/u02/oradata/cdb2/gisp/scapp01.DBF
datafile 13 switched to datafile copy
input datafile copy RECID=13 STAMP=914583830 file name=/u02/oradata/cdb2/gisp/test01.DBF

contents of Memory Script:
{
   set until scn  14489614;
   recover
   standby
   clone database
    delete archivelog
   ;
}
executing Memory Script

executing command: SET until clause

Starting recover at 15-JUN-16
using channel ORA_AUX_DISK_1

starting media recovery

archived log for thread 1 with sequence 257 is already on disk as file /u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_257_9fr86s8j_.arc
archived log for thread 1 with sequence 258 is already on disk as file /u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_258_9er86s8i_.arc
archived log for thread 1 with sequence 259 is already on disk as file /u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_259_9gr86s8k_.arc
archived log file name=/u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_257_9fr86s8j_.arc thread=1 sequence=257
archived log file name=/u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_258_9er86s8i_.arc thread=1 sequence=258
archived log file name=/u02/fast_recovery_area/CDB2/archivelog/2016_06_15/o1_mf_1_259_9gr86s8k_.arc thread=1 sequence=259
media recovery complete, elapsed time: 00:00:02
Finished recover at 15-JUN-16
Finished Duplicate Db at 15-JUN-16

RMAN>
RMAN> **end-of-file**

RMAN>

Recovery Manager complete.


-- In standby, start the redo apply
SQL> alter database recover managed standby database using current logfile disconnect;

-- The cdb1 log_archive_dest_state_2 was found "RESET", so need to enable for redo transport to work.
SQL> ALTER SYSTEM SET log_archive_dest_state_2='ENABLE' SCOPE=BOTH;

-- Turn on flashback on both db if not already

-- In Primary and Standby databases, run below command to clear the dest before creating config in DG broker.
alter system set log_archive_dest_2='';


-- Add DG config.
dgmgrl <<EOF
connect sys/oracle@cdb1
create configuration 'DGCONFIG' as primary database is 'cdb1' connect identifier is cdb1;
add database 'cdb2' as connect identifier is cdb2;
enable configuration;
EOF
sqlplus sys/oracle@cdb1 as sysdba <<EOF
alter system set log_archive_dest_2='service=cdb2 async valid_for=(online_logfile,primary_role) db_unique_name=cdb2';
EOF

-- Set fsfo property
dgmgrl <<EOF
connect sys/oracle@cdb1
edit database cdb1 set property FastStartFailoverTarget=cdb2;
edit database cdb2 set property FastStartFailoverTarget=cdb1;
EOF

-- check config
DGMGRL> show configuration

  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    Warning: ORA-16629: database reports a different protection level from the protection mode
    cdb2 - Physical standby database


DGMGRL> show database verbose cdb1
  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1

	Database Warning(s):
    ORA-16629: database reports a different protection level from the protection mode

  Properties:
    DGConnectIdentifier             = 'cdb1'
    ObserverConnectIdentifier       = ''
    LogXptMode                      = 'SYNC'      
    RedoRoutes                      = ''
	
DGMGRL> show database verbose cdb2
Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      0 seconds (computed 1 second ago)
  Apply Lag:          0 seconds (computed 1 second ago)
  Average Apply Rate: 1.00 KByte/s
  Active Apply Rate:  0 Byte/s
  Maximum Apply Rate: 0 Byte/s
  Real Time Query:    ON
  Instance(s):
    cdb2

  Properties:
    DGConnectIdentifier             = 'cdb2'
    ObserverConnectIdentifier       = ''
    LogXptMode                      = 'ASYNC'        <---- Should be SYNC
    RedoRoutes                      = ''

-- Change cdb2 logxptmode to SYNC because it was set to 'ASYNC' in the rman.txt
DGMGRL> edit database cdb2 set property 'LogXptMode'='SYNC';
Property "LogXptMode" updated

-- Everything is fine. The DG config is re-created and the DG is normal.
DGMGRL> show configuration
  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    cdb2 - Physical standby database
Fast-Start Failover: DISABLED
Configuration Status:
SUCCESS   (status updated 2 seconds ago)



--------------------------------------------------------------------------------------------------------------------------
How to allow oracle user to execute root command using sudo?

# visudo
## Allows people in group wheel to run all commands
%wheel        ALL=(ALL)       ALL

# usermod -aG wheel oracle

https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux_OpenStack_Platform/2/html/Getting_Started_Guide/ch02s03.html

--------------------------------------------------------------------------------------------------------------------------
How to add/drop logfile memeber?

Logon to the database

-- To add logfile member to group
ALTER DATABASE ADD LOGFILE MEMBER '/u02/fast_recovery_area/cdb1/redo01b.log' TO GROUP 1;
ALTER DATABASE ADD LOGFILE MEMBER '/u02/fast_recovery_area/cdb1/redo02b.log' TO GROUP 2;
ALTER DATABASE ADD LOGFILE MEMBER '/u02/fast_recovery_area/cdb1/redo03b.log' TO GROUP 3;

-- Perform a few log switches to make the newly added logfile member VALID.
alter system switch logfile;
alter system switch logfile;
alter system switch logfile;

-- Drop logfile member. Need to perform a log switch if it is current.
ALTER DATABASE DROP LOGFILE MEMBER '/u02/oradata/cdb1/redo01.log';
ALTER DATABASE DROP LOGFILE MEMBER '/u02/oradata/cdb1/redo02.log';
ALTER DATABASE DROP LOGFILE MEMBER '/u02/oradata/cdb1/redo03.log';

-- To add logfile member to group
ALTER DATABASE ADD LOGFILE MEMBER '/u02/oradata/cdb1/redo01a.log' TO GROUP 1;
ALTER DATABASE ADD LOGFILE MEMBER '/u02/oradata/cdb1/redo02a.log' TO GROUP 2;
ALTER DATABASE ADD LOGFILE MEMBER '/u02/oradata/cdb1/redo03a.log' TO GROUP 3;

-- Perform a few log switches to make the newly added logfile member VALID.
alter system switch logfile;
alter system switch logfile;
alter system switch logfile;

SQL> @redo
#####################################################################################
# Redo log information
#####################################################################################

    GROUP#    THREAD#  SEQUENCE#      BYTES  BLOCKSIZE    MEMBERS ARC STATUS     FIRST_CHANGE# FIRST_TIME         NEXT_CHANGE# NEXT_TIME                CON_ID
---------- ---------- ---------- ---------- ---------- ---------- --- ---------- ------------- ------------------- ------------ ------------------- ----------
         1          1        255   52428800        512          2 YES INACTIVE        14484817 15-06-2016 10:28:01     14484824 15-06-2016 10:28:04          0
         2          1        256   52428800        512          2 NO  CURRENT         14484824 15-06-2016 10:28:04   2.8147E+14                              0
         3          1        254   52428800        512          2 YES INACTIVE        14484810 15-06-2016 10:27:58     14484817 15-06-2016 10:28:01          0


    GROUP# STATUS     TYPE    MEMBER                                   IS_     CON_ID
---------- ---------- ------- ---------------------------------------- --- ----------
         1            ONLINE  /u02/oradata/cdb1/redo01a.log            NO           0
         2            ONLINE  /u02/oradata/cdb1/redo02a.log            NO           0
         3            ONLINE  /u02/oradata/cdb1/redo03a.log            NO           0
         1            ONLINE  /u02/fast_recovery_area/cdb1/redo01b.log NO           0
         9            STANDBY /u02/oradata/cdb1/srl01.log              NO           0
        10            STANDBY /u02/oradata/cdb1/srl02.log              NO           0
        11            STANDBY /u02/oradata/cdb1/srl03.log              NO           0
        12            STANDBY /u02/oradata/cdb1/srl04.log              NO           0
         2            ONLINE  /u02/fast_recovery_area/cdb1/redo02b.log NO           0
         3            ONLINE  /u02/fast_recovery_area/cdb1/redo03b.log NO           0

Note: As recommended by Oracle, better having two logfiles per group. One should be in FRA.


--------------------------------------------------------------------------------------------------------------------------
How to send mail from Linux(fedora) through Gmail SMTP?

-- Prepare the certificates and store it in ~/.certs according to reference links.

-- How to install mailx. Log in as root
yum install mailx

-- How to check whether mailx has been installed
yum list mailx

-- To setup config in ~/.mailrc, then can send in short command line
~/.mailrc
-------------------------------
set smtp-use-starttls
set nss-config-dir=~/.certs
set ssl-verify=ignore
set smtp=smtp://smtp.gmail.com:587
set smtp-auth=login
set smtp-auth-user=fungcheung88db@gmail.com
set smtp-auth-password=govmap$3V21
set from="fungcheung88db@gmail.com(James)"
-------------------------------
echo -e "Testing content2" | mailx -v -s "Testing mail from Fedora" fungcheung88db@gmail.com

-- To send mail in one command line
echo -e "Testing..." | mailx -v -s "Testing from Fedora" -S smtp-use-starttls -S ssl-verify=ignore -S smtp-auth=login -S smtp=smtp://smtp.gmail.com:587 -S smtp-auth-user=<gmail login> -S smtp-auth-password=<gmail passwd> -S ssl-verify=ignore -S nss-config-dir=~/.certs fungcheung88@gmail.com


Reference
http://serverfault.com/questions/498588/smtp-gmail-com-from-bash-gives-error-in-certificate-peers-certificate-issuer
http://www.systutorials.com/1411/sending-email-from-mailx-command-in-linux-using-gmails-smtp/	
http://www.binarytides.com/linux-mailx-command/
https://coderwall.com/p/ez1x2w/send-mail-like-a-boss

If seeing below error, please turn on the "Access for less secure apps" option in Google setting.

smtp-server: 534-5.7.14 p6Kwo4f36CBijwwUhhoUFp-B693U_5VDFDjT772XtillHIA5QXGeju9rhQ_GT8SCjKRWYz
534-5.7.14 ufPpgjZWsqKdnaVMrhKDzGD_qv4zI> Please log in via your web browser and
smtp-server: 534-5.7.14 ufPpgjZWsqKdnaVMrhKDzGD_qv4zI> Please log in via your web browser and
534-5.7.14 then try again.
smtp-server: 534-5.7.14 then try again.
534-5.7.14  Learn more at
smtp-server: 534-5.7.14  Learn more at
534 5.7.14  https://support.google.com/mail/answer/78754 a87sm4386717pfc.63 - gsmtp
smtp-server: 534 5.7.14  https://support.google.com/mail/answer/78754 a87sm4386717pfc.63 - gsmtp
"/home/oracle/dead.letter" 11/334
. . . message not sent.

--------------------------------------------------------------------------------------------------------------------------
How to prevent "Network error: Software caused connection abort" in Putty

In connection 
"seconds between keepalives(0 to trun off)" -> 60
"Enable TCP keepalives" is checked.

--------------------------------------------------------------------------------------------------------------------------
How to detect switchover, failover, fsfo

Check below string in database alertlog for switchover
"Completed: ALTER DATABASE SWITCHOVER TO "

Check below string in database alertlog for manual failover
"Failover succeeded. Primary database is now"

Check below string in database alertlog for fsfo


==========================================================================================================================
===  Appendix
==========================================================================================================================
How to startup/shutdown the physical standby database?

The STARTUP command starts, mounts, and opens a physical standby database in read-only mode when it is invoked without any arguments.

Once mounted or opened, a physical standby database can receive redo data from the primary database.

Use the SQL*Plus SHUTDOWN command to stop Redo Apply and shut down a physical standby database. Control is not returned to the session 
that initiates a database shutdown until shutdown is complete.

If the primary database is up and running, defer the standby destination on the primary database and 
perform a log switch before shutting down the physical standby database.

edit database cdb1 set status='TRANSPORT-OFF'
alter system switch logfile;

If a license for the Oracle Active Data Guard option has not been purchased, a physical standby database cannot be open 
while Redo Apply is active, so the following rules must be observed when opening a physical standby database instance or starting Redo Apply:

Redo Apply must be stopped before any physical standby database instance is opened.
If one or more physical standby instances are open, those instances must be stopped or restarted in a mounted state before starting Redo Apply.

ok, let's try to shutdown the standby(cdb1) and see how it goes. As suggested, we need to stop redo transport first...
DGMGRL> edit database cdb2 set state='TRANSPORT-OFF';
Error: ORA-16627: operation disallowed since no standby databases would remain to support protection mode

As we are now in max availability mode, we are not allowed to do this. Need to change to max performance mode first.

Let's ignore this and see what will happen if we don't stop the redo transport in primary(cdb2). Let's just shutdown standby(cdb1)...

SQL> shutdown
ORA-16175: cannot shut down database when media recovery is active

ok, let's stop the redo apply first and then shutdown...

DGMGRL> edit database cdb1 set state='APPLY-OFF';
Succeeded.
DGMGRL> shutdown
Database closed.
Database dismounted.
ORACLE instance shut down.

Let's take a look in the dgmgrl...

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    Warning: ORA-16817: unsynchronized fast-start failover configuration

    cdb1 - (*) Physical standby database (disabled)

Fast-Start Failover: ENABLED

Configuration Status:
WARNING   (status updated 41 seconds ago)

DGMGRL> show database cdb2

Database - cdb2

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb2

  Database Warning(s):
    ORA-16817: unsynchronized fast-start failover configuration

Database Status:
WARNING

DGMGRL> show database cdb1

Database - cdb1

  Role:               PHYSICAL STANDBY
  Intended State:     OFFLINE
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb1

Database Status:
SHUTDOWN

DGMGRL>

ok, let's startup the standby in mount mode as we are not using ADG...

DGMGRL> startup mount
ORACLE instance started.
Database mounted.


DGMGRL> show configuration 

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    cdb1 - (*) Physical standby database


Configuration Status:
SUCCESS

DGMGRL> show database cdb1

Database - cdb1

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-OFF
  Transport Lag:      0 seconds (computed 0 seconds ago)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb1

Database Status:
SUCCESS

DGMGRL> show database cdb2

Database - cdb2

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb2

Database Status:
SUCCESS

[oracle@dg2 setup_dg]$ ls /u02/ora*/cdb2/CDB2/arch*/*05_05
total 105708
-rw-r-----. 1 oracle oinstall 47619584 May  5 00:27 o1_mf_1_14_cln8qtt7_.arc
-rw-r-----. 1 oracle oinstall 42681856 May  5 07:00 o1_mf_1_15_clnzqqwg_.arc
-rw-r-----. 1 oracle oinstall 16924160 May  5 10:36 o1_mf_1_16_clodfdqt_.arc
-rw-r-----. 1 oracle oinstall   495104 May  5 10:48 o1_mf_1_17_clof3v7t_.arc
-rw-r-----. 1 oracle oinstall   223744 May  5 10:54 o1_mf_1_18_clofgsh1_.arc
-rw-r-----. 1 oracle oinstall     1536 May  5 10:54 o1_mf_1_19_clofgtlg_.arc
-rw-r-----. 1 oracle oinstall   145408 May  5 10:57 o1_mf_1_20_clofn5yv_.arc
-rw-r-----. 1 oracle oinstall     3584 May  5 10:57 o1_mf_1_21_clofnc0m_.arc


[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*05_05*
total 105708
-rw-r-----. 1 oracle oinstall 47619584 May  5 00:27 o1_mf_1_14_cln8qswl_.arc
-rw-r-----. 1 oracle oinstall 42681856 May  5 07:00 o1_mf_1_15_clnzqqh7_.arc
-rw-r-----. 1 oracle oinstall 16924160 May  5 10:36 o1_mf_1_16_clodfddt_.arc
-rw-r-----. 1 oracle oinstall   495104 May  5 10:54 o1_mf_1_17_clofgsrj_.arc
-rw-r-----. 1 oracle oinstall   223744 May  5 10:54 o1_mf_1_18_clofgt1w_.arc
-rw-r-----. 1 oracle oinstall     1536 May  5 10:54 o1_mf_1_19_clofgtnj_.arc
-rw-r-----. 1 oracle oinstall   145408 May  5 10:57 o1_mf_1_20_clofn5ww_.arc
-rw-r-----. 1 oracle oinstall     3584 May  5 10:57 o1_mf_1_21_clofnc0l_.arc


well, the redos have been transported to dg1. But as the cdb1 stauts is "APPLY-OFF", the redo apply was off, 
and the latest txn is still not applied the cdb1 yet.

Let's open cdb1 in read only mode and check...

SQL> alter database open read only;

Database altered.

SQL> select * from a;

         A
----------
         1
         3
         2
         4
         5
         6
         7
         8


in cdb2, we have...		 
		 
SQL> select * from a;

         A
----------
         1
         3
         2
         4
         5
         6
         7
         8
         9
        10

10 rows selected.

		 
ok, now let's put cdb1 in mount mode again and resume the redo apply.

DGMGRL> edit database cdb1 set state='APPLY-ON';
Succeeded.

DGMGRL> show database cdb1

Database - cdb1

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      0 seconds (computed 1 second ago)
  Apply Lag:          0 seconds (computed 1 second ago)
  Average Apply Rate: 122.00 KByte/s
  Real Time Query:    OFF
  Instance(s):
    cdb1

Database Status:
SUCCESS


Well, now we can see it is on and the "Apply Lag" and "Average Apply Rate" show figures.
The "show database cdb1" shows SUCCESS status even the State is 'APPLY-OFF' for standby.

Conclusion: To shutdown standby, need to stop redo apply first, then shutdown. To startup, use startup mount 
and then resume redo apply. A quick way is to use "shutdown immediate" - No need to stop redo apply.

--------------------------------------------------------------------------------------------------------------------------
What happen when shut down the observer machine?

If the observer sits in the standby machine, it can be a diaster...

ok, let's do a shutdown of the standby with observer
shutdown -h now

It was found that the primary database was shutdown! So never put the observer and standby together!!!

SQL> select * from a;
select * from a
*
ERROR at line 1:
ORA-01034: ORACLE not available
Process ID: 0
Session ID: 0 Serial number: 0

In primary alert log, we have... 

Wed May 11 10:12:42 2016
Primary has heard from neither observer nor target standby within FastStartFailoverThreshold seconds.
It is likely an automatic failover has already occurred. Primary is shutting down.

ok, let's run the observer in a machine(vbgeneric) other than the primary or standby machines.

let's shutdown the standby machine and see what happens. To make it more realistic, we do some DML 
in primary when standby is being shut down. Let's see what happens...

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    Error: ORA-16825: multiple errors or warnings, including fast-start failover-related errors or warnings, detected for the database

    cdb1 - (*) Physical standby database
      Warning: ORA-16824: multiple warnings, including fast-start failover-related warnings, detected for the database

  (*) Fast-Start Failover target

Configuration Status:
ERROR

DGMGRL> show database cdb2

Database - cdb2

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb2
      Error: ORA-16737: the redo transport service for standby database "cdb1" has an error

  Database Warning(s):
    ORA-16817: unsynchronized fast-start failover configuration

Database Status:
ERROR

DGMGRL> show database cdb1

Database - cdb1

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: 8.00 KByte/s
  Real Time Query:    OFF
  Instance(s):
    cdb1

  Database Warning(s):
    ORA-16858: last communication time from redo source could not be determined
    ORA-16817: unsynchronized fast-start failover configuration

Database Status:
WARNING

It shows above error initially, but after one/two minutes, it becomes normal.

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    cdb1 - (*) Physical standby database

Fast-Start Failover: ENABLED

Configuration Status:
SUCCESS   (status updated 7 seconds ago)


The redo can be transported and applied automatically after the standby is power up again.

ok, now let's shutdown the observer machine and see what happens...

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    Error: ORA-16820: fast-start failover observer is no longer observing this database

    cdb1 - (*) Physical standby database
      Error: ORA-16820: fast-start failover observer is no longer observing this database

Fast-Start Failover: ENABLED

Configuration Status:
ERROR   (status updated 18 seconds ago)


It is fine. Both primary and standby are normal. Only the observer is down.

ok, let's shutdown both the standby and observer machines and see what happens....

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    Error: ORA-16825: multiple errors or warnings, including fast-start failover-related errors or warnings, detected for the database

    cdb1 - (*) Physical standby database (disabled)

Fast-Start Failover: ENABLED

Configuration Status:
ERROR   (status updated 19 seconds ago)


The primary database still work even the observer and standby machines are power down.

Conclusion: Don't put the observer and standby in the SAME machine, otherwise the
primary database will be shutdown when the standby and observer machine is power off.

--------------------------------------------------------------------------------------------------------------------------
If listeners in DG down, does it affect redo transport and log apply?
Three cases, primary listener down, standby listener down and both down.

In all three cases, both redo transport and log apply are not affected.
The "show configuration" shows normal status also. 

Let's do a switchover to see what happen when both listeners are down.
Right now, cdb2 is the primary.

DGMGRL> switchover to cdb1
Performing switchover NOW, please wait...
Error: ORA-16467: switchover target is not synchronized

Failed.
Unable to switchover, primary database is still "cdb2"


Ok, let's startup the listener in cdb1 and see what happen...

DGMGRL> switchover to cdb1
Performing switchover NOW, please wait...
New primary database "cdb1" is opening...
Operation requires start up of instance "cdb2" on database "cdb2"
Starting instance "cdb2"...
Unable to connect to database using (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=dg2.localdomain)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=cdb2_DGMGRL.lands)(INSTANCE_NAME=cdb2)(SERVER=DEDICATED)))
ORA-12541: TNS:no listener

Failed.
Warning: You are no longer connected to ORACLE.

Please complete the following steps to finish switchover:
        start up instance "cdb2" of database "cdb2"


OK, let's have a look in DGMGRL in cdb1 first.

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    Error: ORA-16810: multiple errors or warnings detected for the database

    cdb2 - (*) Physical standby database
      Error: ORA-12541: TNS:no listener

Fast-Start Failover: ENABLED

Configuration Status:
ERROR   (status updated 1 second ago)

DGMGRL> show database cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1
      Error: ORA-16737: the redo transport service for standby database "cdb2" has an error

  Database Warning(s):
    ORA-16829: fast-start failover configuration is lagging

Database Status:
ERROR

DGMGRL> show database cdb2

Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb2

Database Status:
DGM-17016: failed to retrieve status for database "cdb2"
ORA-12541: TNS:no listener
ORA-16625: cannot reach database "cdb2"

DGMGRL>


DGMGRL> SHOW DATABASE cdb1 'LogXptStatus';
LOG TRANSPORT STATUS
PRIMARY_INSTANCE_NAME STANDBY_DATABASE_NAME               STATUS
                cdb1                 cdb2 ORA-12541: TNS:�S����ť��

				

Ok, let's startup the cdb2 database first locally
sqlplus / as sysdba
startup mount;

From the alertdg, we see ...
28-04-2016 12:22:16 Log Transport Services    Error      Error 12541 for archive log file 2 to 'cdb2'
28-04-2016 12:22:16 Fetch Archive Log         Error      FAL[server, ARC0]: Error 12541 creating remote archivelog file 'cdb2'
28-04-2016 12:28:10 Log Transport Services    Error      Error 12541 received logging on to the standby
28-04-2016 12:28:10 Log Transport Services    Warning    Check whether the listener is up and running.

Also...
DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    Error: ORA-16810: multiple errors or warnings detected for the database

    cdb2 - (*) Physical standby database
      Error: ORA-12541: TNS:no listener

Fast-Start Failover: ENABLED

Configuration Status:
ERROR   (status updated 25 seconds ago)

DGMGRL> show database cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1
      Error: ORA-16737: the redo transport service for standby database "cdb2" has an error

  Database Warning(s):
    ORA-16829: fast-start failover configuration is lagging

Database Status:
ERROR

DGMGRL> show database cdb2

Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb2

Database Status:
DGM-17016: failed to retrieve status for database "cdb2"
ORA-12541: TNS:no listener
ORA-16625: cannot reach database "cdb2"

DGMGRL>


So, let's startup the cdb2 listener and see what happen...
It still shows error in the beginning...

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    Error: ORA-16810: multiple errors or warnings detected for the database

    cdb2 - (*) Physical standby database
      Error: ORA-12541: TNS:no listener

Fast-Start Failover: ENABLED

Configuration Status:
ERROR   (status updated 51 seconds ago)

DGMGRL> show configuration verbose

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    Error: ORA-16810: multiple errors or warnings detected for the database

    cdb2 - (*) Physical standby database
      Error: ORA-16825: multiple errors or warnings, including fast-start failover-related errors or warnings, detected for the database

  (*) Fast-Start Failover target

  Properties:
    FastStartFailoverThreshold      = '30'
    OperationTimeout                = '30'
    TraceLevel                      = 'USER'
    FastStartFailoverLagLimit       = '30'
    CommunicationTimeout            = '180'
    ObserverReconnect               = '0'
    FastStartFailoverAutoReinstate  = 'TRUE'
    FastStartFailoverPmyShutdown    = 'TRUE'
    BystandersFollowRoleChange      = 'ALL'
    ObserverOverride                = 'FALSE'
    ExternalDestination1            = ''
    ExternalDestination2            = ''
    PrimaryLostWriteAction          = 'CONTINUE'

Fast-Start Failover: ENABLED

  Threshold:          30 seconds
  Target:             cdb2
  Observer:           dg1.localdomain
  Lag Limit:          30 seconds
  Shutdown Primary:   TRUE
  Auto-reinstate:     TRUE
  Observer Reconnect: (none)
  Observer Override:  FALSE

Configuration Status:
ERROR

DGMGRL> show database cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1
      Error: ORA-16737: the redo transport service for standby database "cdb2" has an error

  Database Warning(s):
    ORA-16829: fast-start failover configuration is lagging

Database Status:
ERROR

DGMGRL> show database cdb2

Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb2

  Database Warning(s):
    ORA-16858: last communication time from redo source could not be determined
    ORA-16829: fast-start failover configuration is lagging

Database Status:
WARNING


But after some times, say one minute, it is okay. I guess it just takes some times to
become healthy, to apply the redo logs.

But we did test that DG can perform redo transport and redo apply without listeners on.
So, let's shutdown the listeners and see what happen... The redo transport and redo apply are normal.
Both the alert log and DG log show no error of the listeners are down.

Conclusion: Make sure both listeners are up before switchover. Redo transport and log apply are independent 
of listeners in normal run because by default dgmgrl use a dedicated connection to the databases.

--------------------------------------------------------------------------------------------------------------------------
Under max performance and max availability modes, can primary still commit txn if standby is down?

Conclusion: Yes.

ok, let's get started at 29-apr-2016 10:45.

We are now at max performance mode and the DG is healthy now. Note both listeners are down in this case.

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    cdb2 - (*) Physical standby database

Fast-Start Failover: ENABLED

Configuration Status:
SUCCESS   (status updated 44 seconds ago)

DGMGRL> show database cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1

Database Status:
SUCCESS

DGMGRL> show database cdb2

Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      0 seconds (computed 1 second ago)
  Apply Lag:          0 seconds (computed 1 second ago)
  Average Apply Rate: 2.00 KByte/s
  Real Time Query:    OFF
  Instance(s):
    cdb2

Database Status:
SUCCESS

Now in dg1, the archivelogs are 
[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*29*
total 85692
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myv9p_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3flg_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowly_.arc

in dg2, the archivelogs are
[oracle@dg2 cdb2]$ ls /u02/ora*/cdb2/CDB2/arch*/*29*
total 85692
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myw8q_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3fr6_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowq2_.arc

ok, now let's shutdown the cdb2 instance and see what happen...
SQL> shutdown immediate;
ORA-01109: database not open


Database dismounted.
ORACLE instance shut down.
SQL>

well, in the dgmgrl, we can see that log apply is lagging and cdb2 is down.

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    Warning: ORA-16829: fast-start failover configuration is lagging

    cdb2 - (*) Physical standby database (disabled)

Fast-Start Failover: ENABLED

Configuration Status:
WARNING   (status updated 11 seconds ago)

DGMGRL> show database cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1

  Database Warning(s):
    ORA-16829: fast-start failover configuration is lagging

Database Status:
WARNING

DGMGRL> show database cdb2

Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     OFFLINE
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb2

Database Status:
SHUTDOWN

DGMGRL>

The DG alertlog show similar message...

Processing shutdown notification from database cdb2, instance 1
Broker operation
Setting SHUTDOWN status for database cdb2
04/29/2016 10:51:22
Fast-Start Failover - transaction cannot commit without exceeding
30 second lag limit, waiting for permission to proceed
Target standby would lag if transaction was allowed to commit
      Last redo was applied on FSFO target standby at 04/29/2016 10:50:51
LG00: FSFO SetState("LAGGING", 0x2) operation requires an ack
        Primary database will shutdown within 30 seconds if permission
         is not granted from Observer or FSFO target standby to proceed
04/29/2016 10:51:23
LG00: Permission to continue has been granted

ok, it is as expected and now let's do some dml in cdb1, commit it and perform a log switch and see what happen...

SQL> insert into a values(4);
1 row created.
SQL> commit;
Commit complete.
SQL> alter system switch logfile;
System altered.

Well, under max performance mode, we can commit txn even standby is down.

In dg1, we can see archivelogs 
[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*29*
total 86224
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myv9p_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3flg_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowly_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 10:57 o1_mf_1_243_cl5mf2rj_.arc


in dg2, we can see archivelogs
[oracle@dg2 cdb2]$ ls /u02/ora*/cdb2/CDB2/arch*/*29*
total 85692
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myw8q_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3fr6_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowq2_.arc

we can see that the latest archivelog o1_mf_1_243_cl5mf2rj_.arc was not transported to cdb2 when it is down.
it accumulates in cdb1.

ok, now let's startup the cdb2 and see what happen...

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    Warning: ORA-16829: fast-start failover configuration is lagging

    cdb2 - (*) Physical standby database (disabled)

Fast-Start Failover: ENABLED

Configuration Status:
WARNING   (status updated 40 seconds ago)

In dg2 alertlog, we know that the archivelog sequence 243 was applied to cdb2...

Recovery of Online Redo Log: Thread 1 Group 10 Seq 243 Reading mem 0
  Mem# 0: /u02/oradata/cdb2/srl02.log
Completed: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT  NODELAY

in dg2 DG alert log, cdb2 failed to send message to site cdb1 because cdb1 listener is not up in this test.

Broker Configuration:       "DGCONFIG"
      Protection Mode:            Maximum Performance
      Fast-Start Failover (FSFO): Enabled, flags=0x44005, version=38
      Primary Database:           cdb1 (0x01010000)
04/29/2016 11:14:05
Failed to connect to remote database cdb1. Error is ORA-12541
Failed to send message to site cdb1. Error code is ORA-12541.
database cdb2 unable to contact primary database for version check; status ORA-12541
      completing bootstrap of this database

	  
ok, let's startup both listeners and then check again...

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    Warning: ORA-16829: fast-start failover configuration is lagging

    cdb2 - (*) Physical standby database (disabled)

Fast-Start Failover: ENABLED

Configuration Status:
WARNING   (status updated 56 seconds ago)

DGMGRL> show database cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1

  Database Warning(s):
    ORA-16829: fast-start failover configuration is lagging

Database Status:
WARNING

DGMGRL> show database cdb2

Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     OFFLINE
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb2

Database Status:
SHUTDOWN


From the v$archived_dest, it shows DEFERRED status for log_archive_dest_2... so redo transport is disabled!

The STATUS must be VALID and ERROR should be null in normal status

   DEST_ID STATUS          DESTINATIO APPLIED_SCN APPLIED_SCN_TIME               CURRENT_SCN CURRENT_SCN_TIME               ERROR
---------- --------------- ---------- ----------- ------------------------------ ----------- ------------------------------ ------------------------------
         2 DEFERRED        cdb2           3736589 29-04-2016 10:50:19                3744197 29-04-2016 11:43:50

		 
The show configuration shows cdb2 is disabled also.

Well, let's enable the database cdb2 first in dg1 and see what happen...

DGMGRL> enable database cdb2
Enabled.
DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    cdb2 - (*) Physical standby database

Fast-Start Failover: ENABLED

Configuration Status:
SUCCESS   (status updated 1 second ago)

DGMGRL> show database cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1

Database Status:
SUCCESS

DGMGRL> show database cdb2

Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      0 seconds (computed 1 second ago)
  Apply Lag:          0 seconds (computed 1 second ago)
  Average Apply Rate: 2.00 KByte/s
  Real Time Query:    OFF
  Instance(s):
    cdb2

Database Status:
SUCCESS

DGMGRL>

Well, it seems very well. Let's check the log_archive_dest_2 status again... and it is fine.

The STATUS must be VALID and ERROR should be null in normal status

   DEST_ID STATUS          DESTINATIO APPLIED_SCN APPLIED_SCN_TIME               CURRENT_SCN CURRENT_SCN_TIME               ERROR
---------- --------------- ---------- ----------- ------------------------------ ----------- ------------------------------ ------------------------------
         2 VALID           cdb2           3749323 29-04-2016 12:16:19                3749349 29-04-2016 12:16:31


Let's finally check the archivelogs in both dg1 and dg2... and they align well
		 
[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*29*
total 95916
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myv9p_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3flg_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowly_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 10:57 o1_mf_1_243_cl5mf2rj_.arc
-rw-r-----. 1 oracle oinstall  9906176 Apr 29 12:14 o1_mf_1_244_cl5qx2dn_.arc

[oracle@dg2 cdb2]$ ls /u02/ora*/cdb2/CDB2/arch*/*29*
total 95916
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myw8q_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3fr6_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowq2_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 12:14 o1_mf_1_243_cl5qx2t2_.arc
-rw-r-----. 1 oracle oinstall  9906176 Apr 29 12:14 o1_mf_1_244_cl5qx46f_.arc

Maybe, the cdb2 got disabled because both listeners are down. Let's try again this time with only cdb2 database down.
The current archived log is still sequence 244.

Let's shutdown only cdb2 database, the both listeners are up and see what happens...

SQL> shutdown immediate;
ORA-01109: database not open


Database dismounted.
ORACLE instance shut down.
SQL>

Let's check the configuration...

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    Warning: ORA-16829: fast-start failover configuration is lagging

    cdb2 - (*) Physical standby database (disabled)

Fast-Start Failover: ENABLED

Configuration Status:
WARNING   (status updated 12 seconds ago)

DGMGRL> show database cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1

  Database Warning(s):
    ORA-16829: fast-start failover configuration is lagging

Database Status:
WARNING

DGMGRL> show database cdb2

Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     OFFLINE
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb2

Database Status:
SHUTDOWN

From dg1 alert log, we can see that dg1 try the redo transport, but it abandoned and log_archive_dest_state_2 was RESET!
Oh, this is the reason of why the status is 'DEFERRED' in the v$archived_dest.

Fri Apr 29 14:20:49 2016
TT00: Attempting destination LOG_ARCHIVE_DEST_2 network reconnect (3135)
TT00: Destination LOG_ARCHIVE_DEST_2 network reconnect abandoned
Fri Apr 29 14:20:49 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb1/cdb1/trace/cdb1_tt00_31142.trc:
ORA-03135: �s�u���_
Error 3135 for archive log file 2 to 'cdb2'
Fri Apr 29 14:20:49 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb1/cdb1/trace/cdb1_tt00_31142.trc:
ORA-03135: �s�u���_
LNS: Failed to archive log 2 thread 1 sequence 245 (3135)
Fri Apr 29 14:20:49 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb1/cdb1/trace/cdb1_tt00_31142.trc:
ORA-03135: �s�u���_
Fri Apr 29 14:20:52 2016
ALTER SYSTEM SET log_archive_dest_state_2='RESET' SCOPE=BOTH;

ok, let's perform some dml in dg1 and commit it and then a log switch...

[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*29*
total 107104
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myv9p_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3flg_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowly_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 10:57 o1_mf_1_243_cl5mf2rj_.arc
-rw-r-----. 1 oracle oinstall  9906176 Apr 29 12:14 o1_mf_1_244_cl5qx2dn_.arc
-rw-r-----. 1 oracle oinstall 11437568 Apr 29 14:29 o1_mf_1_245_cl5zsvz4_.arc

[oracle@dg2 cdb2]$ ls /u02/ora*/cdb2/CDB2/arch*/*29*
total 95916
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myw8q_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3fr6_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowq2_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 12:14 o1_mf_1_243_cl5qx2t2_.arc
-rw-r-----. 1 oracle oinstall  9906176 Apr 29 12:14 o1_mf_1_244_cl5qx46f_.arc

we can see that the latest sequence 245 is not transported to dg2.

ok, now startup cdb2 in mount mode and see what happen...

SQL> startup mount;
ORACLE instance started.

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    cdb2 - (*) Physical standby database

Fast-Start Failover: ENABLED

Configuration Status:
SUCCESS   (status updated 3 seconds ago)

Well, the dgmgrl shows that DG is normal, cdb2 is normal, not disabled. From dg1 alert log we can see dest_2 is ENABLED automatically.

Fri Apr 29 14:33:22 2016
ALTER SYSTEM SET log_archive_dest_state_2='ENABLE' SCOPE=BOTH;
Fri Apr 29 14:33:22 2016
ALTER SYSTEM ARCHIVE LOG

The archived logs in both dg1 and dg2 also align. 

[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*29*
total 107304
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myv9p_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3flg_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowly_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 10:57 o1_mf_1_243_cl5mf2rj_.arc
-rw-r-----. 1 oracle oinstall  9906176 Apr 29 12:14 o1_mf_1_244_cl5qx2dn_.arc
-rw-r-----. 1 oracle oinstall 11437568 Apr 29 14:29 o1_mf_1_245_cl5zsvz4_.arc
-rw-r-----. 1 oracle oinstall   200704 Apr 29 14:33 o1_mf_1_246_cl601lps_.arc

[oracle@dg2 cdb2]$ ls /u02/ora*/cdb2/CDB2/arch*/*29*
total 107304
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myw8q_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3fr6_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowq2_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 12:14 o1_mf_1_243_cl5qx2t2_.arc
-rw-r-----. 1 oracle oinstall  9906176 Apr 29 12:14 o1_mf_1_244_cl5qx46f_.arc
-rw-r-----. 1 oracle oinstall 11437568 Apr 29 14:33 o1_mf_1_245_cl601nd2_.arc
-rw-r-----. 1 oracle oinstall   200704 Apr 29 14:33 o1_mf_1_246_cl601nfr_.arc


ok, this time, let's shutdown both the cdb2 listener and database and see what happen. The current sequence is 246.

SQL> shutdown immediate;
[oracle@dg2 cdb2]$ lsnrctl stop


DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    Warning: ORA-16829: fast-start failover configuration is lagging

    cdb2 - (*) Physical standby database (disabled)

Fast-Start Failover: ENABLED

Configuration Status:
WARNING   (status updated 4 seconds ago)

DGMGRL> show database cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1

  Database Warning(s):
    ORA-16829: fast-start failover configuration is lagging

Database Status:
WARNING

DGMGRL> show database cdb2

Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     OFFLINE
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb2

Database Status:
SHUTDOWN

DGMGRL>

in dg1 alert log, we can see that dest_2 was 'RESET'.

TT00: Attempting destination LOG_ARCHIVE_DEST_2 network reconnect (3135)
TT00: Destination LOG_ARCHIVE_DEST_2 network reconnect abandoned
Fri Apr 29 14:43:47 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb1/cdb1/trace/cdb1_tt00_31142.trc:
ORA-03135: �s�u���_
Error 3135 for archive log file 1 to 'cdb2'
Fri Apr 29 14:43:47 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb1/cdb1/trace/cdb1_tt00_31142.trc:
ORA-03135: �s�u���_
LNS: Failed to archive log 1 thread 1 sequence 247 (3135)
Fri Apr 29 14:43:47 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb1/cdb1/trace/cdb1_tt00_31142.trc:
ORA-03135: �s�u���_
Fri Apr 29 14:43:50 2016
ALTER SYSTEM SET log_archive_dest_state_2='RESET' SCOPE=BOTH;

ok, now perform some dml, commit the txn and perform a log switch...

[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*29*
total 107916
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myv9p_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3flg_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowly_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 10:57 o1_mf_1_243_cl5mf2rj_.arc
-rw-r-----. 1 oracle oinstall  9906176 Apr 29 12:14 o1_mf_1_244_cl5qx2dn_.arc
-rw-r-----. 1 oracle oinstall 11437568 Apr 29 14:29 o1_mf_1_245_cl5zsvz4_.arc
-rw-r-----. 1 oracle oinstall   200704 Apr 29 14:33 o1_mf_1_246_cl601lps_.arc
-rw-r-----. 1 oracle oinstall   621568 Apr 29 14:49 o1_mf_1_247_cl60yx92_.arc

[oracle@dg2 cdb2]$ ls /u02/ora*/cdb2/CDB2/arch*/*29*
total 107304
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myw8q_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3fr6_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowq2_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 12:14 o1_mf_1_243_cl5qx2t2_.arc
-rw-r-----. 1 oracle oinstall  9906176 Apr 29 12:14 o1_mf_1_244_cl5qx46f_.arc
-rw-r-----. 1 oracle oinstall 11437568 Apr 29 14:33 o1_mf_1_245_cl601nd2_.arc
-rw-r-----. 1 oracle oinstall   200704 Apr 29 14:33 o1_mf_1_246_cl601nfr_.arc


The seq# 247 was not transported to dg2 as expected. So, let's startup the cdb2 listener and database and see what happens...

[oracle@dg2 cdb2]$ lsnrctl start
SQL> startup mount;

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    cdb2 - (*) Physical standby database

Fast-Start Failover: ENABLED

Configuration Status:
SUCCESS   (status updated 2 seconds ago)


From dg1 alert log, can see that the dest_2 is ENABLED automatically...

Fri Apr 29 14:53:35 2016
ALTER SYSTEM SET log_archive_dest_state_2='ENABLE' SCOPE=BOTH;
Fri Apr 29 14:53:35 2016

The archived logs in dg1 and dg2 align...
[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*29*
total 108140
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myv9p_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3flg_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowly_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 10:57 o1_mf_1_243_cl5mf2rj_.arc
-rw-r-----. 1 oracle oinstall  9906176 Apr 29 12:14 o1_mf_1_244_cl5qx2dn_.arc
-rw-r-----. 1 oracle oinstall 11437568 Apr 29 14:29 o1_mf_1_245_cl5zsvz4_.arc
-rw-r-----. 1 oracle oinstall   200704 Apr 29 14:33 o1_mf_1_246_cl601lps_.arc
-rw-r-----. 1 oracle oinstall   621568 Apr 29 14:49 o1_mf_1_247_cl60yx92_.arc
-rw-r-----. 1 oracle oinstall   223232 Apr 29 14:53 o1_mf_1_248_cl617hdq_.arc

[oracle@dg2 cdb2]$ ls /u02/ora*/cdb2/CDB2/arch*/*29*
total 108140
-rw-r-----. 1 oracle oinstall 41679872 Apr 29 02:01 o1_mf_1_240_cl4myw8q_.arc
-rw-r-----. 1 oracle oinstall 40498176 Apr 29 09:44 o1_mf_1_241_cl5h3fr6_.arc
-rw-r-----. 1 oracle oinstall  5463040 Apr 29 10:45 o1_mf_1_242_cl5lowq2_.arc
-rw-r-----. 1 oracle oinstall   537600 Apr 29 12:14 o1_mf_1_243_cl5qx2t2_.arc
-rw-r-----. 1 oracle oinstall  9906176 Apr 29 12:14 o1_mf_1_244_cl5qx46f_.arc
-rw-r-----. 1 oracle oinstall 11437568 Apr 29 14:33 o1_mf_1_245_cl601nd2_.arc
-rw-r-----. 1 oracle oinstall   200704 Apr 29 14:33 o1_mf_1_246_cl601nfr_.arc
-rw-r-----. 1 oracle oinstall   621568 Apr 29 14:53 o1_mf_1_247_cl617hw1_.arc
-rw-r-----. 1 oracle oinstall   223232 Apr 29 14:53 o1_mf_1_248_cl617j3p_.arc

Conclusion: The cdb2 listener and database can be shut down in max performance mode without affecting cdb1 operation.
            DG log transport and apply can resume automatically when cdb2 listener and database resume.

			
ok now, let's test the max availability mode. we need to switch to max availability mode first...

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxPerformance
  Members:
  cdb1 - Primary database
    cdb2 - (*) Physical standby database

Fast-Start Failover: ENABLED

Configuration Status:
SUCCESS   (status updated 10 seconds ago)

DGMGRL> disable fast_start failover
Disabled.
DGMGRL> edit database cdb1 set property 'LogXptMode'='SYNC';
Property "LogXptMode" updated
DGMGRL> edit database cdb2 set property 'LogXptMode'='SYNC';
Property "LogXptMode" updated
DGMGRL> EDIT CONFIGURATION SET PROTECTION MODE AS MaxAvailability;
Succeeded.
DGMGRL> enable fast_start failover
Enabled.
DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    cdb2 - (*) Physical standby database

Fast-Start Failover: ENABLED

Configuration Status:
SUCCESS   (status updated 0 seconds ago)

DGMGRL>

ok, it seems fine. From dg1 V$ARCHIVED_LOG, can see a "FGRD" entry of seq# 250 which is not in dg1 V$MANAGED_STANDBY.
But seq# 250 appears in dg2, both V$ARCHIVED_LOG and V$MANAGED_STANDBY. Anyway, the DG is normal. We just continue...

Retrieve last 10 rows of archived logs (V$ARCHIVED_LOG)
The SEQUENCE# should be the same in both database in normal status

REGISTR    THREAD#  SEQUENCE# APPLIED   FIRST_TIME          NEXT_TIME
------- ---------- ---------- --------- ------------------- -------------------
ARCH             1        245 NO        29-04-2016 12:14:26 29-04-2016 14:29:15
ARCH             1        245 YES       29-04-2016 12:14:26 29-04-2016 14:29:15
ARCH             1        246 YES       29-04-2016 14:29:15 29-04-2016 14:33:22
ARCH             1        246 NO        29-04-2016 14:29:15 29-04-2016 14:33:22
ARCH             1        247 NO        29-04-2016 14:33:22 29-04-2016 14:49:01
ARCH             1        247 YES       29-04-2016 14:33:22 29-04-2016 14:49:01
ARCH             1        248 NO        29-04-2016 14:49:01 29-04-2016 14:53:35
ARCH             1        248 YES       29-04-2016 14:49:01 29-04-2016 14:53:35
ARCH             1        249 NO        29-04-2016 14:53:35 29-04-2016 15:24:26
FGRD             1        250 NO        29-04-2016 15:24:26 29-04-2016 15:24:32

10 rows selected.

[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*29*
total 112312
-rw-r-----. 1 oracle oinstall   223232 Apr 29 14:53 o1_mf_1_248_cl617hdq_.arc
-rw-r-----. 1 oracle oinstall  4254208 Apr 29 15:24 o1_mf_1_249_cl631fjs_.arc
-rw-r-----. 1 oracle oinstall     4096 Apr 29 15:24 o1_mf_1_250_cl631kmk_.arc


[oracle@dg2 cdb2]$ ls /u02/ora*/cdb2/CDB2/arch*/*29*
total 112312
-rw-r-----. 1 oracle oinstall   223232 Apr 29 14:53 o1_mf_1_248_cl617j3p_.arc
-rw-r-----. 1 oracle oinstall  4254208 Apr 29 15:24 o1_mf_1_249_cl631fnl_.arc
-rw-r-----. 1 oracle oinstall     4096 Apr 29 15:24 o1_mf_1_250_cl631jjt_.arc


ok, now let's shutdown cdb2 listener and database and see what happen...

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    Warning: ORA-16817: unsynchronized fast-start failover configuration

    cdb2 - (*) Physical standby database (disabled)

Fast-Start Failover: ENABLED

Configuration Status:
WARNING   (status updated 3 seconds ago)

DGMGRL> show database cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1

  Database Warning(s):
    ORA-16817: unsynchronized fast-start failover configuration

Database Status:
WARNING

DGMGRL> show database cdb2

Database - cdb2

  Role:               PHYSICAL STANDBY
  Intended State:     OFFLINE
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb2

Database Status:
SHUTDOWN

DGMGRL>


From dg1 DG alert log, we see similar message. By the way, what/who granted the continue permission...

LGWR: FSFO SetState("UNSYNC", 0x2) operation requires an ack
        Primary database will shutdown within 30 seconds if permission
         is not granted from Observer or FSFO target standby to proceed
Network I/O to database cdb2 failed, status = ORA-03113.
04/29/2016 15:59:42
LGWR: Permission to continue has been granted
04/29/2016 15:59:43
Processing shutdown notification from database cdb2, instance 1
Broker operation
Setting SHUTDOWN status for database cdb2
04/29/2016 15:59:47


Now, let do some dml, commit the txn and switch log file in dg1 and see what happens...

SQL> insert into a values(7);

1 row created.

SQL> commit;

Commit complete.

SQL> alter system switch logfile;

System altered.

[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*29*
total 116740
-rw-r-----. 1 oracle oinstall   223232 Apr 29 14:53 o1_mf_1_248_cl617hdq_.arc
-rw-r-----. 1 oracle oinstall  4254208 Apr 29 15:24 o1_mf_1_249_cl631fjs_.arc
-rw-r-----. 1 oracle oinstall     4096 Apr 29 15:24 o1_mf_1_250_cl631kmk_.arc
-rw-r-----. 1 oracle oinstall  1497600 Apr 29 15:59 o1_mf_1_251_cl653gcn_.arc
-rw-r-----. 1 oracle oinstall  3023360 Apr 29 16:06 o1_mf_1_252_cl65jsvr_.arc

[oracle@dg2 cdb2]$ ls /u02/ora*/cdb2/CDB2/arch*/*29*
total 112312
-rw-r-----. 1 oracle oinstall   223232 Apr 29 14:53 o1_mf_1_248_cl617j3p_.arc
-rw-r-----. 1 oracle oinstall  4254208 Apr 29 15:24 o1_mf_1_249_cl631fnl_.arc
-rw-r-----. 1 oracle oinstall     4096 Apr 29 15:24 o1_mf_1_250_cl631jjt_.arc

Well, we can commit txn in dg1 running the max availability mode. The archived logs(251,252) not transported yet as expected.
ok, now let's startup cdb2 listener and database and see what happens... can DG resumes automatically?

We can see dg1 alert log, the dest_state_2 "ENABLE". it is good.
Fri Apr 29 16:11:01 2016
ALTER SYSTEM SET log_archive_dest_state_2='ENABLE' SCOPE=BOTH;
Destination LOG_ARCHIVE_DEST_2 is SYNCHRONIZED

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    cdb2 - (*) Physical standby database

Fast-Start Failover: ENABLED

Configuration Status:
SUCCESS   (status updated 3 seconds ago)

[oracle@dg1 setup_dg]$ ls /u02/fast*/CDB1/arch*/*29*
total 117384
-rw-r-----. 1 oracle oinstall   223232 Apr 29 14:53 o1_mf_1_248_cl617hdq_.arc
-rw-r-----. 1 oracle oinstall  4254208 Apr 29 15:24 o1_mf_1_249_cl631fjs_.arc
-rw-r-----. 1 oracle oinstall     4096 Apr 29 15:24 o1_mf_1_250_cl631kmk_.arc
-rw-r-----. 1 oracle oinstall  1497600 Apr 29 15:59 o1_mf_1_251_cl653gcn_.arc
-rw-r-----. 1 oracle oinstall  3023360 Apr 29 16:06 o1_mf_1_252_cl65jsvr_.arc
-rw-r-----. 1 oracle oinstall   648192 Apr 29 16:11 o1_mf_1_253_cl65rp0s_.arc
-rw-r-----. 1 oracle oinstall     3584 Apr 29 16:11 o1_mf_1_254_cl65rtp0_.arc


[oracle@dg2 cdb2]$ ls /u02/ora*/cdb2/CDB2/arch*/*29*
total 117384
-rw-r-----. 1 oracle oinstall   223232 Apr 29 14:53 o1_mf_1_248_cl617j3p_.arc
-rw-r-----. 1 oracle oinstall  4254208 Apr 29 15:24 o1_mf_1_249_cl631fnl_.arc
-rw-r-----. 1 oracle oinstall     4096 Apr 29 15:24 o1_mf_1_250_cl631jjt_.arc
-rw-r-----. 1 oracle oinstall  3023360 Apr 29 16:11 o1_mf_1_252_cl65rp2y_.arc
-rw-r-----. 1 oracle oinstall  1497600 Apr 29 16:11 o1_mf_1_251_cl65rps3_.arc
-rw-r-----. 1 oracle oinstall   648192 Apr 29 16:11 o1_mf_1_253_cl65rpws_.arc
-rw-r-----. 1 oracle oinstall     3584 Apr 29 16:11 o1_mf_1_254_cl65rtj4_.arc

The archived logs in dg1 and dg2 align. 

Well, in max availability mode, the dg.sql output in dg1 is bit a different as compared in max performance mode.
The FSFO STATUS is "SYNCHRONIZED". Also, there is no "LNS" process in the V$MANAGED_STANDBY. We have LGWR instead.

Fast-start failover status

FSFO STATUS                    TARGET                 THRESHOLD OBSERVER PRESENT     PENDING_ROLE_CHANGE_TASKS
------------------------------ -------------------- ----------- -------------------- -------------------------
SYNCHRONIZED                   cdb2                       30.00 YES                  NONE

1 row selected.


===========================================================================================================
Redo Apply and redo transport status (V$MANAGED_STANDBY)
LNS process should be in primary and MRP0 process should be in standby in normal status

PROCESS   STATUS             THREAD#  SEQUENCE#     BLOCK#     BLOCKS
--------- --------------- ---------- ---------- ---------- ----------
ARCH      CLOSING                  1        251          2       2923
ARCH      CONNECTED                0          0          0          0
ARCH      CLOSING                  1        253          1       1265
ARCH      CLOSING                  1        254          1          6
LGWR      WRITING                  1        255       1051          1

5 rows selected.

Conclusion: The standby cdb2 listener and database can be shut down in max availability mode without affecting cdb1 operation.
            DG log transport and apply can resume automatically when cdb2 listener and database resume.

==========================================================================================================================
===  Incidents
==========================================================================================================================
On re-boot both dg1 and dg2, the databases are not up automatically. I powered up dg2 first and 
since dg1 is not up and the FSFO then started as seen the dg2 alert log and dg2 dgmgrl log

Fri Apr 29 17:26:27 2016
Attempting Fast-Start Failover because the threshold of 30 seconds has elapsed.
Fri Apr 29 17:26:27 2016
 Data Guard Broker: A zero data loss Fast-Start Failover will now be attempted
Fri Apr 29 17:26:27 2016
ALTER DATABASE FAILOVER TO cdb2
Fri Apr 29 17:27:06 2016
Failover succeeded. Primary database is now CDB2.
Fri Apr 29 17:52:47 2016
Starting ORACLE instance (normal) (OS id: 2021)
Fri Apr 29 17:53:01 2016
Database mounted in Exclusive Mode
Lost write protection disabled
Completed: ALTER DATABASE   MOUNT
Fri Apr 29 17:53:21 2016
FSFP started with pid=29, OS id=2128

The failover seems fine, but the cdb2 is opened in mount mode!

So, on Mon May 02 17:35:19 2016, I open cdb2 manually, alter database open. Then in alert log, it reports temp file failure...

Read of datafile '/u02/oradata/cdb2/temp01.dbf' (fno 201) header failed with ORA-01203
Rereading datafile 201 header failed with ORA-01203
Mon May 02 17:35:23 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb2/cdb2/trace/cdb2_dbw0_2062.trc:
ORA-01186: ?? 201 ???????
ORA-01122: ???? 201 ???????
ORA-01110: ??? 201: '/u02/oradata/cdb2/temp01.dbf'
ORA-01203: ????????? - ?? SCN ??
File 201 not verified due to error ORA-01122
Tue May 03 10:28:50 2016
Errors in file /u01/app/oracle/diag/rdbms/cdb2/cdb2/trace/cdb2_dbw0_2062.trc:
ORA-01186: �ɮ� 203 ���q�L���Ҵ���
ORA-01122: ��Ʈw�� 203 ���q�L�����ˬd
ORA-01110: ����� 203: '/u02/oradata/cdb2/gisp/temp01.dbf'
ORA-01203: ���ɮת����������T - �إ� SCN ���~
File 203 not verified due to error ORA-01122
Tue May 03 10:28:50 2016
Cannot re-create tempfile /u02/oradata/cdb2/gisp/temp01.dbf, the same name file exists

But, the database seems fine...
SQL> insert into a values(8);
1 row created.
SQL> commit;
Commit complete.

SQL> select * from a order by 1;

         A
----------
         1
         2
         3
         4
         5
         6
         7
         8

8 rows selected.

SQL> alter session set container=gisp;
Session altered.
SQL> create table test ( a int);
Table created.
SQL> insert into test values(1);
1 row created.
SQL> commit;
Commit complete.
SQL> select * from test order by 1;

         A
----------
         1

SQL>

ok, let's take a look in dg2 dgmgrl...

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    Error: ORA-16825: multiple errors or warnings, including fast-start failover-related errors or warnings, detected for the database

    cdb1 - (*) Physical standby database (disabled)
      ORA-16661: the standby database needs to be reinstated

Fast-Start Failover: ENABLED

Configuration Status:
ERROR   (status updated 18 seconds ago)

DGMGRL> show database cdb1

Database - cdb1

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb1

Database Status:
ORA-16661: the standby database needs to be reinstated

DGMGRL> show database cdb2

Database - cdb2

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb2

  Database Error(s):
    ORA-16820: fast-start failover observer is no longer observing this database

  Database Warning(s):
    ORA-16817: unsynchronized fast-start failover configuration

Database Status:
ERROR

DGMGRL>

ok, let's do a reinstate on cdb1 first. We can perform auto-reinstate, but we need to make sure the 
cdb1 is enabled, cdb1 is mounted and the observer can connect to the cdb1. So, let's do it ...

SQL> startup mount;

The auto-reinstate seems not working, so let's do it manually in dgmgrl

DGMGRL> reinstate database cdb1;
Reinstating database "cdb1", please wait...
Reinstatement of database "cdb1" succeeded
DGMGRL>

DGMGRL> show configuration

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    Error: ORA-16820: fast-start failover observer is no longer observing this database

    cdb1 - (*) Physical standby database
      Error: ORA-16820: fast-start failover observer is no longer observing this database

Fast-Start Failover: ENABLED

Configuration Status:
ERROR   (status updated 29 seconds ago)


As it shows "Error: ORA-16820: fast-start failover observer is no longer observing this database", let's stop the observer in dg1 and dg2.
And then start the observer in dg1.

DGMGRL> show configuration verbose

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    cdb1 - (*) Physical standby database

  (*) Fast-Start Failover target

  Properties:
    FastStartFailoverThreshold      = '30'
    OperationTimeout                = '30'
    TraceLevel                      = 'USER'
    FastStartFailoverLagLimit       = '30'
    CommunicationTimeout            = '180'
    ObserverReconnect               = '0'
    FastStartFailoverAutoReinstate  = 'TRUE'
    FastStartFailoverPmyShutdown    = 'TRUE'
    BystandersFollowRoleChange      = 'ALL'
    ObserverOverride                = 'FALSE'
    ExternalDestination1            = ''
    ExternalDestination2            = ''
    PrimaryLostWriteAction          = 'CONTINUE'

Fast-Start Failover: ENABLED

  Threshold:          30 seconds
  Target:             cdb1
  Observer:           dg1.localdomain
  Lag Limit:          30 seconds (not in use)
  Shutdown Primary:   TRUE
  Auto-reinstate:     TRUE
  Observer Reconnect: (none)
  Observer Override:  FALSE

Configuration Status:
SUCCESS

DGMGRL>





























