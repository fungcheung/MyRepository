TOC
Introduction
Environments
Reference
Production setup considerations
Setup /etc/hosts
Setup password-less SSH
About Firewall
Copy useful scripts gdat9118 to gdat8124/gdat8135/gdat8144
Setup Oracle 12.1.0.2
Setup rlwrap for Command Line History and Editing in SQL*Plus and RMAN on Linux
.bashrc for gdat8124
Setup flashback database
.bashrc for gdat8135
Setup Data Guard - Primary & first standby
Setup Data Guard Broker for Primary & First standby
Setup listener.ora for Primary & first standby switchover
Add second standby
.bashrc for gfsf8232
Setup tnsnames.ora in gdat8124,gdat8135,gdat8144,gfsf8232 for RMAN backup
Create oracle recovery catalog to support DG backup
Create rgihwservice for seamless access
Post setup configurations
Set Oracle parameters for the DG configuration
Create dba monitor common account   
Setup backup & monitoring scripts 
Setup geodatabase 10.4.1

Test switchover,failover,fsfo
Test backup and recovery
Setup autorestart of Oracle on host reboot (done)
Test shutdown and restart of host (done)
Apply CPU patch (done)
Setup mailx function (done - no need to setup)
Setup rgihapp schema and Import data
Remove Oracle Kernel parameters from /etc/sysctl.conf in post installation (done)
Disable Transparent HugePages in /etc/sysconfig/grub (done)
About FAL_SERVER, FAL_CLIENT
About DB_FILE_NAME_CONVERT, LOG_FILE_NAME_CONVERT
Sync data from prod to SIT

Problems hit
  Problem: compat-libstdc++-33 not found
  Problem: This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register 
  Problem: VALIDATE DATABASE - Insufficient SRLs
  Problem: Error: ORA-16655: specified target standby database invalid
  Problem: ORA-00326 on the two standbys after powering up the Primary which has been shut down for a long time
  Problem: RMAN-20033: control file SEQUENCE# too low, RMAN-20036: invalid record order during resync catalog
  Problem: "ORA-16198: é€²è¡Œé ç«¯å­˜æª”æ™‚å…§éƒ¨é€šé“é€¾æ™‚" in primary and "CORRUPTION DETECTED: In redo blocks starting at block..." in standby


FAQ
. [Please refer to 12cDG.txt for more FAQs]
. How to re-create physical standby database in DG configuration with 3 databases?
. What does "disable database" command mean? 
. What does "remove database" command mean? 
. What does "remove configuration" command mean?
  
appendix
  dupstby.rcv
  orainstRoot.sh & root.sh
  XRDP
  Create DG configuration
  dupstdb.rcv output
  

==========================================================================================================================
=== Introduction
==========================================================================================================================
Task: Setup multiple Oracle physical standby for rGIH SIT
Date: Apr 2017
 
==========================================================================================================================
=== Environments
==========================================================================================================================

RedHat Enterprise 7.3
192.168.31.124 gdat8124
192.168.31.135 gdat8135
192.168.31.144 gdat8144
8G Ram, 1cpu
root/$Passw0rd123
oracle/rGIH201704

Centos 7.3.1611
192.168.31.232 gfsf8232 FSFO & RMAN catalog machine
4G Ram, 1cpu
root/$Passw0rd123
oracle/rGIH201704

 
==========================================================================================================================
=== Reference
==========================================================================================================================
Multiple Standby Databases Dataguard Oracle(11g)
https://easyoradba.com/2012/12/04/multiple-standby-databases-dataguard-oracle/

Overview Data Guard Configuration - A primary and 2 Standby Databases
https://www.youtube.com/watch?v=5keahpkzLtM

DATAGUARD multiple standby(10g)
http://oracle8groups.blogspot.hk/2012/06/dataguard-multiple-standby.html

Step by Step Guide on Creating Physical Standby Using RMAN DUPLICATE...FROM ACTIVE DATABASE (Doc ID 1075908.1)

Master Note for Data Guard (Doc ID 1101938.1)

Oracle Active Data Guard Best Practices Standby For More Than Disaster Recovery
http://www.oracle.com/technetwork/database/features/availability/311400-134359.pdf

Multiple Standby Databases Best Practices: Oracle Database 10g Release 2 
http://www.oracle.com/technetwork/database/features/availability/maa10gr2multiplestandbybp-1-131937.pdf

RMAN DUPLICATE FROM¡K Active Standby (Cascading Standby)
https://odenysenko.wordpress.com/2012/07/31/rman-duplicate-from-from-active-standby/

Oracle Data Guard Broker
Best Practices for Configuring Redo Transport for Data Guard and Active Data Guard 12c
http://www.oracle.com/technetwork/database/availability/broker-12c-transport-config-2082184.pdf

Active Data Guard Hands On Lab
http://www.oracle.com/technetwork/database/features/availability/adg-hands-on-lab-176003.pdf

Oracle Data Guard, Active Data Guard and Global Data Services Documentation
http://www.oracle.com/technetwork/database/features/availability/data-guard-documentation-152848.html

Oracle Active Data Guard 12c Best Practices
http://www.oracle.com/technetwork/database/availability/active-data-guard-12c-best-practice-2162660.html


What is the official way to add additional repos to RHEL containers in Atomic
https://access.redhat.com/discussions/1405933

Installing compat-libstdc++-33 on RHEL 7
https://serverfault.com/questions/703167/installing-compat-libstdc-33-on-rhel-7


==========================================================================================================================
===  Production setup considerations 
==========================================================================================================================
1. Configure 3 redo log groups, each with 2 logfiles of 300M each. So total size is 1.8G
2. Store Oracle binary, data files and archived logs in 3 different filesystems/hard disks.
3. Set the FastStartFailoverThreshold to 600 seconds for production.
4. Set the FastStartFailoverLagLimit to allow failover to fall behind the primary in terms of redo applied, beyond which a fast-start failover will not be allowed. It is for Maximum performance mode.
5. Set the ApplyLagThreshold to log warning when threshold exceeds
6. Set the TransportLag to log warning when threshold exceeds
7. Place one member of the online redo log group in FRA
8. Put the Oracle base in /u01/app/oracle, size 50G (binary 10G, logs 10G, buffer of future upgrade 20G) 
   FRA under /u02/app/oracle/fast_recovery_area, size 100G
   and datafiles under /u03/app/oracle/oradata, size 50G (redo 3G[500M * 2 * 3], SLR 2G[500M * 4],  undo 4G, temp 4G, system 2G, sysaux 2G, data 20G) 
9. Assign 14G ram, so swap space require about 14G
10. set number of processes to 1500 or higher value
11. Check v$datafile status as a routine healthcheck. Should have no offline or SYSOFF status
12. log_buffer size to 256M
13. Make sure shmall is larger than the total SGA size
14. The FSFO machine should be in the same ESXi as the Primary so as to isolate the network or hardware issue in the Standby ESXi.
15. Use different db_name in primary and standby, say cdb1,cdb2,cdb3.
16. Set log transport delay, say 1 minutes, for remote physical standby cdb3 to prevent cdb3 log apply faster than cdb2 which is the failover target.
17. The remote standby cdb3 is not set as fast start failover target. Manual failover is preferred.
18. Set remote standby(cdb3) mode to ASYNC
 

alter system set log_buffer=256M scope=spfile;
alter system set sga_max_size=6912M scope=spfile;
alter system set sga_target=6912M scope=spfile;
alter system set memory_target=0 scope=both;
alter system set processes=1500 scope=spfile;

alter system set nls_language='AMERICAN' scope=spfile;
alter system set nls_territory='AMERICA'scope=spfile;


-- In root container
alter profile DEFAULT limit PASSWORD_LIFE_TIME UNLIMITED;


-- Change from max performance mode to max availability mode
disable fast_start failover
edit database cdb1 set property 'LogXptMode'='SYNC';
edit database cdb2 set property 'LogXptMode'='SYNC';
edit database cdb3 set property 'DelayMins'=1;
EDIT CONFIGURATION SET PROTECTION MODE AS MaxAvailability;
enable fast_start failover




-- fast start failover parameters. It will failover if losing connection with the primary for 60s.Default is 30s.
EDIT CONFIGURATION SET PROPERTY FastStartFailoverThreshold = 600;
EDIT CONFIGURATION SET PROPERTY FastStartFailoverAutoReinstate = FALSE;


==========================================================================================================================
===  Setup /etc/hosts
==========================================================================================================================
192.168.31.124 gdat8124
192.168.31.135 gdat8135
192.168.31.144 gdat8144
192.168.31.232 gfsf8232
		

==========================================================================================================================
===  Setup password-less SSH
==========================================================================================================================
-- In gdat8124, create the key
ssh-keygen -t rsa
-- Store gdat8124 public key to gdat8135 and gdat8144
ssh oracle@gdat8135 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gdat8135 'cat >> .ssh/authorized_keys'
ssh oracle@gdat8144 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gdat8144 'cat >> .ssh/authorized_keys'
ssh oracle@gfsf8232 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gfsf8232 'cat >> .ssh/authorized_keys'

-- In gdat8135, create the key
ssh-keygen -t rsa
-- Store gdat8135 public key to gdat8124 and gdat8144
ssh oracle@gdat8124 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gdat8124 'cat >> .ssh/authorized_keys'
ssh oracle@gdat8144 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gdat8144 'cat >> .ssh/authorized_keys'
ssh oracle@gfsf8232 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gfsf8232 'cat >> .ssh/authorized_keys'

-- In gdat8144, create the key
ssh-keygen -t rsa
-- Store gdat9120 public key to gdat8124 and gdat8135
ssh oracle@gdat8124 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gdat8124 'cat >> .ssh/authorized_keys'
ssh oracle@gdat8135 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gdat8135 'cat >> .ssh/authorized_keys'
ssh oracle@gfsf8232 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gfsf8232 'cat >> .ssh/authorized_keys'

-- In gfsf8232, create the key
ssh-keygen -t rsa
-- Store gdat9120 public key to gdat8124 and gdat8135
ssh oracle@gdat8124 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gdat8124 'cat >> .ssh/authorized_keys'
ssh oracle@gdat8135 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gdat8135 'cat >> .ssh/authorized_keys'
ssh oracle@gdat8144 mkdir -p .ssh
cat .ssh/id_rsa.pub | ssh oracle@gdat8144 'cat >> .ssh/authorized_keys'



==========================================================================================================================
===  About Firewall
==========================================================================================================================
By default, firewall is on for centos7,

-- check status as root
systemctl status firewalld

-- stop firewall 
systemctl stop firewalld

-- disable firewall 
systemctl disable firewalld

If firwall is on, the tnsping can fail because port 1521 may be blocked. For simplicity, just disable the firewall.

Used TNSNAMES adapter to resolve the alias
Attempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8144)(PORT = 1521)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = rmandb.lands)))
TNS-12543: TNS:destination host unreachable

Reference
https://www.liquidweb.com/kb/how-to-stop-and-disable-firewalld-on-centos-7/


==========================================================================================================================
===  Copy useful scripts gdat9118 to gdat8124/gdat8135/gdat8144, gfsf9120(192.168.30.120) to gfsf8232
==========================================================================================================================
-- Login gdat9118 as oracle
cd ~/script
scp -p *.sql oracle@192.168.31.124:~/script
scp -p *.sh oracle@192.168.31.124:~/script
scp -p *.rcv oracle@192.168.31.124:~/script

-- Login gdat9124
scp -p *.sql oracle@gdat8135:~/script
scp -p *.sh oracle@gdat8135:~/script
scp -p *.rcv oracle@gdat8135:~/script

-- Login gdat9124
scp -p *.sql oracle@gdat8144:~/script
scp -p *.sh oracle@gdat8144:~/script
scp -p *.rcv oracle@gdat8144:~/script

-- Login gfsf8232
mkdir ~/script
scp -pr oracle@192.168.30.120:~/script/* ~/script


==========================================================================================================================
===  Setup Oracle 12.1.0.2 
==========================================================================================================================

-- Install xming
-- Enable X11 forwarding in putty
   Connection->ssh->X11->display location: localhost:0

- In all three machines, install the pre-req packages...   
# yum install `awk '{print $1}' ./req-rpm.txt` -y

[root@azsg-comndat1 orapreq]# yum install `awk '{print $1}' ./req-rpm.txt` -y
binutils
compat-libcap1
compat-libstdc++-33
gcc
gcc-c++
glibc
glibc-devel
ksh
libgcc
libstdc++
libstdc++-devel
libaio
libaio-devel
libXext
libXtst
libX11
libXau
libxcb
libXi
make
sysstat
libXmu
libXt
libXv
libXxf86misc
libXxf86vm
xorg-x11-utils
xorg-x11-xauth
nfs-utils

# getconf PAGE_SIZE
4096

System total memory: 8G
Assign 5G to Oracle
-- Set SHMMAX to half the system total memory as recommended by Oracle. 
-- SHMMAX is the max size of a shared memory segment. 
-- SHMALL is the total amount of shared memory, in pages, that the system can use at one time.
-- As we assign at most 10G to Oracle, so let's set these two parameters to both 10G. 
-- In Oracle database creation, we assign say 9G SGA to Oracle to make sure that it can fill in.
SHMMAX=10737418240
SHMALL=2621440

-- Disable secure linux in all three machines
cp -p /etc/selinux/config /etc/selinux/config.ori
vi /etc/selinux/config
--------------------------------
SELINUX=permissive
--------------------------------

#setenforce Permissive

-- Disable firewall
# service iptables stop
# chkconfig iptables off
# systemctl stop firewalld
# systemctl disable firewalld

-- Set kernel parameters
cp -p /etc/sysctl.conf /etc/sysctl.conf.ori
vi /etc/sysctl.conf
--------------------------------
vm.swappiness = 1
vm.dirty_background_ratio = 3
vm.dirty_ratio = 80
vm.dirty_expire_centisecs = 500
vm.dirty_writeback_centisecs = 100
# Set shmmax, max size of shared memory segment to 10GB
kernel.shmmax = 10737418240
# Set shmall, total shared memory at one time to 10GB
kernel.shmall = 2621440
kernel.shmmni = 4096
kernel.sem = 250 32000 100 128
# fs.file-max needs to be set to at least 6815744 for Oracle Installation.
fs.file-max = 6815744
fs.aio-max-nr = 1048576
net.ipv4.ip_local_port_range = 9000 65500
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576
kernel.panic_on_oops = 1
--------------------------------
 
sysctl -p

-- Add users and groups
groupadd --gid 54321 oinstall
groupadd --gid 54322 dba
groupadd --gid 54323 asmdba
groupadd --gid 54324 asmoper
groupadd --gid 54325 asmadmin
groupadd --gid 54326 oper
groupadd --gid 54327 backupdba
groupadd --gid 54328 dgdba
groupadd --gid 54329 kmdba


# useradd --uid 54321 --gid oinstall --groups dba,oper,asmdba,asmoper,backupdba,dgdba,kmdba oracle
# passwd oracle
rGIH201704

id oracle

vi /etc/security/limits.d/99-oracle-limits.conf
--------------------------------------
oracle soft nproc 16384
oracle hard nproc 16384
oracle soft nofile 1024
oracle hard nofile 65536
oracle soft stack 10240
oracle hard stack 32768
--------------------------------------

vi /etc/profile.d/oracle.sh
--------------------------------------
#Setting the appropriate ulimits for oracle and grid user
if [ $USER = "oracle" ]; then
if [ $SHELL = "/bin/ksh" ]; then
ulimit -u 16384
ulimit -n 65536
else
ulimit -u 16384 -n 65536
fi
fi
--------------------------------------

-- Log in as oracle to check ulimit
# ulimit -a

-- As root
mkdir -p /u01/app/oracle
mkdir -p /u02/app/oracle/fast_recovery_area
mkdir -p /u03/app/oracle/oradata
chown --recursive oracle.oinstall /u01/app
chown --recursive oracle.oinstall /u02/app
chown --recursive oracle.oinstall /u03/app


-- As oracle
# mkdir -p /u01/app/oracle/oracle-software

-- Copy database zip files to /u01/app/oracle/oracle-software

# cd /u01/app/oracle/oracle-software

-- Unzip the database files
unzip linuxamd64_12102_database_1of2.zip
unzip linuxamd64_12102_database_2of2.zip

# env

-- Install 12.1.0.2 into gdat8124
		./runInstaller to install
		installation option -> install software only
		Select product language -> English
		Select Enterprise Edition (6.4GB)
		create inventory -> select "oinstall" group. Oracle Inventory in /u01/app/oraInventory.
		As default: OSDBA -> dba, OSOPER -> oper, OSBACKUP -> backupdba, OSDGDBA -> dgdba, OSKMDBA -> kmdba
		Save the response file to /home/oracle/install_oracle_software_12102.rsp
		During installation, as prompted login as root to run /u01/app/oraInventory/orainstRoot.sh, /u01/app/oracle/product/12.1.0/dbhome_1/root.sh
		./netca to setup a listener
		./dbca to create a database
		choose "advanced" mode in Creation Mode
		Choose "custom database"
		global database name = cdb1.lands
		sid = cdb1
		pdb = rgihw
		sys/system/PDBADMIN has same passwd.
		/u02/app/oracle/fast_recovery_area for FRA.  FRA size is 140GB. /u03/app/oracle/oradata for data.
		Memory -> Custom Setting -> Memory Management -> ASMM. SGA -> 3840MB, PGA -> 1280MB. Total 5120MB(5GB).
		Block size : 16384 byte. Processes: 1500. Open cursors: 1000
		Choose "Use Unicode (al32utf8)" and "al16utf16" ad national character set.
		In "Character Sets" tabl, select "Traditional Chinese" as default language and "Hong Kong" as default territory.
		Control Files -> Option -> Maximum datafiles : 200
		In Creation Options, choose "Customize Storage Locations" to add more redo logs (500MB each, 2 per group, 3 groups)
		Temp tbl : 4GB, undo tbl : 4GB. 
		EM URL https://gdat8124:5500/em


-- Install 12.1.0.2 into gdat8135, we only install the binary and listener because its db will be duplicated from gdat8124.
		./runInstaller to install
		installation option -> install software only
		Select product language -> English
		Select Enterprise Edition (6.4GB)
		create inventory -> select "oinstall" group. Oracle Inventory in /u01/app/oraInventory.
		As default: OSDBA -> dba, OSOPER -> oper, OSBACKUP -> backupdba, OSDGDBA -> dgdba, OSKMDBA -> kmdba
		Save the response file to /home/oracle/install_oracle_software_12102.rsp
		During installation, as prompted login as root to run /u01/app/oraInventory/orainstRoot.sh, /u01/app/oracle/product/12.1.0/dbhome_1/root.sh
		./netca to setup a listener



-- Install 12.1.0.2 into gdat8144, we only install the binary and listener because its db will be duplicated from gdat8124.
		./runInstaller to install
		installation option -> install software only
		Select product language -> English
		Select Enterprise Edition (6.4GB)
		create inventory -> select "oinstall" group. Oracle Inventory in /u01/app/oraInventory.
		As default: OSDBA -> dba, OSOPER -> oper, OSBACKUP -> backupdba, OSDGDBA -> dgdba, OSKMDBA -> kmdba
		Save the response file to /home/oracle/install_oracle_software_12102.rsp
		During installation, as prompted login as root to run /u01/app/oraInventory/orainstRoot.sh, /u01/app/oracle/product/12.1.0/dbhome_1/root.sh
		./netca to setup a listener

-- Install 12.1.0.2 into gfsf8232. 
		./runInstaller to install
		installation option -> install software only
		Select product language -> English
		Select Enterprise Edition (6.4GB)
		create inventory -> select "oinstall" group. Oracle Inventory in /u01/app/oraInventory.
		As default: OSDBA -> dba, OSOPER -> oper, OSBACKUP -> backupdba, OSDGDBA -> dgdba, OSKMDBA -> kmdba
		Save the response file to /home/oracle/install_oracle_software_12102.rsp
		During installation, as prompted login as root to run /u01/app/orainventory/orainstRoot.sh, /u01/app/oracle/product/12.1.0.2/db_1/root.sh
		./netca to setup a listener
		./dbca to create a database
		choose "advanced" mode in Creation Mode
		Choose "custom database"
		global database name = rmandb.lands
		sid = rmandb
		pdb = rmancat
		sys/system/PDBADMIN has same passwd.
		/u02/app/oracle/fast_recovery_area for FRA.  FRA size is 20GB. /u03/app/oracle/oradata for data.
		Memory -> Custom Setting -> Memory Management -> ASMM. SGA -> 1500MB, PGA -> 500MB. Total 2000MB.
		Block size : 16384 byte. Processes: 1500. Open cursors: 1000
		Choose "Use Unicode (al32utf8)" and "al16utf16" ad national character set.
		In "Character Sets" tabl, select "Traditional Chinese" as default language and "Hong Kong" as default territory.
		Control Files -> Option -> Maximum datafiles : 200
		In Creation Options, choose "Customize Storage Locations" to add more redo logs (200MB each, 2 per group, 3 groups)
		Temp tbl : 2GB, undo tbl : 2GB. 

		
==========================================================================================================================
=== Setup rlwrap for Command Line History and Editing in SQL*Plus and RMAN on Linux
==========================================================================================================================
--login as root to download and configure the EPEL repository
# wget https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
# rpm -Uvh epel-release-latest-7.noarch.rpm
 
-- With the repository in place you can install rlwrap using the following command
# yum install rlwrap

-- Query whether the epel package there
rpm -qa | grep -i epel

-- Remove the epel if required
rpm -e epel-release-6-8.noarch

Reference
https://oracle-base.com/articles/linux/rlwrap
https://community.oracle.com/message/3529362

Refer to Appendix for details

		
==========================================================================================================================
=== .bashrc for gdat8124
==========================================================================================================================

# My settings
export TMP=/tmp
export TMPDIR=$TMP

export ORACLE_HOSTNAME=gdat8124
export ORACLE_UNQNAME=cdb1
export ORACLE_BASE=/u01/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/12.1.0/dbhome_1
export ORACLE_SID=cdb1

export DBA=csada1@landsd.gov.hk

export PATH=/usr/sbin:$PATH
export PATH=$ORACLE_HOME/bin:$PATH

export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib
export CLASSPATH=$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib

alias ls='ls -ltr'
alias tnsora='view $ORACLE_HOME/network/admin/tnsnames.ora'
alias lsnrora='view $ORACLE_HOME/network/admin/listener.ora'
alias lsnrora='view $ORACLE_HOME/network/admin/listener.ora'
alias psora='ps -ef |grep oracle'
alias alert='view $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/alert_$ORACLE_SID.log'
alias alertlsnr='view $ORACLE_BASE/diag/tnslsnr/$ORACLE_HOSTNAME/listener/trace/listener.log'
alias talert='tail -f $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/alert_$ORACLE_SID.log'
alias talertlsnr='tail -f $ORACLE_BASE/diag/tnslsnr/$ORACLE_HOSTNAME/listener/trace/listener.log'
alias alertdg='view $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/drc$ORACLE_SID.log'
alias talertdg='tail -f $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/drc$ORACLE_SID.log'
alias sid='env|grep ORACLE_SID'
alias ol='sqlplus / as sysdba'
export ob=$ORACLE_BASE
export oh=$ORACLE_HOME
export NLS_LANG=AMERICAN_AMERICA.AL32UTF8
alias sqlplus="rlwrap sqlplus"
alias dgmgrl="rlwrap dgmgrl"
alias rman="rlwrap rman"
alias dgl="dgmgrl sys/oracle"
alias rmancat="rman target / catalog rmancat/rmancat@orcl"
alias dufra="du -m /u02/app/oracle/fast_recovery_area/CDB1/ | sort -n"
alias cdfra="cd /u02/app/oracle/fast_recovery_area/CDB1"
alias dudat="du -m /u03/app/oracle/oradata/cdb1/ | sort -n"
alias cddat="cd /u03/app/oracle/oradata/cdb1"
alias cds="cd ~/script"
alias cdl="cd ~/script/log"

		
==========================================================================================================================
=== Setup flashback database
==========================================================================================================================
-- In gdat8124, setup flashback database.
ALTER SYSTEM SET UNDO_RETENTION=3600 SCOPE=SPFILE;
ALTER SYSTEM SET UNDO_MANAGEMENT='AUTO' SCOPE=SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
SHOW PARAMETER UNDO;
ALTER SYSTEM SET DB_FLASHBACK_RETENTION_TARGET=4320 SCOPE=BOTH;
ALTER DATABASE ARCHIVELOG;
ALTER SYSTEM SET db_recovery_file_dest_size=<size>;
ALTER SYSTEM SET db_recovery_file_dest=<directory-specification>;
ALTER DATABASE FLASHBACK ON;
ALTER DATABASE OPEN;

Ensure the UNDO_RETENTION and DB_FLASHBACK_RETENTION_TARGET initialization parameters 
are set to sufficiently large values so that reinstatement is still possible after a prolonged outage.


==========================================================================================================================
=== .bashrc for gdat8135
==========================================================================================================================

# My settings
export TMP=/tmp
export TMPDIR=$TMP

export ORACLE_HOSTNAME=gdat8135
export ORACLE_UNQNAME=cdb2
export ORACLE_BASE=/u01/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/12.1.0/dbhome_1
export ORACLE_SID=cdb2

export DBA=csada1@landsd.gov.hk

export PATH=/usr/sbin:$PATH
export PATH=$ORACLE_HOME/bin:$PATH

export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib
export CLASSPATH=$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib

alias ls='ls -ltr'
alias tnsora='view $ORACLE_HOME/network/admin/tnsnames.ora'
alias lsnrora='view $ORACLE_HOME/network/admin/listener.ora'
alias lsnrora='view $ORACLE_HOME/network/admin/listener.ora'
alias psora='ps -ef |grep oracle'
alias alert='view $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/alert_$ORACLE_SID.log'
alias alertlsnr='view $ORACLE_BASE/diag/tnslsnr/$ORACLE_HOSTNAME/listener/trace/listener.log'
alias talert='tail -f $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/alert_$ORACLE_SID.log'
alias talertlsnr='tail -f $ORACLE_BASE/diag/tnslsnr/$ORACLE_HOSTNAME/listener/trace/listener.log'
alias alertdg='view $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/drc$ORACLE_SID.log'
alias talertdg='tail -f $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/drc$ORACLE_SID.log'
alias sid='env|grep ORACLE_SID'
alias ol='sqlplus / as sysdba'
export ob=$ORACLE_BASE
export oh=$ORACLE_HOME
export NLS_LANG=AMERICAN_AMERICA.AL32UTF8
alias sqlplus="rlwrap sqlplus"
alias dgmgrl="rlwrap dgmgrl"
alias rman="rlwrap rman"
alias dgl="dgmgrl sys/oracle"
alias rmancat="rman target / catalog rmancat/rmancat@orcl"
alias dufra="du -m /u02/app/oracle/fast_recovery_area/CDB2/ | sort -n"
alias cdfra="cd /u02/app/oracle/fast_recovery_area/CDB2"
alias dudat="du -m /u03/app/oracle/oradata/cdb2/ | sort -n"
alias cddat="cd /u03/app/oracle/oradata/cdb2"
alias cds="cd ~/script"
alias cdl="cd ~/script/log"


==========================================================================================================================
===  Setup Data Guard - Primary & first standby
==========================================================================================================================
-----------------------------------------------------------------------------------------------------
-- Put below entries into gdat8124 and gdat8135 tnsnames.ora
-----------------------------------------------------------------------------------------------------

CDB1 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8124)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb1.lands)
    )
  )

CDB2 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8135)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb2.lands)
    )
  )

-----------------------------------------------------------------------------------------------------
-- Primary(gdat8124) server setup
-----------------------------------------------------------------------------------------------------
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
ALTER DATABASE ARCHIVELOG;
ALTER DATABASE OPEN;
  
ALTER DATABASE FORCE LOGGING;
  
alter system set log_archive_dest_1='LOCATION=USE_DB_RECOVERY_FILE_DEST';
alter system set log_archive_config='dg_config=(cdb1,cdb2)';
alter system set log_archive_dest_2='service=cdb2 async valid_for=(online_logfile,primary_role) db_unique_name=cdb2';
alter system set db_recovery_file_dest_size=140G;
alter system set local_listener='' scope=both;

-- Add standby redo log groups, assume groups 1-3 are for existing redo log groups. We MUST specify 'THREAD 1' - Doc ID 1956103.1
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 4 ('/u02/app/oracle/fast_recovery_area/cdb1/srl01b.log','/u03/app/oracle/oradata/cdb1/srl01a.log') SIZE 500M;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 5 ('/u02/app/oracle/fast_recovery_area/cdb1/srl02b.log','/u03/app/oracle/oradata/cdb1/srl02a.log') SIZE 500M;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 6 ('/u02/app/oracle/fast_recovery_area/cdb1/srl03b.log','/u03/app/oracle/oradata/cdb1/srl03a.log') SIZE 500M;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 7 ('/u02/app/oracle/fast_recovery_area/cdb1/srl04b.log','/u03/app/oracle/oradata/cdb1/srl04a.log') SIZE 500M;


ALTER SYSTEM SET LOG_ARCHIVE_MAX_PROCESSES=30;
ALTER SYSTEM SET REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE SCOPE=SPFILE;
ALTER SYSTEM SET STANDBY_FILE_MANAGEMENT=AUTO;

CREATE PFILE='/home/oracle/script/cdb2.ora' FROM SPFILE;

Amend the PFILE making the entries relevant for the standby database. 
-- Original cdb2.ora
*.audit_file_dest='/u01/app/oracle/admin/cdb1/adump'
*.audit_trail='db'
*.compatible='12.1.0.2.0'
*.control_files='/u03/app/oracle/oradata/cdb1/control01.ctl','/u02/app/oracle/fast_recovery_area/cdb1/control02.ctl'
*.db_block_size=16384
*.db_domain='lands'
*.db_flashback_retention_target=4320
*.db_name='cdb1'
*.db_recovery_file_dest='/u02/app/oracle/fast_recovery_area'
*.db_recovery_file_dest_size=150323855360
*.diagnostic_dest='/u01/app/oracle'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=cdb1XDB)'
*.enable_pluggable_database=true
*.local_listener=''
*.log_archive_config='dg_config=(cdb1,cdb2)'
*.log_archive_dest_1='LOCATION=USE_DB_RECOVERY_FILE_DEST'
*.log_archive_dest_2='service=cdb2 async valid_for=(online_logfile,primary_role) db_unique_name=cdb2'
*.log_archive_format='%t_%s_%r.dbf'
*.log_archive_max_processes=30
*.nls_language='TRADITIONAL CHINESE'
*.nls_territory='HONG KONG'
*.open_cursors=1000
*.pga_aggregate_target=1280m
*.processes=1500
*.remote_login_passwordfile='EXCLUSIVE'
*.sga_target=3840m
*.standby_file_management='AUTO'
*.undo_management='AUTO'
*.undo_retention=3600
*.undo_tablespace='UNDOTBS1'

-- Revised cdb2.ora
*.audit_file_dest='/u01/app/oracle/admin/cdb2/adump'
*.audit_trail='db'
*.compatible='12.1.0.2.0'
*.control_files='/u03/app/oracle/oradata/cdb2/control01.ctl','/u02/app/oracle/fast_recovery_area/cdb2/control02.ctl'
*.db_block_size=16384
*.db_domain='lands'
*.db_flashback_retention_target=4320
*.db_name='cdb1'
*.db_recovery_file_dest='/u02/app/oracle/fast_recovery_area'
*.db_recovery_file_dest_size=150323855360
*.diagnostic_dest='/u01/app/oracle'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=cdb2XDB)'
*.enable_pluggable_database=true
*.local_listener=''
*.log_archive_config='dg_config=(cdb1,cdb2)'
*.log_archive_dest_1='LOCATION=USE_DB_RECOVERY_FILE_DEST'
*.log_archive_dest_2='service=cdb1 async valid_for=(online_logfile,primary_role) db_unique_name=cdb1'
*.log_archive_format='%t_%s_%r.dbf'
*.log_archive_max_processes=30
*.nls_language='TRADITIONAL CHINESE'
*.nls_territory='HONG KONG'
*.open_cursors=1000
*.pga_aggregate_target=1280m
*.processes=1500
*.remote_login_passwordfile='EXCLUSIVE'
*.sga_target=3840m
*.standby_file_management='AUTO'
*.undo_management='AUTO'
*.undo_retention=3600
*.undo_tablespace='UNDOTBS1'
*.fal_server='cdb1'

-- Changes
1. Replace some 'cdb1' with 'cdb2'
*.audit_file_dest='/u01/app/oracle/admin/cdb2/adump'
*.control_files='/u03/app/oracle/oradata/cdb2/control01.ctl','/u02/app/oracle/fast_recovery_area/cdb2/control02.ctl'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=cdb2XDB)'
2. Then change entries to these for the standby
----------------------
*.fal_server='cdb1'
*.log_archive_dest_2='SERVICE=cdb1 ASYNC VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=cdb1'
----------------------

-----------------------------------------------------------------------------------------------------
-- Standby Server Setup (DUPLICATE)
-----------------------------------------------------------------------------------------------------
mkdir -p /u03/app/oracle/oradata/cdb2
mkdir -p /u02/app/oracle/fast_recovery_area/cdb2
mkdir -p /u01/app/oracle/admin/cdb2/adump
mkdir -p /u03/app/oracle/oradata/cdb2/pdbseed
mkdir -p /u03/app/oracle/oradata/cdb2/rgihw

# Parameter file.
scp -p oracle@gdat8124://home/oracle/script/cdb2.ora /home/oracle/script/cdb2.ora

# Remote login password file.
scp -p oracle@gdat8124:$ORACLE_HOME/dbs/orapwcdb1 $ORACLE_HOME/dbs/orapwcdb2

# Put below entry into "listener.ora"
---------------------------------------------------------------------------
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = cdb2.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = cdb2)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8135)(PORT = 1521))
    )
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle
---------------------------------------------------------------------------

# Startup listener
lsnrctl start

# Start the auxillary instance on the standby server by starting it using the temporary "init.ora" file.
export ORACLE_SID=cdb2
sqlplus / as sysdba

STARTUP NOMOUNT PFILE='/home/oracle/script/cdb2.ora';

# Make sure tnsping okay
tnsping cdb1
tnsping cdb2

-----------------------------------------------------------------------------------------------------
-- Create Standby Using DUPLICATE
-----------------------------------------------------------------------------------------------------
-- Login gdat8124 as oracle

# Make sure tnsping okay
tnsping cdb1
tnsping cdb2

# Make sure rman connect okay
rman
connect target sys/rGIH201704@cdb1
connect auxiliary sys/rGIH201704@cdb2 
exit

# Create the standby
export ORACLE_SID=cdb1
cd ~/script
rman<<EOF
connect target sys/rGIH201704@cdb1
connect auxiliary sys/rGIH201704@cdb2 
@dupstby.rcv
EOF


-----------------------------------------------------------------------------------------------------
-- Start the apply process on standby server
-----------------------------------------------------------------------------------------------------
# Background redo apply. Control is returned to the session once the apply process is started.
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT FROM SESSION;

-----------------------------------------------------------------------------------------------------
-- Test Log Transport
-----------------------------------------------------------------------------------------------------
-- On the primary server, check the latest archived redo log and force a log switch.
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
SELECT sequence#, first_time, next_time
FROM   v$archived_log
ORDER BY sequence#;
ALTER SYSTEM SWITCH LOGFILE;

-- Check the new archived redo log has arrived at the standby server and been applied.
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
SELECT sequence#, first_time, next_time, applied
FROM   v$archived_log
ORDER BY sequence#;


==========================================================================================================================
===  Setup Data Guard Broker for Primary & First standby
==========================================================================================================================
-- In Primary and Standby databases, run below command to clear the dest before creating config in DG broker.
alter system set dg_broker_start=true;
alter system set log_archive_dest_2='';

-- Turn on flashback in primary
ALTER SYSTEM SET UNDO_RETENTION=3600 SCOPE=SPFILE;
ALTER SYSTEM SET UNDO_MANAGEMENT='AUTO' SCOPE=SPFILE;
ALTER SYSTEM SET DB_FLASHBACK_RETENTION_TARGET=4320 SCOPE=BOTH;
shutdown immediate;
startup mount;
alter database flashback on;
alter database open;

-- Turn on flashback in standby
ALTER SYSTEM SET UNDO_RETENTION=3600 SCOPE=SPFILE;
ALTER SYSTEM SET UNDO_MANAGEMENT='AUTO' SCOPE=SPFILE;
ALTER SYSTEM SET DB_FLASHBACK_RETENTION_TARGET=4320 SCOPE=BOTH;
shutdown immediate;
startup mount;
alter database flashback on;
alter database open read only;


-- Add DG config.
dgmgrl <<EOF
connect sys/rGIH201704@cdb1
create configuration 'DGCONFIG' as primary database is 'cdb1' connect identifier is cdb1;
add database 'cdb2' as connect identifier is cdb2;
enable configuration;
EOF
sqlplus sys/rGIH201704@cdb1 as sysdba <<EOF
alter system set log_archive_dest_2='service=cdb2 async valid_for=(online_logfile,primary_role) db_unique_name=cdb2';
EOF

-- Set fsfo property
dgmgrl <<EOF
connect sys/rGIH201704@cdb1
edit database cdb1 set property FastStartFailoverTarget=cdb2;
edit database cdb2 set property FastStartFailoverTarget=cdb1;
EOF

-- Enable fsfo
DGMGRL> enable fast_start failover

-- check config
DGMGRL> show configuration 
DGMGRL> show configuration verbose

DGMGRL> show database verbose cdb1
DGMGRL> show database verbose cdb2

DGMGRL> show fast_start failover


==========================================================================================================================
===  Setup listener.ora for Primary & first standby switchover
==========================================================================================================================
-- In gdat8125 listener.ora, modify as follows

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = cdb1.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = cdb1)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = cdb1_DGMGRL.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = cdb1)
    )
  )

-- In gdat8135 listener.ora, modify as follows

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = cdb2.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = cdb2)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = cdb2_DGMGRL.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = cdb2)
    )
  )

-- Restart listeners in gdat8124 and gdat8135
lsnrctl stop
lsnrctl start


==========================================================================================================================
=== .bashrc for gdat8144
==========================================================================================================================
# My settings
export TMP=/tmp
export TMPDIR=$TMP

export ORACLE_HOSTNAME=gdat8144
export ORACLE_UNQNAME=cdb3
export ORACLE_BASE=/u01/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/12.1.0/dbhome_1
export ORACLE_SID=cdb3

export DBA=csada1@landsd.gov.hk

export PATH=/usr/sbin:$PATH
export PATH=$ORACLE_HOME/bin:$PATH

export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib
export CLASSPATH=$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib

alias ls='ls -ltr'
alias tnsora='view $ORACLE_HOME/network/admin/tnsnames.ora'
alias lsnrora='view $ORACLE_HOME/network/admin/listener.ora'
alias lsnrora='view $ORACLE_HOME/network/admin/listener.ora'
alias psora='ps -ef |grep oracle'
alias alert='view $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/alert_$ORACLE_SID.log'
alias alertlsnr='view $ORACLE_BASE/diag/tnslsnr/$ORACLE_HOSTNAME/listener/trace/listener.log'
alias talert='tail -f $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/alert_$ORACLE_SID.log'
alias talertlsnr='tail -f $ORACLE_BASE/diag/tnslsnr/$ORACLE_HOSTNAME/listener/trace/listener.log'
alias alertdg='view $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/drc$ORACLE_SID.log'
alias talertdg='tail -f $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/drc$ORACLE_SID.log'
alias sid='env|grep ORACLE_SID'
alias ol='sqlplus / as sysdba'
export ob=$ORACLE_BASE
export oh=$ORACLE_HOME
export NLS_LANG=AMERICAN_AMERICA.AL32UTF8
alias sqlplus="rlwrap sqlplus"
alias dgmgrl="rlwrap dgmgrl"
alias rman="rlwrap rman"
alias dgl="dgmgrl sys/oracle"
alias rmancat="rman target / catalog rmancat/rmancat@orcl"
alias dufra="du -m /u02/app/oracle/fast_recovery_area/CDB3/ | sort -n"
alias cdfra="cd /u02/app/oracle/fast_recovery_area/CDB3"
alias dudat="du -m /u03/app/oracle/oradata/cdb3/ | sort -n"
alias cddat="cd /u03/app/oracle/oradata/cdb3"
alias cds="cd ~/script"
alias cdl="cd ~/script/log"


==========================================================================================================================
===  Setup tnsnames.ora and listener.ora before adding second standby
==========================================================================================================================
-----------------------------------------------------------------------------------------------------
-- Put below entries into gdat8124,gdat8135,gdat8144 tnsnames.ora
-----------------------------------------------------------------------------------------------------

CDB1 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8124)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb1.lands)
    )
  )

CDB2 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8135)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb2.lands)
    )
  )

CDB3 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8144)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb3.lands)
    )
  )

-----------------------------------------------------------------------------------------------------
-- Put below entries into second standby(gdat8144) listener.ora
-----------------------------------------------------------------------------------------------------
 
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = cdb3.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = cdb3)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = cdb3_DGMGRL.lands)
      (ORACLE_HOME = /u01/app/oracle/product/12.1.0/dbhome_1)
      (SID_NAME = cdb3)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8144)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )
  
  
==========================================================================================================================
===  Add second standby
==========================================================================================================================
-----------------------------------------------------------------------------------------------------
-- Standby Server Setup (DUPLICATE)
-----------------------------------------------------------------------------------------------------
-- login gdat8144
mkdir -p /u03/app/oracle/oradata/cdb3
mkdir -p /u02/app/oracle/fast_recovery_area/cdb3
mkdir -p /u01/app/oracle/admin/cdb3/adump
mkdir -p /u03/app/oracle/oradata/cdb3/pdbseed
mkdir -p /u03/app/oracle/oradata/cdb3/rgihw

# Remote login password file.
scp -p oracle@gdat8124:$ORACLE_HOME/dbs/orapwcdb1 $ORACLE_HOME/dbs/orapwcdb3

# pfile for cdb3.ora. Stored in in /home/oracle/script/cdb3.ora
*.audit_file_dest='/u01/app/oracle/admin/cdb3/adump'
*.audit_trail='db'
*.compatible='12.1.0.2.0'
*.control_files='/u03/app/oracle/oradata/cdb3/control01.ctl','/u02/app/oracle/fast_recovery_area/cdb3/control02.ctl'
*.db_block_size=16384
*.db_domain='lands'
*.db_flashback_retention_target=4320
*.db_name='cdb1'
*.db_unique_name='cdb3'
*.db_recovery_file_dest='/u02/app/oracle/fast_recovery_area'
*.db_recovery_file_dest_size=150323855360
*.diagnostic_dest='/u01/app/oracle'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=cdb3XDB)'
*.enable_pluggable_database=true
*.local_listener=''
*.log_archive_format='%t_%s_%r.dbf'
*.log_archive_max_processes=30
*.nls_language='TRADITIONAL CHINESE'
*.nls_territory='HONG KONG'
*.open_cursors=1000
*.pga_aggregate_target=1280m
*.processes=1500
*.remote_login_passwordfile='EXCLUSIVE'
*.sga_target=3840m
*.standby_file_management='AUTO'
*.undo_management='AUTO'
*.undo_retention=3600
*.undo_tablespace='UNDOTBS1'
*.fal_server='cdb1'


# Note in above cdb3.ora, we did not specify the db_config related entries. We will add later in DGMGRL.
*.log_archive_config='dg_config=(cdb1,cdb2)'
*.log_archive_dest_1='LOCATION=USE_DB_RECOVERY_FILE_DEST'
*.log_archive_dest_2='service=cdb1 async valid_for=(online_logfile,primary_role) db_unique_name=cdb1'

# Startup listener
lsnrctl start

# Start the auxillary instance on the standby server by starting it using the temporary "init.ora" file.
export ORACLE_SID=cdb3
sqlplus / as sysdba

STARTUP NOMOUNT PFILE='/home/oracle/script/cdb3.ora';

# Make sure tnsping okay in gdat8124,gdat8135,gdat8144
tnsping cdb1
tnsping cdb2
tnsping cdb3

-----------------------------------------------------------------------------------------------------
-- Create 2nd Standby Using DUPLICATE
-----------------------------------------------------------------------------------------------------
-- Login gdat8124 as oracle

# Make sure rman connect okay
rman
connect target sys/rGIH201704@cdb1
connect auxiliary sys/rGIH201704@cdb3 
exit

# Create the standby
export ORACLE_SID=cdb1
cd ~/script
rman<<EOF
connect target sys/rGIH201704@cdb1
connect auxiliary sys/rGIH201704@cdb3 
@dup2ndstby.rcv
EOF


-----------------------------------------------------------------------------------------------------
-- Add 2nd Standby to DG configuration
-----------------------------------------------------------------------------------------------------
# Now the 2nd standby has been restored and recovered. We then need to add it to DG configuration.

-- Login to gdat8144 to reset log_archive_dest_2 before it can be added to DG configuration 
alter system set log_archive_dest_2='';

# Add it to the DG configuration
dgmgrl
connect sys@cdb1
DGMGRL> show configuration
Configuration - DGCONFIG
  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    Warning: ORA-16819: fast-start failover observer not started
    cdb2 - (*) Physical standby database
      Warning: ORA-16819: fast-start failover observer not started
Fast-Start Failover: ENABLED

Configuration Status:
WARNING   (status updated 6 seconds ago)

DGMGRL> add database 'cdb3' as connect identifier is cdb3;
Database "cdb3" added

DGMGRL> enable database cdb3
Enabled.


-----------------------------------------------------------------------------------------------------
-- Test Log Transport
-----------------------------------------------------------------------------------------------------
-- On the primary server, check the latest archived redo log and force a log switch.
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
SELECT sequence#, first_time, next_time
FROM   v$archived_log
ORDER BY sequence#;
ALTER SYSTEM SWITCH LOGFILE;

-- Check the new archived redo log has arrived at the standby server and been applied.
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
SELECT sequence#, first_time, next_time, applied
FROM   v$archived_log
ORDER BY sequence#;


-----------------------------------------------------------------------------------------------------
-- Turn on flashback database
-----------------------------------------------------------------------------------------------------
-- In gdat8144, setup flashback database.
ALTER SYSTEM SET UNDO_RETENTION=3600 SCOPE=SPFILE;
ALTER SYSTEM SET UNDO_MANAGEMENT='AUTO' SCOPE=SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
SHOW PARAMETER UNDO;
ALTER SYSTEM SET DB_FLASHBACK_RETENTION_TARGET=4320 SCOPE=BOTH;
ALTER DATABASE ARCHIVELOG;
ALTER SYSTEM SET db_recovery_file_dest_size=<size>;
ALTER SYSTEM SET db_recovery_file_dest=<directory-specification>;
ALTER DATABASE FLASHBACK ON;
ALTER DATABASE OPEN;

Ensure the UNDO_RETENTION and DB_FLASHBACK_RETENTION_TARGET initialization parameters 
are set to sufficiently large values so that reinstatement is still possible after a prolonged outage.


==========================================================================================================================
=== .bashrc for gfsf8232
==========================================================================================================================
# My settings
export TMP=/tmp
export TMPDIR=$TMP

export ORACLE_HOSTNAME=gfsf8232
export ORACLE_UNQNAME=rmandb
export ORACLE_BASE=/u01/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/12.1.0/dbhome_1
export ORACLE_SID=rmandb

export DBA=csada1@landsd.gov.hk

export PATH=/usr/sbin:$PATH
export PATH=$ORACLE_HOME/bin:$PATH

export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib
export CLASSPATH=$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib

alias ls='ls -ltr'
alias tnsora='view $ORACLE_HOME/network/admin/tnsnames.ora'
alias lsnrora='view $ORACLE_HOME/network/admin/listener.ora'
alias lsnrora='view $ORACLE_HOME/network/admin/listener.ora'
alias psora='ps -ef |grep oracle'
alias alert='view $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/alert_$ORACLE_SID.log'
alias alertlsnr='view $ORACLE_BASE/diag/tnslsnr/$ORACLE_HOSTNAME/listener/trace/listener.log'
alias talert='tail -f $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/alert_$ORACLE_SID.log'
alias talertlsnr='tail -f $ORACLE_BASE/diag/tnslsnr/$ORACLE_HOSTNAME/listener/trace/listener.log'
alias alertdg='view $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/drc$ORACLE_SID.log'
alias talertdg='tail -f $ORACLE_BASE/diag/rdbms/$ORACLE_SID/$ORACLE_SID/trace/drc$ORACLE_SID.log'
alias sid='env|grep ORACLE_SID'
alias ol='sqlplus / as sysdba'
export ob=$ORACLE_BASE
export oh=$ORACLE_HOME
export NLS_LANG=AMERICAN_AMERICA.AL32UTF8
alias sqlplus="rlwrap sqlplus"
alias dgmgrl="rlwrap dgmgrl"
alias rman="rlwrap rman"
alias dgl="dgmgrl sys/oracle"
alias rmancat="rman target / catalog rmancat/rmancat@rmancat"
alias dufra="du -m /u02/app/oracle/fast_recovery_area/rmandb/ | sort -n"
alias cdfra="cd /u02/app/oracle/fast_recovery_area/RMANDB"
alias cdl='cd ~/script/log'
alias cds='cd ~/script'
alias dudat="du -m /u03/app/oracle/oradata/rmandb/ | sort -n"
alias cddat="cd /u03/app/oracle/oradata/rmandb"


==========================================================================================================================
===  Setup tnsnames.ora in gdat8124,gdat8135,gdat8144,gfsf8232 for RMAN backup
==========================================================================================================================
-- In gdat8124, add below entries
# This is the rman catalog database
RMANCAT =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gfsf8232)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = rmancat.lands)
    )
  )

# This is the rman target tns for bkup.rcv. resync need tns alias connection rather than local OS auth
target =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8124)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb1.lands)
    )
  )


-- In gdat8135, add below entries
# This is the rman catalog database
RMANCAT =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gfsf8232)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = rmancat.lands)
    )
  )

# This is the rman target tns for bkup.rcv. resync need tns alias connection rather than local OS auth
target =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8135)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb2.lands)
    )
  )
  

-- In gdat8144, add below entries
# This is the rman catalog database
RMANCAT =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gfsf8232)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = rmancat.lands)
    )
  )

# This is the rman target tns for bkup.rcv. resync need tns alias connection rather than local OS auth
target =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8144)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb3.lands)
    )
  )
  
-- In gfsf8232, add below entries
RMANCAT =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gfsf8232)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = rmancat.lands)
    )
  )

CDB1 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8124)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb1.lands)
    )
  )

CDB2 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8135)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb2.lands)
    )
  )

CDB3 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8144)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = cdb3.lands)
    )
  )
  

==========================================================================================================================
===  Create oracle recovery catalog to support DG backup
==========================================================================================================================
The recovery catalog should be setup in separate machine other than the DG environment.

gfsf8232
service_name rmandb.lands
pdb rmancat

-- Connect to pdb rmancat as sys to create the rman user, rman tablespace and grant priv
sqlplus / as sysdba
alter session set container=rmancat;

create tablespace rman_data datafile '/u03/app/oracle/oradata/rmandb/rmancat/rman_data01.dbf' size 100M 
autoextend on next 100M maxsize 2G;

create user rmancat identified by rmancat
default tablespace rman_data
quota unlimited on rman_data;

grant connect, recovery_catalog_owner to rmancat;

-- connect as rmancat to the catalog and create the catalog
rman catalog rmancat@rmancat
create catalog;

-- Connect to the PDB rmancat as sys to grant priv as required in 12.1.0.2
sqlplus / as sysdba
alter session set container=rmancat;
spool /home/oracle/script/create_rmancat.out
@?/rdbms/admin/dbmsrmansys.sql
@?/rdbms/admin/dbmsrmanvpc.sql -all


-- Login as rmancat. Check table catalog tables have been created. 
SELECT TABLE_NAME FROM USER_TABLES;

-- Check current catalog version
SQL> select * from rcver;

VERSION
------------
12.01.00.02

Now, the catalog database has been created. The next step is to register the DG databases to it.
Because of Bug 20848335, we need to turn off ADG in standbys first. Otherwise the "ORA-20079: full resync from primary database is not done"
will appear in standbys when using RMAN commands.

-- Turn off ADG in standby
-- In gdat8135 and gdat8144,
sqlplus / as sysdba
shutdown immediate;
startup mount;
@dgh   -- check that in mount mode, not "read only with apply"

-- Now, cdb1 is the primary, we login to gdat8124 to register the primary database
rman TARGET sys/rGIH201704@cdb1 CATALOG rmancat/rmancat@rmancat;
REGISTER DATABASE;
-- Run below command to verify registration ok. It should display CDB1 tablespaces/datafiles
report schema;


-- Now, let's register the standby database, it is easy, just login to gdat8135 and gdat8144(now standby) and connect as target.
rman target sys/rGIH201704@cdb2 catalog rmancat/rmancat@rmancat
-- Run below command to verify registration ok. It should display CDB2 tablespaces/datafiles
report schema;

rman target sys/rGIH201704@cdb3 catalog rmancat/rmancat@rmancat
-- Run below command to verify registration ok. It should display CDB3 tablespaces/datafiles
report schema;


-- configure the connect identifiers for all datbases in the primary database connected to catalog
rman TARGET sys/rGIH201704@cdb1 CATALOG rmancat/rmancat@rmancat;
configure db_unique_name cdb3 connect identifier 'cdb3';
configure db_unique_name cdb2 connect identifier 'cdb2';
configure db_unique_name cdb1 connect identifier 'cdb1';
list db_unique_name of database;


Reference
Database Backup and Recovery User's Guide -> Managing a Recovery Catalog
http://docs.oracle.com/database/121/BRADV/rcmcatdb.htm#BRADV89647
http://docs.oracle.com/database/121/BRADV/rcmcatdb.htm#BRADV89654
http://www.dummies.com/how-to/content/basics-of-the-oracle-12c-recovery-manager-rman-cat.html


==========================================================================================================================
===  Create rgihwservice for seamless access 
==========================================================================================================================
How to allow seamless access in sqlplus (OCI) in DG failover

Reference
http://facedba.blogspot.hk/2014/08/faststart-failover-using-dataguard.html
https://www.youtube.com/watch?v=VvYoz9trVnI
http://stackoverflow.com/questions/17718340/jdbc-oracle-thin-client-to-fail-over-to-second-db

Perform the following steps.

-- Create service in primary pdb where service resides. It will be created in standby automatically through DG.
-- Note that the service_name and network_name must be different, other there will be warning in alertlog.
-- The network_name means the service_name in tnsnames.ora
-- The service_name in dbms_service.create_service is just an identifier
EXEC DBMS_SERVICE.CREATE_SERVICE(SERVICE_NAME => 'RGIHWSERVICE', NETWORK_NAME => 'RGIHWSERVICE.LANDS', FAILOVER_METHOD => 'BASIC',  FAILOVER_TYPE => 'SELECT', FAILOVER_RETRIES => 24, FAILOVER_DELAY => 5);
/

-- You can drop service with below command
EXEC DBMS_SERVICE.DELETE_SERVICE(service_name => 'RGIHWSERVICE');
/
   
-- Start the service in primary pdb where service was created
sql> exec dbms_service.START_SERVICE('RGIHWSERVICE');

-- You can drop service with below command
sql> exec dbms_service.STOP_SERVICE('RGIHWSERVICE');

-- Check service created
SELECT NAME,network_name,pdb FROM DBA_SERVICES;

-- Check running services
select inst_id,name,network_name,blocked from gv$active_services;


-- Create procedure in primary pdb to trigger for starting/ stopping service in case of shut down of Primary database.
SQL> 
create or replace procedure p_rgihwservice is
  v_role VARCHAR(30);
begin
  select DATABASE_ROLE into v_role from V$DATABASE;
  if v_role = 'PRIMARY' then
    DBMS_SERVICE.START_SERVICE('RGIHWSERVICE');
  else
    DBMS_SERVICE.STOP_SERVICE('RGIHWSERVICE');
  end if;
end;
/

-- Create triggers in primary pdb to call above procedure when start the database
SQL>  
create or replace TRIGGER trg_rgihwservice_startup
  after startup on database
begin
  p_rgihwservice;
end;
/

-- Create triggers in cdb$root to call above procedure when database role will be changed in the database
-- The db_role_change trigger can only be created in cdb$root. But it need to call the p_rgihwservice
-- in the primary pdb, so need to figure out how. So in this moment, db_role_change has not been created yet.
SQL> 
create or replace TRIGGER trg_rgihwservice_manage_rolechange
  after db_role_change on database
begin
  p_rgihwservice;
end;
/


-- For Application to access seamlessly, in client machine add below entry in tnsnames.ora

DRGIHWSERVICE =
(DESCRIPTION =
   (ADDRESS_LIST=
     (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8124)(PORT = 1521))
     (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8135)(PORT = 1521))
     (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8144)(PORT = 1521))
   )
     (CONNECT_DATA = 
    (SERVER = DEDICATED)
    (SERVICE_NAME = RGIHWSERVICE.lands)
    (FAILOVER_MODE=(TYPE=SELECT)(METHOD=BASIC)(RETRIES=30)(DELAY=5))
     )
)

OR 

DRGIHWSERVICE =
(DESCRIPTION =
   (ADDRESS_LIST=
     (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8124)(PORT = 1521))
     (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8135)(PORT = 1521))
     (ADDRESS = (PROTOCOL = TCP)(HOST = gdat8144)(PORT = 1521))
   )
   (CONNECT_DATA = 
    (SERVICE_NAME = RGIHWSERVICE.lands)
   )
)


-- For Application(sqlplus) to access seamlessly, in client machine add below entry in sqlnet.ora
-- It specifies the connection timeout to 3 seconds
SQLNET.OUTBOUND_CONNECT_TIME=3



==========================================================================================================================
===  Post setup configurations
==========================================================================================================================
-- In primary, setup PASSWORD_LIFE_TIME UNLIMITED
alter session set container=cdb$root;
alter profile DEFAULT limit PASSWORD_LIFE_TIME UNLIMITED;
alter session set container=rgihw;
alter profile DEFAULT limit PASSWORD_LIFE_TIME UNLIMITED;
ALTER DATABASE TEMPFILE '/u03/app/oracle/oradata/cdb1/rgihw/temp01.dbf' autoextend on maxsize 12G;
Note: The changes will be replicated to standby

-- In gfsf8232, PASSWORD_LIFE_TIME UNLIMITED
alter session set container=cdb$root;
alter profile DEFAULT limit PASSWORD_LIFE_TIME UNLIMITED;
alter session set container=rmancat;
alter profile DEFAULT limit PASSWORD_LIFE_TIME UNLIMITED;

-- In primary, configure retention policy and archivelog deletion policy.
rman target / catalog rmancat/rmancat@rmancat
CONFIGURE RETENTION POLICY TO REDUNDANCY 1;
CONFIGURE ARCHIVELOG DELETION POLICY TO APPLIED ON ALL STANDBY BACKED UP 1 TIMES TO DISK;
Note: The change will be replicated to standby.

-- In gfsf8232, setup rman policy for rmandb.
CONFIGURE RETENTION POLICY TO REDUNDANCY 7;
CONFIGURE CONTROLFILE AUTOBACKUP ON;

-- In gfsf8232, turn on flashback for the rmandb. 
ALTER SYSTEM SET UNDO_RETENTION=3600 SCOPE=SPFILE;
ALTER SYSTEM SET UNDO_MANAGEMENT='AUTO' SCOPE=SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
SHOW PARAMETER UNDO;
-- Flashback retention target in minute. 4320 = 3 days
ALTER SYSTEM SET DB_FLASHBACK_RETENTION_TARGET=4320 SCOPE=BOTH;
ALTER DATABASE ARCHIVELOG;
ALTER DATABASE FLASHBACK ON;
ALTER DATABASE OPEN;
ALTER PLUGGABLE DATABASE rmancat open;
ALTER PLUGGABLE DATABASE rmancat SAVE STATE;

-- Set FSFO for cdb3 to cdb1
dgl
connect sys/rGIH201704@cdb1
disable fast_start failover
edit database cdb3 set property FastStartFailoverTarget=cdb1;
enable fast_start failover

-- Set SYNC mode for cdb3
edit database cdb3 set property 'LogXptMode'='SYNC';


==========================================================================================================================
=== Set Oracle parameters for the DG configuration
==========================================================================================================================
There are the parametes you probably need to set after the whole setup done. Make sure they align in the DG config.
-- For gdat8124(cdb1)
alter system set db_file_name_convert='/cdb2/','/cdb1/','/cdb3/','/cdb1/'  scope=spfile;
alter system set log_file_name_convert='/cdb2/','/cdb1/','/cdb3/','/cdb1/' scope=spfile;
alter system set log_archive_config='dg_config=(cdb1,cdb2,cdb3)' scope=both;
alter system set FAL_SERVER=cdb2,cdb3 SCOPE=BOTH;
alter system RESET FAL_CLIENT SCOPE=spfile;
alter system set remote_login_passwordfile='EXCLUSIVE' scope=spfile;
alter system set standby_file_management='AUTO' scope=BOTH;
 
-- For gdat8135(cdb2)
alter system set db_file_name_convert='/cdb1/','/cdb2/','/cdb3/','/cdb2/'  scope=spfile;
alter system set log_file_name_convert='/cdb1/','/cdb2/','/cdb3/','/cdb2/' scope=spfile;
alter system set log_archive_config='dg_config=(cdb1,cdb2,cdb3)' scope=both;
alter system set FAL_SERVER=cdb1,cdb3 SCOPE=BOTH;
alter system RESET FAL_CLIENT SCOPE=spfile;
alter system set remote_login_passwordfile='EXCLUSIVE' scope=spfile;
alter system set standby_file_management='AUTO' scope=BOTH;

-- For gdat8135(cdb3)
alter system set db_file_name_convert='/cdb1/','/cdb3/','/cdb2/','/cdb3/'  scope=spfile;
alter system set log_file_name_convert='/cdb1/','/cdb3/','/cdb2/','/cdb3/' scope=spfile;
alter system set log_archive_config='dg_config=(cdb1,cdb2,cdb3)' scope=both;
alter system set FAL_SERVER=cdb1,cdb2 SCOPE=BOTH;
alter system RESET FAL_CLIENT SCOPE=spfile;
alter system set remote_login_passwordfile='EXCLUSIVE' scope=spfile;
alter system set standby_file_management='AUTO' scope=BOTH;


-- Login to broker to align the settings. Otherwise, the DG broker will display warning
      Warning: ORA-16714: the value of property DbFileNameConvert is inconsistent with the database setting
      Warning: ORA-16714: the value of property LogFileNameConvert is inconsistent with the database setting

-- In DG broker	  
edit database cdb1 set property DbFileNameConvert='/cdb2/,/cdb1/,/cdb3/,/cdb1/';
edit database cdb1 set property LogFileNameConvert='/cdb2/,/cdb1/,/cdb3/,/cdb1/';

edit database cdb2 set property DbFileNameConvert='/cdb1/,/cdb2/,/cdb3/,/cdb2/';
edit database cdb2 set property LogFileNameConvert='/cdb1/,/cdb2/,/cdb3/,/cdb2/';

edit database cdb3 set property DbFileNameConvert='/cdb1/,/cdb3/,/cdb2/,/cdb3/';
edit database cdb3 set property LogFileNameConvert='/cdb1/,/cdb3/,/cdb2/,/cdb3/';


-- Restart the servers to make effective.
-- login gdat8124
shutdown immediate;
startup

-- login gdat8124, gdat8135, gdat8144
shutdown immediate;
startup mount;

Note: The db_file_name_convert, log_file_name_convert, fal_server, fal_client, remote_login_passwordfile, standby_file_management must be set with appropriate values

--- Sample parameters you need to check that they are aligned.
--- gdat8124(primary)
compatible                     12.1.0.2.0
control_file_record_keep_time  7
control_files                  /u03/app/oracle/oradata/cdb1/control01.ctl
control_files                  /u02/app/oracle/fast_recovery_area/cdb1/control02.ctl
db_file_name_convert           /cdb2/
db_file_name_convert           /cdb1/
db_file_name_convert           /cdb3/
db_file_name_convert           /cdb1/
db_name                        cdb1
db_recovery_file_dest          /u02/app/oracle/fast_recovery_area
db_unique_name                 cdb1
dg_broker_config_file1         /u01/app/oracle/product/12.1.0/dbhome_1/dbs/dr1cdb1.dat
dg_broker_config_file2         /u01/app/oracle/product/12.1.0/dbhome_1/dbs/dr2cdb1.dat
dg_broker_start                TRUE
fal_client
fal_server                     CDB2
fal_server                     CDB3
instance_name                  cdb1
log_archive_config             dg_config=(cdb1,cdb2,cdb3)
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2             service="cdb2"
log_archive_dest_2             SYNC AFFIRM delay=0 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb2" net_timeout=30
log_archive_dest_2             valid_for=(online_logfile,all_roles)
log_archive_dest_3             service="cdb3"
log_archive_dest_3             ASYNC NOAFFIRM delay=1 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb3" net_timeout=30
log_archive_dest_3             valid_for=(online_logfile,all_roles)
log_archive_dest_state_1       enable
log_archive_dest_state_2       ENABLE
log_archive_dest_state_3       ENABLE
log_archive_format             %t_%s_%r.dbf
log_archive_trace              0
log_file_name_convert          /cdb2/
log_file_name_convert          /cdb1/
log_file_name_convert          /cdb3/
log_file_name_convert          /cdb1/
remote_login_passwordfile      EXCLUSIVE
spfile                         /u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb1.ora
standby_file_management        AUTO


--- gdat8135(standby)
compatible                     12.1.0.2.0
control_file_record_keep_time  7
control_files                  /u03/app/oracle/oradata/cdb2/control01.ctl
control_files                  /u02/app/oracle/fast_recovery_area/cdb2/control02.ctl
db_file_name_convert           /cdb1/
db_file_name_convert           /cdb2/
db_file_name_convert           /cdb3/
db_file_name_convert           /cdb2/
db_name                        cdb1
db_recovery_file_dest          /u02/app/oracle/fast_recovery_area
db_unique_name                 cdb2
dg_broker_config_file1         /u01/app/oracle/product/12.1.0/dbhome_1/dbs/dr1cdb2.dat
dg_broker_config_file2         /u01/app/oracle/product/12.1.0/dbhome_1/dbs/dr2cdb2.dat
dg_broker_start                TRUE
fal_client
fal_server                     CDB1
fal_server                     CDB3
instance_name                  cdb2
log_archive_config             dg_config=(cdb2,cdb1,cdb3)
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2
log_archive_dest_3
log_archive_dest_state_1       enable
log_archive_dest_state_2       ENABLE
log_archive_dest_state_3       ENABLE
log_archive_format             %t_%s_%r.dbf
log_archive_trace              0
log_file_name_convert          /cdb1/
log_file_name_convert          /cdb2/
log_file_name_convert          /cdb3/
log_file_name_convert          /cdb2/
remote_login_passwordfile      EXCLUSIVE
spfile                         /u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb2.ora
standby_file_management        AUTO


-- gdat8144(standby)
compatible                     12.1.0.2.0
control_file_record_keep_time  7
control_files                  /u03/app/oracle/oradata/cdb3/control01.ctl
control_files                  /u02/app/oracle/fast_recovery_area/cdb3/control02.ctl
db_file_name_convert           /cdb1/
db_file_name_convert           /cdb3/
db_file_name_convert           /cdb2/
db_file_name_convert           /cdb3/
db_name                        cdb1
db_recovery_file_dest          /u02/app/oracle/fast_recovery_area
db_unique_name                 cdb3
dg_broker_config_file1         /u01/app/oracle/product/12.1.0/dbhome_1/dbs/dr1cdb3.dat
dg_broker_config_file2         /u01/app/oracle/product/12.1.0/dbhome_1/dbs/dr2cdb3.dat
dg_broker_start                TRUE
fal_client
fal_server                     CDB1
fal_server                     CDB2
instance_name                  cdb3
log_archive_config             dg_config=(cdb1,cdb2,cdb3)
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2
log_archive_dest_3
log_archive_dest_state_1       enable
log_archive_dest_state_2       ENABLE
log_archive_dest_state_3       ENABLE
log_archive_format             %t_%s_%r.dbf
log_archive_trace              0
log_file_name_convert          /cdb1/
log_file_name_convert          /cdb3/
log_file_name_convert          /cdb2/
log_file_name_convert          /cdb3/
remote_login_passwordfile      EXCLUSIVE
spfile                         /u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb3.ora
standby_file_management        AUTO


==========================================================================================================================
=== Create dba monitor common account
==========================================================================================================================
-- In Primary and gfsf8232
-- creates common user c##dba. The clause CONTAINER=ALL makes the user a common user. (Assume in root container)
CREATE USER c##dbamon IDENTIFIED BY Xy35#Zo54 CONTAINER=ALL;
GRANT CREATE SESSION TO c##dbamon CONTAINER=ALL;
grant RESOURCE to c##dbamon CONTAINER=ALL;
GRANT SELECT_CATALOG_ROLE to c##dbamon CONTAINER=ALL;


==========================================================================================================================
=== Setup backup & monitoring scripts 
==========================================================================================================================
A local copy of the scripts are stored in D:\lands_datal\DGscript, but maybe outdated.

-- In gdat8124
## rman backup everyday
30 01 * * * /home/oracle/script/bkup.sh

## offsite rman backups everyday
15 02 * * * /home/oracle/script/offsite_bkup.sh

## Check alertlog hourly
07 * * * * /home/oracle/script/chk_alert.sh

## Rename database and listener logs on Thursdays
05 19 * * 4 /home/oracle/script/rename_alert.sh

## Check mount point usage hourly
08 * * * * /home/oracle/script/chk_mntpt.sh

## Check database connection every 10 mins
00,10,20,30,40,50 * * * * /home/oracle/script/chk_dg_conn.sh

## Check DG health every 10 mins
02,12,22,32,42,52 * * * * /home/oracle/script/chk_dg.sh

## Check tablespace usages hourly
13 * * * * /home/oracle/script/chk_dg_tsp.sh

## Generate database config files daily
08 21 * * * /home/oracle/script/gen_conf/gen_dg_conf.sh

## Generate awr/addm reports on Sun/Mon/Wed/Fri
09 23 * * 0,1,3,5 /home/oracle/script/gen_awr/gen_dg_awr.sh

## Check switchover/failover every 5 mins
04,09,14,19,24,29,34,39,44,49,54,59 * * * * /home/oracle/script/chk_sofo.sh


-- In gdat8135
## rman backup everyday
00 01 * * * /home/oracle/script/bkup.sh

## offsite rman backups everyday
00 02 * * * /home/oracle/script/offsite_bkup.sh

## Check alertlog hourly
07 * * * * /home/oracle/script/chk_alert.sh

## Rename database and listener logs on Thursdays
05 19 * * 4 /home/oracle/script/rename_alert.sh

## Check mount point usage hourly
08 * * * * /home/oracle/script/chk_mntpt.sh

## Check database connection every 10 mins
00,10,20,30,40,50 * * * * /home/oracle/script/chk_dg_conn.sh

## Check DG health every 10 mins
03,13,23,33,43,53 * * * * /home/oracle/script/chk_dg.sh

## Check tablespace usages hourly
13 * * * * /home/oracle/script/chk_dg_tsp.sh

## Generate database config files daily
08 21 * * * /home/oracle/script/gen_conf/gen_dg_conf.sh

## Generate awr/addm reports on Sun/Mon/Wed/Fri
09 23 * * 0,1,3,5 /home/oracle/script/gen_awr/gen_dg_awr.sh

## Check switchover/failover every 5 mins
04,09,14,19,24,29,34,39,44,49,54,59 * * * * /home/oracle/script/chk_sofo.sh


-- In gdat8144
## rman backup everyday
31 00 * * * /home/oracle/script/bkup.sh

## offsite rman backups everyday
30 01 * * * /home/oracle/script/offsite_bkup.sh

## Check alertlog hourly
07 * * * * /home/oracle/script/chk_alert.sh

## Rename database and listener logs on Thursdays
05 19 * * 4 /home/oracle/script/rename_alert.sh

## Check mount point usage hourly
08 * * * * /home/oracle/script/chk_mntpt.sh

## Check database connection every 10 mins
00,10,20,30,40,50 * * * * /home/oracle/script/chk_dg_conn.sh

## Check DG health every 10 mins
03,13,23,33,43,53 * * * * /home/oracle/script/chk_dg.sh

## Check tablespace usages hourly
13 * * * * /home/oracle/script/chk_dg_tsp.sh

## Generate database config files daily
08 21 * * * /home/oracle/script/gen_conf/gen_dg_conf.sh

## Generate awr/addm reports on Sun/Mon/Wed/Fri
09 23 * * 0,1,3,5 /home/oracle/script/gen_awr/gen_dg_awr.sh

## Check switchover/failover every 5 mins
04,09,14,19,24,29,34,39,44,49,54,59 * * * * /home/oracle/script/chk_sofo.sh



- gfsf8232
## rman backup everyday
00 03 * * * /home/oracle/script/catbkup.sh

## offsite rman backups everyday
30 03 * * * /home/oracle/script/offsite_bkup.sh

## Check database connection every 10 mins
00,10,20,30,40,50 * * * * /home/oracle/script/chk_conn.sh

## Check observer every 10 mins
02,12,22,32,42,52 * * * * /home/oracle/script/chk_observer.sh

## Check alertlog hourly
07 * * * * /home/oracle/script/chk_alert.sh

## Rename database and listener logs on Thursdays
05 19 * * 4 /home/oracle/script/rename_alert.sh

## Check mount point usage hourly
08 * * * * /home/oracle/script/chk_mntpt.sh

## Check tablespace usages hourly
15 * * * * /home/oracle/script/chk_tsp.sh

## Generate database config files daily
08 21 * * * /home/oracle/script/gen_conf/gen_conf.sh

## Generate awr/addm reports on Sun/Mon/Wed/Fri
09 23 * * 0,1,3,5 /home/oracle/script/gen_awr/gen_awr.sh


==========================================================================================================================
===  Setup geodatabase 10.4.1 
==========================================================================================================================
-- As requested by Solomon on 20/6/17, the write db will support "share map" function, so need to configure geodatabase.

Setup geodatabase 10.4.1 through ArcGIS server 10.4.1 machine gmap9112(192.168.30.112)

-- Login to ArcGIS server gmap9112 as gih001

-- Install Oracle client 12.1.0.2(64 bits) in gmap9112 because ArcGIS server 10.4.1 is 64-bit.
Install Path d:\app\client\gih001\product\12.1.0\client_1

-- Create SDE schema in database. Login as Oracel SYS
alter session set container=rgihw;

CREATE TABLESPACE SDE
DATAFILE '/u03/app/oracle/oradata/cdb3/rgihw/SDE01.DBF' SIZE 419430400 REUSE
EXTENT MANAGEMENT LOCAL
AUTOALLOCATE
ONLINE;

create user sde
identified by abc123
default tablespace SDE
temporary tablespace TEMP
account unlock ;

grant CONNECT to sde ;
grant RESOURCE to sde ;

-- PATH variable
C:\Windows\system32>echo %path%
D:\app\client\product\12.1.0\client_1\bin;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Program Files (x86)\Microsoft SQL Server\Client SDK\ODBC\130\Tools\Binn\;C:\Program Files (x86)\Microsoft SQL Server\130\Tools\Binn\;C:\Program Files (x86)\Microsoft SQL Server\130\DTS\Binn\;C:\Program Files (x86)\M
icrosoft SQL Server\130\Tools\Binn\ManagementStudio\

set path=%path%;C:\Python27\ArcGISx6410.4


-- Run Arcpy script in gmap9112 to setup the geodatabase. The keycodes was copied from gmap9112 C:\Program Files (x86)\ESRI\License10.4\sysgen
D:\backup\setup_geodatabase>geodb_gmap9112.py
Installing St_Geometry ....
Successfully installed St_Geometry.


D:\backup\setup_geodatabase>


-- Check geodatabase version
SQL> select * from sde.version;

     MAJOR      MINOR     BUGFIX
---------- ---------- ----------
DESCRIPTION
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   RELEASE SDESVR_REL_LOW
---------- --------------
        10          4          1
10.4.1 Geodatabase
    104002          93001


1 row selected.


-- setup sql access of st_geometry
Run below query as SDE to get the ST_SHAPELIB path 
SELECT library_name, file_spec FROM user_libraries;

-- login as sde
create or replace library st_shapelib as '/u01/app/arcgis/libst_shapelib.so';

As gdat8124,gdat8135,gdat8144 are Linux, 
Copy the C:\Program Files\ArcGIS\Server\DatabaseSupport\Oracle\Linux64\libst_shapelib.so from 30.112 to gdat8124,gdat8135,gdat8144, /u01/app/arcgis/
As the geodatabase is of version 10.4.1, need to copy the same version for libst_shapelib.so                                                    
												   
Modify the $oracle_home/hs/admin/extproc.ora with above path for the extproc_dlls environment variable in gdat8124,gdat8135,gdat8144.
-- example
SET EXTPROC_DLLS=ONLY:/u01/app/arcgis/libst_shapelib.so

Restart the listener in gdat8124,gdat8135,gdat8144

-- run test query 
select sde.ST_AsText(SDE.ST_Geometry('POINT (10 10)', 0)) from dual;

SDE.ST_ASTEXT(SDE.ST_GEOMETRY('POINT(1010)',0))
--------------------------------------------------------------------------------
POINT  ( 10.00000000 10.00000000)

  
Reference

Configure the Oracle extproc to access the geodatabase with SQL
desktop.arcgis.com/en/arcmap/10.4/manage-data/gdbs-in-oracle/configure-oracle-extproc.htm

How to configure ST_GEOMETRY Access for Oracle 64 bit?
http://gis.stackexchange.com/questions/121279/how-to-configure-st-geometry-access-for-oracle-64-bit

FAQ:  When does the Oracle library for st_shapelib.dll need to be changed?
http://support.esri.com/en/knowledgebase/techarticles/detail/35473
  
How to Configure ST_GEOMETRY by Configuring the Oracle extproc to access the geodatabase with SQL?
https://geonet.esri.com/thread/165599



==========================================================================================================================
=== Test switchover,failover,fsfo
==========================================================================================================================
1) Unplanned failover
. Kill ora_smon
. shutdown -r now
. As autostart is enabled, the old primary should be started in MOUNTED mode because it should be prevented to startup normally
. Connect to the new primary dgmgrl and run "reinstate database <old_primary>"
i) james perform failover, uat team test before, in between and after the failover

2) Planned switchover
i) uat team test add record before the switchover
ii) uat team add record but don't hit the save button, james perform switchover, uat team click the save button in between switchover(should fail to save)
iii) uat team test add record after the switchover


-- DG Alertlog string showing switchover
Switchover Complete

-- DG Alertlog string showing failover
Failover Complete
New Primary Site is 


==========================================================================================================================
=== Setup autorestart of Oracle on host reboot
==========================================================================================================================
Setup the startup and shutdown of DG on server reboot. In both gdat8124,gdat8135 and gdat8144 perform below.

Create a file called "/etc/init.d/dbora" as the root user, containing the following code.
------------------------------- /etc/init.d/dbora --------------------------------------------
#!/bin/sh
# chkconfig: 345 99 10
# description: Oracle auto start-stop script.
#
# Set ORA_OWNER to the user id of the owner of the 
# Oracle database software.

ORA_OWNER=oracle

case "$1" in
    'start')
        # Start the Oracle databases:
        # The following command assumes that the oracle login 
        # will not prompt the user for any values
        # Remove "&" if you don't want startup as a background process.
        su $ORA_OWNER -c "/home/oracle/script/startup.sh Y >> /home/oracle/script/startup.log 2>&1" &

        touch /var/lock/subsys/dbora
        ;;
    'stop')
        # Stop the Oracle databases:
        # The following command assumes that the oracle login 
        # will not prompt the user for any values
        su $ORA_OWNER -c "/home/oracle/script/shutdown.sh Y >> /home/oracle/script/shutdown.log 2>&1"
        rm -f /var/lock/subsys/dbora
        ;;
esac
------------------------------- /etc/init.d/dbora --------------------------------------------

chmod 750 /etc/init.d/dbora
chkconfig --add dbora


-- As oracle user, create open_dg.sql
------------------------------- /home/oracle/script/open_dg.sql --------------------------------------------
set serveroutput on
declare
  v_role VARCHAR2(30);
BEGIN
  select DATABASE_ROLE into v_role from V$DATABASE;
  if v_role = 'PRIMARY' then
        dbms_output.put_line('PRIMARY -> ALTER DATABASE OPEN -> ALTER PLUGGABLE DATABASE GISP OPEN READ WRITE');
        EXECUTE IMMEDIATE 'ALTER DATABASE OPEN';
        EXECUTE IMMEDIATE 'ALTER PLUGGABLE DATABASE GISP OPEN READ WRITE';
  else
    dbms_output.put_line('STANDBY -> ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT FROM SESSIONE');
    EXECUTE IMMEDIATE 'ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT FROM SESSION';
  end if;
END;
/
------------------------------- /home/oracle/script/open_dg.sql --------------------------------------------

-- As oracle user, create startup.sh
------------------------------- /home/oracle/script/startup.sh --------------------------------------------
#!/bin/bash

if [ "$1" != "Y" ]
then
 echo "Usage: startup.sh Y"
 exit 99
fi

. ~/.bashrc
cd /home/oracle/script

# Start Listener
lsnrctl start

# Start Database
sqlplus / as sysdba <<EOF
STARTUP MOUNT;
@open_dg.sql
EXIT;
EOF
------------------------------- /home/oracle/script/startup.sh --------------------------------------------


-- As oracle user, create shutdown.sh
------------------------------- /home/oracle/script/shutdown.sh --------------------------------------------
#!/bin/bash

if [ "$1" != "Y" ]
then
 echo "Usage: shutdown.sh Y"
 exit 99
fi

. ~/.bashrc

# Stop Listener
lsnrctl stop

# Stop Database
sqlplus / as sysdba << EOF
SHUTDOWN IMMEDIATE;
EXIT;
EOF
------------------------------- /home/oracle/script/shutdown.sh --------------------------------------------



-- To check service setup, login as root and run to see the runlevel for the dbora service
chkconfig --list dbora

-- runlevel description
D	Name	Description
0	Halt	Shuts down the system.
1	Single-user mode	Mode for administrative tasks.[2][b]
2	Multi-user mode	Does not configure network interfaces and does not export networks services.[c]
3	Multi-user mode with networking	Starts the system normally.[1]
4	Not used/user-definable	For special purposes.
5	Start the system normally with appropriate display manager (with GUI)	Same as runlevel 3 + display manager.
6	Reboot	Reboots the system.

To setup autorestart of gfsf8232, single instance, please refer to document setup_azsg-comndat1.txt

Reference
http://docs.oracle.com/database/121/UNXAR/strt_stp.htm#UNXAR002
https://oracle-base.com/articles/linux/automating-database-startup-and-shutdown-on-linux#Top


==========================================================================================================================
=== Test shutdown and restart of host
==========================================================================================================================
-- This is to test different scenarios of shutting down and powering up the host.
-- Autorestart of Oracle has been setup in gdat8124,gdat8135,gdat8144,gfsf8232

-- Case 1: Run "shutdown -r now" as root
-- The Oracle instance will be terminated(aborted). It will be re-started on host restart.

-- Case 2: Run "shutdown -h now" as root
-- The Oracle instance will be terminated(aborted). It will be re-started on host restart.

-- Case 3: Power off the VM directly
-- The Oracle shutdown script won't be run. The Oracle instance will be terminated.
-- The Oracle instance will be started up when powering on the VM.

Note: As the Oracle instance will be terminated(aborted) on shutdown. It will probably trigger FSFO if it is on the primary.


==========================================================================================================================
=== Apply CPU patch
==========================================================================================================================
The following patches have been deployed to the 4 DG database servers
Patch 26022196 - Database Proactive Bundle Patch 12.1.0.2.170718
Patch 26027162 - Oracle JavaVM Component 12.1.0.2.170718 Database PSU

For details, please refer to below documents in D:\lands_datal
DBBP12.1.0.2.170718_Linux(x64)_DG.txt
DBBP12.1.0.2.170718_Linux(x64).txt
12102_OJVM_12.1.0.2.170718(Linux_x64)_DG.txt
12102_OJVM_12.1.0.2.170718(Linux_x64).txt

==========================================================================================================================
=== Setup rgihapp schema and Import data
==========================================================================================================================
-- Refer to setup_gdat1053.txt (the UAT db)

-- Create RGIHAPP for rGIH. 
CREATE TABLESPACE rgihapp
DATAFILE '/u03/app/oracle/oradata/cdb1/rgihw/rgihapp01.dbf' SIZE 536870912 REUSE
EXTENT MANAGEMENT LOCAL
UNIFORM SIZE 524288
ONLINE;

alter database DATAFILE '/u03/app/oracle/oradata/cdb1/rgihw/rgihapp01.dbf' resize 4G;

create user rgihapp
identified by rgihapp123
default tablespace rgihapp
temporary tablespace TEMP
account unlock ;

grant CONNECT to rgihapp ;
grant RESOURCE to rgihapp ;
grant CREATE VIEW to rgihapp ;
ALTER USER rgihapp quota unlimited on rgihapp;
grant SELECT_CATALOG_ROLE to rgihapp;

-- Create RUSER for rGIH. 
CREATE TABLESPACE ruser
DATAFILE '/u03/app/oracle/oradata/cdb1/rgihw/ruser01.dbf' SIZE 536870912 REUSE
EXTENT MANAGEMENT LOCAL
UNIFORM SIZE 524288
ONLINE;

create user ruser
identified by ruser123
default tablespace ruser
temporary tablespace TEMP
account unlock ;

grant CONNECT to ruser ;
grant SELECT_CATALOG_ROLE to ruser ;
grant CREATE VIEW to ruser ;
grant CREATE SYNONYM to ruser ;
ALTER USER ruser quota unlimited on ruser;



CREATE TABLESPACE rdbsupp
DATAFILE '/u03/app/oracle/oradata/cdb1/rgihw/rdbsupp01.dbf' SIZE 536870912 REUSE
EXTENT MANAGEMENT LOCAL
UNIFORM SIZE 524288
ONLINE;

create user rdbsupp
identified by rdbsupp123
default tablespace rdbsupp
temporary tablespace TEMP
account unlock ;

grant CONNECT to rdbsupp ;
grant RESOURCE to rdbsupp ;
grant CREATE VIEW to rdbsupp ;
ALTER USER rdbsupp quota unlimited on rdbsupp;
grant SELECT_CATALOG_ROLE to rdbsupp;


-- Create RVIEW for rGIH 
CREATE TABLESPACE RVIEW
DATAFILE '/u03/app/oracle/oradata/cdb1/rgihw/rview01.dbf' SIZE 536870912 REUSE
EXTENT MANAGEMENT LOCAL
UNIFORM SIZE 524288
ONLINE;


create user RVIEW
identified by rview123
default tablespace RVIEW
temporary tablespace TEMP
account unlock ;


grant SELECT_CATALOG_ROLE to rview ;
grant CONNECT to rview ;

grant CREATE VIEW to rview ;
grant CREATE SYNONYM to rview ;


-------------------------------------------------------------------------------------------------------------------------
-- On 5/9/17, export rgih-db2 rgihapp and import to gdat8124(the primary)  
-------------------------------------------------------------------------------------------------------------------------

d:
mkdir d:\export
cd d:\export
expdp \"sys/govmap$3V21@rgihdb2pdb as sysdba\" parfile=rgihappparfile2.par 

Note: It is better to put the parameters in the parfile to avoid using too many escape characters.

rgihappparfile2.par
------------------
schemas=rgihapp
INCLUDE=TABLE:"in (select table_name from dba_tables where (table_name like 'TBL_%' or table_name like 'RLT_%' or table_name like 'LKU_%' or table_name like 'TMP_%') and owner='RGIHAPP')"
INCLUDE=SEQUENCE:"in (select object_name from dba_objects where owner='RGIHAPP' and object_type='SEQUENCE' and (object_name like 'TBL_%' or object_name like 'BATCH_%'))" 
directory=XSDDIR  
dumpfile=rgih-db2_rgihapp.dmp 
logfile=rgih-db2_rgihapp.log

-- Copy the dumpfile in c:\app\gsadmin\product\12.1.0\dbhome_1/rdbms/xml/schema to gdat8124 XSDDIR /u01/app/oracle/product/12.1.0/dbhome_1/rdbms/xml/schema

-- login to gdat8124, delete any objects in rgihapp first, then import the exported objects
impdp \"sys/rGIH201704@rgihwservice_sit as sysdba\" schemas=rgihapp directory=XSDDIR dumpfile=RGIH-DB2_RGIHAPP.DMP logfile=gdat8124_rgihapp.log

Processing object type SCHEMA_EXPORT/SEQUENCE/SEQUENCE
Processing object type SCHEMA_EXPORT/SEQUENCE/GRANT/OWNER_GRANT/OBJECT_GRANT
Processing object type SCHEMA_EXPORT/TABLE/TABLE
Processing object type SCHEMA_EXPORT/TABLE/TABLE_DATA
. . imported "RGIHAPP"."TBL_SYS_ACTIVITY_LOG"            3.359 MB   24093 rows
. . imported "RGIHAPP"."TBL_APPMGT_SESSION_ATTRIBUTES"   182.2 KB      29 rows
. . imported "RGIHAPP"."TBL_BATCH_EMAIL"                 86.00 KB     107 rows
. . imported "RGIHAPP"."TBL_GEOXPR_MARKER_LINE"          33.07 KB       7 rows
. . imported "RGIHAPP"."TBL_GEOXPR_MARKER_POINT"         73.39 KB      31 rows
. . imported "RGIHAPP"."TBL_GEOXPR_MARKER_POLYGON"       40.37 KB      10 rows
. . imported "RGIHAPP"."LKU_SYS_3D_MODEL_TYPE"           6.960 KB       3 rows
. . imported "RGIHAPP"."LKU_SYS_DEPT"                    7.921 KB      12 rows
. . imported "RGIHAPP"."LKU_SYS_MODULE"                  9.101 KB      10 rows
. . imported "RGIHAPP"."LKU_SYS_PTLMSG_PRIORITY"         6.945 KB       3 rows
. . imported "RGIHAPP"."LKU_SYS_PTLMSG_TYPE"             6.929 KB       3 rows
. . imported "RGIHAPP"."LKU_SYS_SMOSECTION"              7.523 KB      20 rows
. . imported "RGIHAPP"."RLT_APPMGT_GROUP_RIGHT"          15.03 KB     177 rows
. . imported "RGIHAPP"."RLT_APPMGT_GROUP_USER"           36.23 KB     679 rows
. . imported "RGIHAPP"."RLT_APPMGT_MAP_SERVICE_ACCESS"       0 KB       0 rows
. . imported "RGIHAPP"."RLT_APPMGT_PTLMSG_ACCESS"        6.992 KB      24 rows
. . imported "RGIHAPP"."RLT_APPMGT_USER_BIND"            6.429 KB       2 rows
. . imported "RGIHAPP"."RLT_SYS_DS_MOD"                  7.265 KB       1 rows
. . imported "RGIHAPP"."RLT_SYS_MAPLYR_MOD"              10.34 KB     152 rows
. . imported "RGIHAPP"."TBL_APPMGT_3D_MODEL"             11.57 KB       3 rows
. . imported "RGIHAPP"."TBL_APPMGT_ACCESS_RIGHT"         24.24 KB     147 rows
. . imported "RGIHAPP"."TBL_APPMGT_APP_LIST"             11.34 KB      10 rows
. . imported "RGIHAPP"."TBL_APPMGT_CONTACT"              8.921 KB       5 rows
. . imported "RGIHAPP"."TBL_APPMGT_PTLMSG"               11.13 KB       2 rows
. . imported "RGIHAPP"."TBL_APPMGT_RIBBON_ITEM"          25.10 KB      50 rows
. . imported "RGIHAPP"."TBL_APPMGT_SESSION"              8.804 KB      29 rows
. . imported "RGIHAPP"."TBL_APPMGT_USER_DETAIL"          36.25 KB     254 rows
. . imported "RGIHAPP"."TBL_APPMGT_USER_GROUP"           11.88 KB      21 rows
. . imported "RGIHAPP"."TBL_APPMGT_USER_INFO"            48.32 KB     254 rows
. . imported "RGIHAPP"."TBL_CAT_LINK"                    14.12 KB     112 rows
. . imported "RGIHAPP"."TBL_CAT_LIST"                    6.007 KB       4 rows
. . imported "RGIHAPP"."TBL_ENQ_SAVE"                    21.93 KB      12 rows
. . imported "RGIHAPP"."TBL_ENQ_SHARE"                   6.828 KB       1 rows
. . imported "RGIHAPP"."TBL_GEOXPR_LEGEND"               10.31 KB      13 rows
. . imported "RGIHAPP"."TBL_ONESTP_DAP_THUMBNAIL"        6.468 KB       1 rows
. . imported "RGIHAPP"."TBL_ONESTP_PARAM"                18.71 KB      16 rows
. . imported "RGIHAPP"."TBL_SYS_CONFIG"                  9.968 KB      18 rows
. . imported "RGIHAPP"."TBL_SYS_DSOURCE"                 11.53 KB       4 rows
. . imported "RGIHAPP"."TBL_SYS_LIC_ACL"                 14.96 KB      27 rows
. . imported "RGIHAPP"."TBL_SYS_MAPLYR"                  39.77 KB     225 rows
. . imported "RGIHAPP"."TBL_SYS_MAPLYR_CAT"              8.796 KB      35 rows
. . imported "RGIHAPP"."TBL_SYS_MAPLYR_MOD"              12.34 KB     228 rows
. . imported "RGIHAPP"."TBL_USER_LAYER_ORDER"            12.21 KB      12 rows
. . imported "RGIHAPP"."TMP_ONESTP_DAP_THUMBNAIL"        6.953 KB       2 rows
. . imported "RGIHAPP"."TMP_SYS_SPECIAL_URL"             16.99 KB      61 rows
. . imported "RGIHAPP"."RLT_APPMEG_MAP_LAYER_CATEGORY"       0 KB       0 rows
. . imported "RGIHAPP"."TBL_APPMGT_USER_PREF"                0 KB       0 rows
Processing object type SCHEMA_EXPORT/TABLE/GRANT/OWNER_GRANT/OBJECT_GRANT
Processing object type SCHEMA_EXPORT/TABLE/COMMENT
Processing object type SCHEMA_EXPORT/TABLE/IDENTITY_COLUMN
Processing object type SCHEMA_EXPORT/TABLE/INDEX/INDEX
Processing object type SCHEMA_EXPORT/TABLE/CONSTRAINT/CONSTRAINT
Processing object type SCHEMA_EXPORT/TABLE/INDEX/STATISTICS/INDEX_STATISTICS
Processing object type SCHEMA_EXPORT/TABLE/CONSTRAINT/REF_CONSTRAINT
Processing object type SCHEMA_EXPORT/TABLE/TRIGGER
Processing object type SCHEMA_EXPORT/TABLE/STATISTICS/TABLE_STATISTICS
Job "SYS"."SYS_IMPORT_SCHEMA_01" successfully completed at Tue Sep 5 16:00:36 2017 elapsed 0 00:00:30


-- Create the BATCH_* tables in following order
BATCH_JOB_INSTANCE
BATCH_JOB_EXECUTION
BATCH_JOB_EXECUTION_CONTEXT
BATCH_JOB_EXECUTION_PARAMS
BATCH_STEP_EXECUTION
BATCH_STEP_EXECUTION_CONTEXT


-- Checking in rgih-db2 and gdat8124 to compare objects
set pages 2000 lines 200
column object_type format a40
column object_name format a40
select object_type,object_name from dba_objects where owner='RGIHAPP' and object_type in ('TABLE','SEQUENCE') and 
(object_name like 'TBL_%' or object_name like 'RLT_%' or object_name like 'LKU_%' or object_name like 'TMP_%' or object_name like 'BATCH_%') order by 1,2;

OBJECT_TYPE                              OBJECT_NAME
---------------------------------------- ----------------------------------------
SEQUENCE                                 BATCH_JOB_EXECUTION_SEQ
SEQUENCE                                 BATCH_JOB_SEQ
SEQUENCE                                 BATCH_STEP_EXECUTION_SEQ
TABLE                                    BATCH_JOB_EXECUTION
TABLE                                    BATCH_JOB_EXECUTION_CONTEXT
TABLE                                    BATCH_JOB_EXECUTION_PARAMS
TABLE                                    BATCH_JOB_INSTANCE
TABLE                                    BATCH_STEP_EXECUTION
TABLE                                    BATCH_STEP_EXECUTION_CONTEXT
TABLE                                    LKU_SYS_3D_MODEL_TYPE
TABLE                                    LKU_SYS_DEPT
TABLE                                    LKU_SYS_MODULE
TABLE                                    LKU_SYS_PTLMSG_PRIORITY
TABLE                                    LKU_SYS_PTLMSG_TYPE
TABLE                                    LKU_SYS_SMOSECTION
TABLE                                    RLT_APPMEG_MAP_LAYER_CATEGORY
TABLE                                    RLT_APPMGT_GROUP_RIGHT
TABLE                                    RLT_APPMGT_GROUP_USER
TABLE                                    RLT_APPMGT_MAP_SERVICE_ACCESS
TABLE                                    RLT_APPMGT_PTLMSG_ACCESS
TABLE                                    RLT_APPMGT_USER_BIND
TABLE                                    RLT_SYS_DS_MOD
TABLE                                    RLT_SYS_MAPLYR_MOD
TABLE                                    TBL_APPMGT_3D_MODEL
TABLE                                    TBL_APPMGT_ACCESS_RIGHT
TABLE                                    TBL_APPMGT_APP_LIST
TABLE                                    TBL_APPMGT_CONTACT
TABLE                                    TBL_APPMGT_PTLMSG
TABLE                                    TBL_APPMGT_RIBBON_ITEM
TABLE                                    TBL_APPMGT_SESSION
TABLE                                    TBL_APPMGT_SESSION_ATTRIBUTES
TABLE                                    TBL_APPMGT_USER_DETAIL
TABLE                                    TBL_APPMGT_USER_GROUP
TABLE                                    TBL_APPMGT_USER_INFO
TABLE                                    TBL_APPMGT_USER_PREF
TABLE                                    TBL_BATCH_EMAIL
TABLE                                    TBL_CAT_LINK
TABLE                                    TBL_CAT_LIST
TABLE                                    TBL_ENQ_SAVE
TABLE                                    TBL_ENQ_SHARE
TABLE                                    TBL_GEOXPR_LEGEND
TABLE                                    TBL_GEOXPR_MARKER_LINE
TABLE                                    TBL_GEOXPR_MARKER_POINT
TABLE                                    TBL_GEOXPR_MARKER_POLYGON
TABLE                                    TBL_ONESTP_DAP_THUMBNAIL
TABLE                                    TBL_ONESTP_PARAM
TABLE                                    TBL_SYS_ACTIVITY_LOG
TABLE                                    TBL_SYS_CONFIG
TABLE                                    TBL_SYS_DSOURCE
TABLE                                    TBL_SYS_LIC_ACL
TABLE                                    TBL_SYS_MAPLYR
TABLE                                    TBL_SYS_MAPLYR_CAT
TABLE                                    TBL_SYS_MAPLYR_MOD
TABLE                                    TBL_USER_LAYER_ORDER
TABLE                                    TMP_ONESTP_DAP_THUMBNAIL
TABLE                                    TMP_SYS_SPECIAL_URL

56 rows selected.


Also, one trigger
TBL_SYS_ACTIVITY_LOG_TRG

-- Run SQLs in "Grant privileges to ruser" section to grant priv and create synonyms.

-- Create dblink synonyms in rgih-db1

==========================================================================================================================
===  Grant privileges to ruser
==========================================================================================================================
-- On 29/5/17, grant read write privilege to ruser on all RGIHAPP tables and sequences and create synonyms  
-- Grant select,insert,delete,update privilege to ruser on all RGIHAPP tables and create synonyms  
select 'grant select,insert,delete,update on ' || 'RGIHAPP.' || object_name || ' to RUSER;' from dba_objects 
where owner='RGIHAPP' and object_type='TABLE' and object_name not like 'S%_IDX$' and object_name not like 'SDE_LOGFILE%' order by object_name;

select 'create or replace synonym RUSER.' || object_name || ' for RGIHAPP.' || object_name || ';' from dba_objects 
where owner='RGIHAPP' and object_type='TABLE' and object_name not like 'S%_IDX$' and object_name not like 'SDE_LOGFILE%' order by object_name ;

select 'grant select on ' || 'RGIHAPP.' || object_name || ' to RUSER;' from dba_objects 
where owner='RGIHAPP' and object_type='SEQUENCE' and object_name not like 'ISEQ$$_%' order by object_name;

select 'create or replace synonym RUSER.' || object_name || ' for RGIHAPP.' || object_name || ';' from dba_objects 
where owner='RGIHAPP' and object_type='SEQUENCE' and object_name not like 'ISEQ$$_%' order by object_name ;

-- For RDBSUPP which is used by DB Team
grant DELETE on RGIHAPP.TBL_CAT_LINK to RDBSUPP  ;
grant DELETE on RGIHAPP.TBL_SYS_DSOURCE to RDBSUPP  ;
grant DELETE on RGIHAPP.TBL_SYS_LIC_ACL to RDBSUPP  ;
grant DELETE on RGIHAPP.TBL_SYS_MAPLYR to RDBSUPP  ;
grant DELETE on RGIHAPP.TBL_SYS_MAPLYR_CAT to RDBSUPP  ;
grant DELETE on RGIHAPP.TBL_SYS_MAPLYR_MOD to RDBSUPP  ;
grant INSERT on RGIHAPP.TBL_CAT_LINK to RDBSUPP  ;
grant INSERT on RGIHAPP.TBL_SYS_DSOURCE to RDBSUPP  ;
grant INSERT on RGIHAPP.TBL_SYS_LIC_ACL to RDBSUPP  ;
grant INSERT on RGIHAPP.TBL_SYS_MAPLYR to RDBSUPP  ;
grant INSERT on RGIHAPP.TBL_SYS_MAPLYR_CAT to RDBSUPP  ;
grant INSERT on RGIHAPP.TBL_SYS_MAPLYR_MOD to RDBSUPP  ;
grant SELECT on RGIHAPP.TBL_CAT_LINK to RDBSUPP  ;
grant SELECT on RGIHAPP.TBL_SYS_DSOURCE to RDBSUPP  ;
grant SELECT on RGIHAPP.TBL_SYS_LIC_ACL to RDBSUPP  ;
grant SELECT on RGIHAPP.TBL_SYS_MAPLYR to RDBSUPP  ;
grant SELECT on RGIHAPP.TBL_SYS_MAPLYR_CAT to RDBSUPP  ;
grant SELECT on RGIHAPP.TBL_SYS_MAPLYR_MOD to RDBSUPP  ;
grant UPDATE on RGIHAPP.TBL_CAT_LINK to RDBSUPP  ;
grant UPDATE on RGIHAPP.TBL_SYS_DSOURCE to RDBSUPP  ;
grant UPDATE on RGIHAPP.TBL_SYS_LIC_ACL to RDBSUPP  ;
grant UPDATE on RGIHAPP.TBL_SYS_MAPLYR to RDBSUPP  ;
grant UPDATE on RGIHAPP.TBL_SYS_MAPLYR_CAT to RDBSUPP  ;
grant UPDATE on RGIHAPP.TBL_SYS_MAPLYR_MOD to RDBSUPP  ;


==========================================================================================================================
=== Remove Oracle Kernel parameters from /etc/sysctl.conf in post installation
==========================================================================================================================
In gdat8124, gdat8135, gdat8144 and gfsf8232, remove the Oracle Kernel parameters from /etc/sysctl.conf

Put them into /etc/sysctl.d/98-oracle.conf
 
sysctl -p /etc/sysctl.conf



==========================================================================================================================
=== Disable Transparent HugePages in /etc/sysconfig/grub 
==========================================================================================================================
Check current status of HugePages
cat /proc/cmdline

- modifying to the file /etc/default/grub. Add "transparent_hugepage=never" to the file. 
GRUB_CMDLINE_LINUX="rd.lvm.lv=rhel/root rd.lvm.lv=rhel/swap vconsole.font=latarcyrheb-sun16 vconsole.keymap=us transparent_hugepage=never"

- Run the grub2-mkconfig command to regenerate the grub.cfg file:
grub2-mkconfig -o /boot/grub2/grub.cfg

The reboot to make it effective.

Check status again to make sure "never" is the output
cat /proc/cmdline
cat /sys/kernel/mm/transparent_hugepage/enabled

Reference
https://access.redhat.com/solutions/1320153


==========================================================================================================================
===  About FAL_SERVER, FAL_CLIENT 
==========================================================================================================================
http://chandu208.blogspot.hk/2011/07/data-guard-gap-detection-and-resolution.html

FAL_SERVER and FAL_SERVER are used in gap resolution.

FAL_SERVER:  An OracleNet service name that exist in the standby tnsnames.ora file that points to the primary db listener. The FAL_SERVER parameter can contain a comma delimited list of locations that should be attempted during gap resolution.

FAL_CLIENT:   An OracleNet service name that exist in the primary tnsnames.ora file that points to the standby database listener. The value of FAL_CLIENT should also be listed as the service in a remote archive destination pointing to the standby.

Once MRP needs to resolve a gap it uses the value from FAL_SERVER to call the primary database. Once communication with the primary has been established, MRP passes the FAL_CLIENT value to the primary ARCH process. The primary ARCH process locates the remote archive destination with the corresponding service name and ships the missing archived redo logs. If the first destination listed in FAL_SERVER is unable to resolve the gap then the next destination is attempted until either the gap is resolved or all FAL_SERVER destination have been tried.

As of 9.2.0 FAL Gap Resolution only works with Physical Standby databases as the process is tied to MRP. Gap recovery on a logical standby database is  handled through the heartbeat mechanism.

Note that FAL_CLIENT is not required in 12c. Please refer below link for reference
https://docs.oracle.com/database/121/SBYDB/init_params.htm#SBYDB4901

-----------------------------------------------------------------------------------------------------
-- How to setup them in multiple standbys
-----------------------------------------------------------------------------------------------------
-- In gdat8124(cdb1)
FAL_SERVER=cdb2,cdb3
FAL_CLIENT=cdb1

-- In gdat8135(cdb2)
FAL_SERVER=cdb1,cdb3
FAL_CLIENT=cdb2

-- In gdat8144(cdb3)
FAL_SERVER=cdb1,cdb2
FAL_CLIENT=cdb3


==========================================================================================================================
===  About DB_FILE_NAME_CONVERT, LOG_FILE_NAME_CONVERT 
==========================================================================================================================
They are used by standbys for name conversion.

-----------------------------------------------------------------------------------------------------
-- How to setup them in multiple standbys
-----------------------------------------------------------------------------------------------------
-- In gdat8124(cdb1)
alter system set db_file_name_convert='/cdb2/','/cdb1/','/cdb3/','/cdb1/'  scope=spfile;
alter system set log_file_name_convert='/cdb2/','/cdb1/','/cdb3/','/cdb1/' scope=spfile;

-- In gdat8135(cdb2)
alter system set db_file_name_convert='/cdb1/','/cdb2/','/cdb3/','/cdb2/'  scope=spfile;
alter system set log_file_name_convert='/cdb1/','/cdb2/','/cdb3/','/cdb2/' scope=spfile;

-- In gdat8144(cdb3)
alter system set db_file_name_convert='/cdb1/','/cdb3/','/cdb2/','/cdb3/'  scope=spfile;
alter system set log_file_name_convert='/cdb1/','/cdb3/','/cdb2/','/cdb3/' scope=spfile;

If not set properly, new datafile created in primary will not be converted properly to standbys.

Note: Need to set in DG broker also. Otherwise warnings.

==========================================================================================================================
===  Sync data from prod to SIT
==========================================================================================================================
As requested by Solo at 23/1/18, sync data from prod to SIT before prod rollout. Use the prod export at gdat1220, 
/u01/app/oracle/product/12.1.0/dbhome_1/rdbms/xml/schema/rgihw_rgihapp_prd_data_only_20180119_1600.dmp to sync SIT


Procedure
0. Lock ruser and rdbsupp accounts. Restart to kill all existing sessions
1. Disable all FK constraints first before truncate
2. Truncate data for some tables, the "Schema Only" ones specified in Solo's excel
3. Import data
4. Enable FK constraints 
5. Reset the identity column values based on max id in their tables
6. Generate the rights and synonyms
7. Unlock ruser and rdbsupp accounts

-- Lock accounts
alter user ruser account lock;
alter user rdbsupp account lock;

-- Generate the disable FK statements. Login to the prod rgihw as SYS and change to rgihw container.
select 'ALTER TABLE rgihapp.' || table_name || ' MODIFY CONSTRAINT ' || constraint_name || ' DISABLE;' from dba_constraints where owner='RGIHAPP' and constraint_type='R' order by  table_name;

ALTER TABLE rgihapp.RLT_APPMGT_GROUP_RIGHT MODIFY CONSTRAINT RLT_APPMGT_GROUP_RIGHT_FK2 DISABLE;
ALTER TABLE rgihapp.RLT_APPMGT_GROUP_RIGHT MODIFY CONSTRAINT RLT_APPMGT_GROUP_RIGHT_FK1 DISABLE;
ALTER TABLE rgihapp.TBL_APPMGT_SESSION_ATTRIBUTES MODIFY CONSTRAINT SPRING_SESSION_ATTRIBUTES_FK DISABLE;

-- Get current identity columns info
@tab_identity_cols

SYS@RGIHWSERVICE_SIT:SQL> @tab_identity_cols
Enter value for 1: RGIHAPP
old   8: WHERE  a.owner = upper('&&1') and a.owner = b.sequence_owner and a.sequence_name = b.sequence_name and b.sequence_name like 'ISEQ%'
new   8: WHERE  a.owner = upper('RGIHAPP') and a.owner = b.sequence_owner and a.sequence_name = b.sequence_name and b.sequence_name like 'ISEQ%'

TABLE_NAME                     COLUMN_NAME                    SEQUENCE_NAME         LAST_NUMBER GENERATION IDENTITY_OPTIONS
------------------------------ ------------------------------ -------------------- ------------ ---------- --------------------------------------------------
LKU_SYS_MODULE                 MOD_ID                         ISEQ$$_95152                   12 BY DEFAULT START WITH: 12, INCREMENT BY: 1, MAX_VALUE: 999999
                                                                                                           99999999, MIN_VALUE: 1, CYCLE_FLAG: N, CACHE_SIZE:
                                                                                                            0, ORDER_FLAG: N

RLT_APPMEG_MAP_LAYER_CATEGORY  LAYER_CATEGORY_ID              ISEQ$$_95130                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_APPMGT_ACCESS_RIGHT        ACCESS_ID                      ISEQ$$_95110                  801 BY DEFAULT START WITH: 708, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           99999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                            N, CACHE_SIZE: 0, ORDER_FLAG: N

TBL_APPMGT_CONTACT             CONTACT_ID                     ISEQ$$_95101                1,534 BY DEFAULT START WITH: 1534, INCREMENT BY: 1, MAX_VALUE: 9999
                                                                                                           99999999999, MIN_VALUE: 1, CYCLE_FLAG: N, CACHE_SI
                                                                                                           ZE: 0, ORDER_FLAG: N

TBL_APPMGT_PTLMSG              PTLMSG_ID                      ISEQ$$_95134                  579 BY DEFAULT START WITH: 419, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           99999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                            N, CACHE_SIZE: 20, ORDER_FLAG: N

TBL_APPMGT_USER_GROUP          USER_GROUP_ID                  ISEQ$$_95117                  298 BY DEFAULT START WITH: 257, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           99999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                            N, CACHE_SIZE: 0, ORDER_FLAG: N

TBL_APPMGT_USER_INFO           USER_ID                        ISEQ$$_95114                1,684 BY DEFAULT START WITH: 1557, INCREMENT BY: 1, MAX_VALUE: 9999
                                                                                                           999999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG
                                                                                                           : N, CACHE_SIZE: 0, ORDER_FLAG: N

TBL_BATCH_EMAIL                ID                             ISEQ$$_95167                1,482 BY DEFAULT START WITH: 341, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           99999, MIN_VALUE: 1, CYCLE_FLAG: N, CACHE_SIZE: 20
                                                                                                           , ORDER_FLAG: N

TBL_CAT_LINK                   CAT_ID                         ISEQ$$_95106                  113 BY DEFAULT START WITH: 113, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           99999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                            N, CACHE_SIZE: 20, ORDER_FLAG: N

TBL_DOWNLOAD_COUNT             ID                             ISEQ$$_95404                4,640 BY DEFAULT START WITH: 1557, INCREMENT BY: 1, MAX_VALUE: 9999
                                                                                                           999999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG
                                                                                                           : N, CACHE_SIZE: 0, ORDER_FLAG: N

TBL_ENQ_SAVE                   ENQ_ID                         ISEQ$$_95122                  769 BY DEFAULT START WITH: 329, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           99999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                            N, CACHE_SIZE: 20, ORDER_FLAG: N

TBL_ENQ_SHARE                  ENQ_SHARE_ID                   ISEQ$$_95126                  367 BY DEFAULT START WITH: 102, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           99999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                            Y, CACHE_SIZE: 20, ORDER_FLAG: N

TBL_GEOXPR_LEGEND              ID                             ISEQ$$_95145                  314 BY DEFAULT START WITH: 14, INCREMENT BY: 1, MAX_VALUE: 999999
                                                                                                           9999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                           N, CACHE_SIZE: 20, ORDER_FLAG: N

TBL_GEOXPR_MARKER_LINE         MARKER_ID                      ISEQ$$_95171                   91 BY DEFAULT START WITH: 8, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 0, ORDER_FLAG: N

TBL_GEOXPR_MARKER_POINT        MARKER_ID                      ISEQ$$_95175                  309 BY DEFAULT START WITH: 40, INCREMENT BY: 1, MAX_VALUE: 999999
                                                                                                           9999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                           N, CACHE_SIZE: 0, ORDER_FLAG: N

TBL_GEOXPR_MARKER_POLYGON      MARKER_ID                      ISEQ$$_95179                  170 BY DEFAULT START WITH: 11, INCREMENT BY: 1, MAX_VALUE: 999999
                                                                                                           9999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                           N, CACHE_SIZE: 0, ORDER_FLAG: N

TBL_GEOXPR_MARKER_SAVE         PROFILE_ID                     ISEQ$$_95654                  601 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_GEOXPR_MARKER_SHARE        PROFILE_SHARE_ID               ISEQ$$_95656                  201 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_ONESTP_DAP_THUMBNAIL       ID                             ISEQ$$_95138                    2 BY DEFAULT START WITH: 2, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 0, ORDER_FLAG: N

TBL_ONESTP_PARAM               PARAM_ID                       ISEQ$$_95136                6,732 BY DEFAULT START WITH: 2024, INCREMENT BY: 1, MAX_VALUE: 9999
                                                                                                           999999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG
                                                                                                           : N, CACHE_SIZE: 0, ORDER_FLAG: N

TBL_SYS_ACTIVITY_LOG           ACT_ID                         ISEQ$$_95157              131,743 BY DEFAULT START WITH: 98493, INCREMENT BY: 1, MAX_VALUE: 999
                                                                                                           999999, MIN_VALUE: 1, CYCLE_FLAG: N, CACHE_SIZE: 0
                                                                                                           , ORDER_FLAG: N

TBL_SYS_DSOURCE                SRC_ID                         ISEQ$$_95098                  145 BY DEFAULT START WITH: 136, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           9999999999, MIN_VALUE: 1, CYCLE_FLAG: N, CACHE_SIZ
                                                                                                           E: 0, ORDER_FLAG: N

TBL_USER_LAYER_ORDER           ORDER_ID                       ISEQ$$_95124                  586 BY DEFAULT START WITH: 126, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           99999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                            N, CACHE_SIZE: 20, ORDER_FLAG: N

TMP_ONESTP_DAP_THUMBNAIL       ID                             ISEQ$$_95140                    3 BY DEFAULT START WITH: 3, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 0, ORDER_FLAG: N


24 rows selected.

-- Truncate tables, keep the TBL_SYS_DSOURCE and TBL_SYS_LIC_ACL tables
truncate table rgihapp.BATCH_JOB_EXECUTION ;
truncate table rgihapp.BATCH_JOB_EXECUTION_CONTEXT ;
truncate table rgihapp.BATCH_JOB_EXECUTION_PARAMS ;
truncate table rgihapp.BATCH_JOB_INSTANCE ;
truncate table rgihapp.BATCH_STEP_EXECUTION ;
truncate table rgihapp.BATCH_STEP_EXECUTION_CONTEXT ;
truncate table rgihapp.RLT_APPMGT_USER_BIND ;
truncate table rgihapp.RLT_SYS_DS_MOD ;
truncate table rgihapp.TBL_APPMGT_3D_MODEL ;
truncate table rgihapp.TBL_APPMGT_CONTACT ;
truncate table rgihapp.TBL_APPMGT_SESSION ;
truncate table rgihapp.TBL_APPMGT_SESSION_ATTRIBUTES ;
truncate table rgihapp.TBL_APPMGT_USER_PREF ;
truncate table rgihapp.TBL_BATCH_EMAIL ;
truncate table rgihapp.TBL_DOWNLOAD_COUNT ;
truncate table rgihapp.TBL_ENQ_SAVE ;
truncate table rgihapp.TBL_ENQ_SHARE ;
truncate table rgihapp.TBL_GEOXPR_MARKER_LINE ;
truncate table rgihapp.TBL_GEOXPR_MARKER_POINT ;
truncate table rgihapp.TBL_GEOXPR_MARKER_POLYGON ;
truncate table rgihapp.TBL_GEOXPR_MARKER_SAVE ;
truncate table rgihapp.TBL_GEOXPR_MARKER_SHARE ;
truncate table rgihapp.TBL_ONESTP_DAP_THUMBNAIL ;
truncate table rgihapp.TBL_ONESTP_PARAM ;
truncate table rgihapp.TBL_SYS_ACTIVITY_LOG ;
truncate table rgihapp.TBL_USER_LAYER_ORDER ;
truncate table rgihapp.TMP_ONESTP_DAP_THUMBNAIL ;
truncate table rgihapp.TMP_SYS_SPECIAL_URL ;

truncate table rgihapp.LKU_SYS_3D_MODEL_TYPE ;
truncate table rgihapp.LKU_SYS_DEPT ;
truncate table rgihapp.LKU_SYS_MODULE ;
truncate table rgihapp.LKU_SYS_PTLMSG_PRIORITY ;
truncate table rgihapp.LKU_SYS_PTLMSG_TYPE ;
truncate table rgihapp.LKU_SYS_SMOSECTION ;
truncate table rgihapp.RLT_APPMGT_GROUP_RIGHT ;
truncate table rgihapp.RLT_APPMGT_GROUP_USER ;
truncate table rgihapp.RLT_APPMGT_PTLMSG_ACCESS ;
truncate table rgihapp.RLT_SYS_MAPLYR_MOD ;
truncate table rgihapp.TBL_APPMGT_ACCESS_RIGHT ;
truncate table rgihapp.TBL_APPMGT_APP_LIST ;
truncate table rgihapp.TBL_APPMGT_PTLMSG ;
truncate table rgihapp.TBL_APPMGT_RIBBON_ITEM ;
truncate table rgihapp.TBL_APPMGT_USER_DETAIL ;
truncate table rgihapp.TBL_APPMGT_USER_GROUP ;
truncate table rgihapp.TBL_APPMGT_USER_INFO ;
truncate table rgihapp.TBL_CAT_LINK ;
truncate table rgihapp.TBL_CAT_LIST ;
truncate table rgihapp.TBL_GEOXPR_LEGEND ;
truncate table rgihapp.TBL_SYS_CONFIG ;
truncate table rgihapp.TBL_SYS_MAPLYR ;
truncate table rgihapp.TBL_SYS_MAPLYR_CAT ;


-- Generate the drop sequence statements. Login to the prod rgihw as SYS and change to rgihw container.
select 'drop sequence rgihapp.' || SEQUENCE_NAME || ';' from dba_sequences where sequence_owner='RGIHAPP'
and sequence_name not like '%ISEQ$$%' order by sequence_name;

drop sequence rgihapp.BATCH_JOB_EXECUTION_SEQ;
drop sequence rgihapp.BATCH_JOB_SEQ;
drop sequence rgihapp.BATCH_STEP_EXECUTION_SEQ;


-- Recreate sequences if needed. Start with 1
CREATE SEQUENCE  "RGIHAPP"."BATCH_JOB_EXECUTION_SEQ"  MINVALUE 0 MAXVALUE 9223372036854775807 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOPARTITION ;
CREATE SEQUENCE  "RGIHAPP"."BATCH_JOB_SEQ"  MINVALUE 0 MAXVALUE 9223372036854775807 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOPARTITION ;
CREATE SEQUENCE  "RGIHAPP"."BATCH_STEP_EXECUTION_SEQ"  MINVALUE 0 MAXVALUE 9223372036854775807 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOPARTITION ;


-- Login to production write db machine as oracle
cds


-- Import the data to SIT
impdp \"sys@RGIHWSERVICE_SIT as sysdba\" schemas=rgihapp directory=XSDDIR dumpfile=rgihw_rgihapp_prd_data_only_20180119_1600.dmp logfile=rgihw_rgihapp_SIT_data_only_20180124.log

[oracle@gdat8124 script]$ impdp \"sys@RGIHWSERVICE_SIT as sysdba\" schemas=rgihapp directory=XSDDIR dumpfile=rgihw_rgihapp_prd_data_only_20180119_1600.dmp logfile=rgihw_rgihapp_SIT_data_only_20180124.log

Import: Release 12.1.0.2.0 - Production on Wed Jan 24 09:08:21 2018

Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights reserved.
Password:

Connected to: Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production
With the Partitioning, OLAP, Advanced Analytics and Real Application Testing options
Master table "SYS"."SYS_IMPORT_SCHEMA_01" successfully loaded/unloaded
Starting "SYS"."SYS_IMPORT_SCHEMA_01":  "sys/********@RGIHWSERVICE_SIT AS SYSDBA" schemas=rgihapp directory=XSDDIR dumpfile=rgihw_rgihapp_prd_data_only_20180119_1600.dmp logfile=rgihw_rgihapp_SIT_data_only_20180124.log
Processing object type SCHEMA_EXPORT/TABLE/TABLE_DATA
. . imported "RGIHAPP"."LKU_SYS_3D_MODEL_TYPE"           6.953 KB       3 rows
. . imported "RGIHAPP"."LKU_SYS_DEPT"                    7.320 KB       2 rows
. . imported "RGIHAPP"."LKU_SYS_MODULE"                  9.031 KB      10 rows
. . imported "RGIHAPP"."LKU_SYS_PTLMSG_PRIORITY"         6.929 KB       3 rows
. . imported "RGIHAPP"."LKU_SYS_PTLMSG_TYPE"             6.914 KB       3 rows
. . imported "RGIHAPP"."LKU_SYS_SMOSECTION"              6.835 KB       1 rows
. . imported "RGIHAPP"."RLT_APPMGT_GROUP_RIGHT"          11.46 KB     121 rows
. . imported "RGIHAPP"."RLT_APPMGT_GROUP_USER"           7.835 KB       5 rows
. . imported "RGIHAPP"."RLT_APPMGT_PTLMSG_ACCESS"        6.406 KB       2 rows
. . imported "RGIHAPP"."RLT_SYS_MAPLYR_MOD"              12.64 KB     224 rows
. . imported "RGIHAPP"."TBL_APPMGT_ACCESS_RIGHT"         20.95 KB     119 rows
. . imported "RGIHAPP"."TBL_APPMGT_APP_LIST"             11.31 KB      11 rows
. . imported "RGIHAPP"."TBL_APPMGT_PTLMSG"               11.03 KB       2 rows
. . imported "RGIHAPP"."TBL_APPMGT_RIBBON_ITEM"          21.87 KB      35 rows
. . imported "RGIHAPP"."TBL_APPMGT_USER_DETAIL"          11.75 KB       2 rows
. . imported "RGIHAPP"."TBL_APPMGT_USER_GROUP"           11.31 KB      16 rows
. . imported "RGIHAPP"."TBL_APPMGT_USER_INFO"            12.75 KB       2 rows
. . imported "RGIHAPP"."TBL_CAT_LINK"                    13.05 KB      85 rows
. . imported "RGIHAPP"."TBL_CAT_LIST"                    5.992 KB       4 rows
. . imported "RGIHAPP"."TBL_GEOXPR_LEGEND"               134.4 KB    1377 rows
. . imported "RGIHAPP"."TBL_SYS_CONFIG"                  10.80 KB      27 rows
. . imported "RGIHAPP"."TBL_SYS_MAPLYR"                  42.00 KB     247 rows
. . imported "RGIHAPP"."TBL_SYS_MAPLYR_CAT"              8.468 KB      31 rows
Job "SYS"."SYS_IMPORT_SCHEMA_01" successfully completed at Wed Jan 24 09:08:46 2018 elapsed 0 00:00:14




-- Reset identity column values based on max id of table content. @tab_identity_cols.sql
alter table rgihapp.LKU_SYS_MODULE modify (MOD_ID generated by default on null as identity start with limit value);
alter table rgihapp.RLT_APPMEG_MAP_LAYER_CATEGORY modify (LAYER_CATEGORY_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_APPMGT_ACCESS_RIGHT modify (ACCESS_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_APPMGT_CONTACT modify (CONTACT_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_APPMGT_PTLMSG modify (PTLMSG_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_APPMGT_USER_GROUP modify (USER_GROUP_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_APPMGT_USER_INFO modify (USER_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_BATCH_EMAIL modify (ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_CAT_LINK modify (CAT_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_DOWNLOAD_COUNT modify (ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_ENQ_SAVE modify (ENQ_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_ENQ_SHARE modify (ENQ_SHARE_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_GEOXPR_LEGEND modify (ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_GEOXPR_MARKER_LINE modify (MARKER_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_GEOXPR_MARKER_POINT modify (MARKER_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_GEOXPR_MARKER_POLYGON modify (MARKER_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_GEOXPR_MARKER_SAVE modify (PROFILE_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_GEOXPR_MARKER_SHARE modify (PROFILE_SHARE_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_ONESTP_DAP_THUMBNAIL modify (ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_ONESTP_PARAM modify (PARAM_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_SYS_ACTIVITY_LOG modify (ACT_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_SYS_DSOURCE modify (SRC_ID generated by default on null as identity start with limit value);
alter table rgihapp.TBL_USER_LAYER_ORDER modify (ORDER_ID generated by default on null as identity start with limit value);
alter table rgihapp.TMP_ONESTP_DAP_THUMBNAIL modify (ID generated by default on null as identity start with limit value);

-- Get current identity columns info
@tab_identity_cols

SYS@RGIHWSERVICE_SIT:SQL> @tab_identity_cols
old   8: WHERE  a.owner = upper('&&1') and a.owner = b.sequence_owner and a.sequence_name = b.sequence_name and b.sequence_name like 'ISEQ%'
new   8: WHERE  a.owner = upper('RGIHAPP') and a.owner = b.sequence_owner and a.sequence_name = b.sequence_name and b.sequence_name like 'ISEQ%'

TABLE_NAME                     COLUMN_NAME                    SEQUENCE_NAME         LAST_NUMBER GENERATION IDENTITY_OPTIONS
------------------------------ ------------------------------ -------------------- ------------ ---------- --------------------------------------------------
LKU_SYS_MODULE                 MOD_ID                         ISEQ$$_95152                   12 BY DEFAULT START WITH: 12, INCREMENT BY: 1, MAX_VALUE: 999999
                                                                                                           9999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                           N, CACHE_SIZE: 20, ORDER_FLAG: N

RLT_APPMEG_MAP_LAYER_CATEGORY  LAYER_CATEGORY_ID              ISEQ$$_95130                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_APPMGT_ACCESS_RIGHT        ACCESS_ID                      ISEQ$$_95110                  120 BY DEFAULT START WITH: 120, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           99999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                            N, CACHE_SIZE: 20, ORDER_FLAG: N

TBL_APPMGT_CONTACT             CONTACT_ID                     ISEQ$$_95101                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_APPMGT_PTLMSG              PTLMSG_ID                      ISEQ$$_95134                    3 BY DEFAULT START WITH: 3, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_APPMGT_USER_GROUP          USER_GROUP_ID                  ISEQ$$_95117                   17 BY DEFAULT START WITH: 17, INCREMENT BY: 1, MAX_VALUE: 999999
                                                                                                           9999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                           N, CACHE_SIZE: 20, ORDER_FLAG: N

TBL_APPMGT_USER_INFO           USER_ID                        ISEQ$$_95114                    3 BY DEFAULT START WITH: 3, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_BATCH_EMAIL                ID                             ISEQ$$_95167                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_CAT_LINK                   CAT_ID                         ISEQ$$_95106                   88 BY DEFAULT START WITH: 88, INCREMENT BY: 1, MAX_VALUE: 999999
                                                                                                           9999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                           N, CACHE_SIZE: 20, ORDER_FLAG: N

TBL_DOWNLOAD_COUNT             ID                             ISEQ$$_95404                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_ENQ_SAVE                   ENQ_ID                         ISEQ$$_95122                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_ENQ_SHARE                  ENQ_SHARE_ID                   ISEQ$$_95126                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_GEOXPR_LEGEND              ID                             ISEQ$$_95145                2,261 BY DEFAULT START WITH: 2261, INCREMENT BY: 1, MAX_VALUE: 9999
                                                                                                           999999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG
                                                                                                           : N, CACHE_SIZE: 20, ORDER_FLAG: N

TBL_GEOXPR_MARKER_LINE         MARKER_ID                      ISEQ$$_95171                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_GEOXPR_MARKER_POINT        MARKER_ID                      ISEQ$$_95175                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_GEOXPR_MARKER_POLYGON      MARKER_ID                      ISEQ$$_95179                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_GEOXPR_MARKER_SAVE         PROFILE_ID                     ISEQ$$_95654                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_GEOXPR_MARKER_SHARE        PROFILE_SHARE_ID               ISEQ$$_95656                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_ONESTP_DAP_THUMBNAIL       ID                             ISEQ$$_95138                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_ONESTP_PARAM               PARAM_ID                       ISEQ$$_95136                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_SYS_ACTIVITY_LOG           ACT_ID                         ISEQ$$_95157                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TBL_SYS_DSOURCE                SRC_ID                         ISEQ$$_95098                  145 BY DEFAULT START WITH: 145, INCREMENT BY: 1, MAX_VALUE: 99999
                                                                                                           99999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG:
                                                                                                            N, CACHE_SIZE: 20, ORDER_FLAG: N

TBL_USER_LAYER_ORDER           ORDER_ID                       ISEQ$$_95124                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N

TMP_ONESTP_DAP_THUMBNAIL       ID                             ISEQ$$_95140                    1 BY DEFAULT START WITH: 1, INCREMENT BY: 1, MAX_VALUE: 9999999
                                                                                                           999999999999999999999, MIN_VALUE: 1, CYCLE_FLAG: N
                                                                                                           , CACHE_SIZE: 20, ORDER_FLAG: N


24 rows selected.

-- Enable FK constrants. Generate the enable FK statements. Login to the prod rgihw as SYS and change to rgihw container.
select 'ALTER TABLE rgihapp.' || table_name || ' MODIFY CONSTRAINT ' || constraint_name || ' ENABLE;' from dba_constraints where owner='RGIHAPP' and constraint_type='R' order by  table_name;

ALTER TABLE rgihapp.RLT_APPMGT_GROUP_RIGHT MODIFY CONSTRAINT RLT_APPMGT_GROUP_RIGHT_FK1 ENABLE;
ALTER TABLE rgihapp.RLT_APPMGT_GROUP_RIGHT MODIFY CONSTRAINT RLT_APPMGT_GROUP_RIGHT_FK2 ENABLE;
ALTER TABLE rgihapp.TBL_APPMGT_SESSION_ATTRIBUTES MODIFY CONSTRAINT SPRING_SESSION_ATTRIBUTES_FK ENABLE;


-- Run the gen_priv_rgihw.sh.

-- unlock accounts
alter user ruser account unlock;
alter user rdbsupp account unlock;


-- Login write db as ruser to run
select count(*) from TBL_APPMGT_SESSION;

-- Login write db as rdbsupp to run
select count(*) from RGIHAPP.TBL_SYS_MAPLYR;


==========================================================================================================================
===  Problems hit 
==========================================================================================================================
-----------------------------------------------------------------------------------------------------------------------
-- Problem: compat-libstdc++-33 not found 
-----------------------------------------------------------------------------------------------------------------------
-- Required rpm compat-libstdc++-33 not found
[root@gdat8124 ~]# yum list compat-libstdc++-33
Loaded plugins: langpacks, product-id, search-disabled-repos, subscription-manager
Error: No matching Packages to list

-- List available repos
[root@gdat8124 ~]# subscription-manager repos --list

-- Enable required repos. Reference https://serverfault.com/questions/703167/installing-compat-libstdc-33-on-rhel-7
[root@gdat8124 ~]# yum-config-manager --enable rhel-7-server-extras-rpms rhel-7-server-optional-rpms

-- Find again
[root@gdat8124 ~]# yum list compat-libstdc++-33
Loaded plugins: langpacks, product-id, search-disabled-repos, subscription-manager
rhel-7-server-extras-rpms                                                                                                               | 3.4 kB  00:00:00
rhel-7-server-optional-rpms                                                                                                             | 3.5 kB  00:00:00
rhel-7-server-rpms                                                                                                                      | 3.5 kB  00:00:00
(1/3): rhel-7-server-optional-rpms/7Server/x86_64/group                                                                                 |  25 kB  00:00:01
(2/3): rhel-7-server-optional-rpms/7Server/x86_64/updateinfo                                                                            | 1.4 MB  00:00:02
(3/3): rhel-7-server-optional-rpms/7Server/x86_64/primary_db                                                                            | 5.1 MB  00:00:02
Available Packages
compat-libstdc++-33.i686                                                 3.2.3-72.el7                                               rhel-7-server-optional-rpms
compat-libstdc++-33.x86_64                                               3.2.3-72.el7                                               rhel-7-server-optional-rpms

-- Install compat-libstdc++-33
[root@gdat8124 ~]# yum install compat-libstdc++-33 -y


-----------------------------------------------------------------------------------------------------------------------
-- Problem: This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register
-----------------------------------------------------------------------------------------------------------------------
[root@gdat8124 ~]# yum list `awk '{print $1}' ./req-rpm.txt` -y
Loaded plugins: langpacks, product-id, search-disabled-repos, subscription-manager
This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.

-- Run below command to register
[root@gdat8124 ~]# subscription-manager register --username capgh5@landsd.gov.hk --password abcd12345678! --auto-attach


-----------------------------------------------------------------------------------------------------------------------
-- Problem: VALIDATE DATABASE - Insufficient SRLs
-----------------------------------------------------------------------------------------------------------------------
DGMGRL> validate database cdb1

  Database Role:    Primary database

  Ready for Switchover:  Yes

DGMGRL> validate database cdb2

  Database Role:     Physical standby database
  Primary Database:  cdb1

  Ready for Switchover:  Yes
  Ready for Failover:    Yes (Primary Running)

  Current Log File Groups Configuration:
    Thread #  Online Redo Log Groups  Standby Redo Log Groups Status
              (cdb1)                  (cdb2)
    1         3                       2                       Insufficient SRLs

  Future Log File Groups Configuration:
    Thread #  Online Redo Log Groups  Standby Redo Log Groups Status
              (cdb2)                  (cdb1)
    1         3                       0                       Insufficient SRLs
    Warning: standby redo logs not configured for thread 1 on cdb1

-- In cdb1, query the standby redo logs. They all belongs to THREAD 0, it should be THREAD 1.
SQL>   select * from V$STANDBY_LOG;

    GROUP# DBID                                        THREAD#  SEQUENCE#      BYTES  BLOCKSIZE       USED ARC STATUS     FIRST_CHANGE# FIRST_TIME         NEXT_CHANGE# NEXT_TIME     LAST_CHANGE#
---------- ---------------------------------------- ---------- ---------- ---------- ---------- ---------- --- ---------- ------------- ------------------ ------------ ------------------ ------------
LAST_TIME              CON_ID
------------------ ----------
         4 UNASSIGNED                                        0          0  524288000        512          0 YES UNASSIGNED
                            0

         5 UNASSIGNED                                        0          0  524288000        512          0 YES UNASSIGNED
                            0

         6 UNASSIGNED                                        0          0  524288000        512          0 YES UNASSIGNED
                            0

         7 UNASSIGNED                                        0          0  524288000        512          0 YES UNASSIGNED
                            0

							
-- In cdb2, query the standby redo logs. Only groups 4-5 belongs to THREAD 1. 
SQL>  select * from V$STANDBY_LOG;

    GROUP# DBID                                        THREAD#  SEQUENCE#      BYTES  BLOCKSIZE       USED ARC STATUS     FIRST_CHANGE# FIRST_TIME         NEXT_CHANGE# NEXT_TIME     LAST_CHANGE#
---------- ---------------------------------------- ---------- ---------- ---------- ---------- ---------- --- ---------- ------------- ------------------ ------------ ------------------ ------------
LAST_TIME              CON_ID
------------------ ----------
         4 915444010                                         1         23  524288000        512  203407872 YES ACTIVE           1428624 20-APR-17         1595214
21-APR-17                   0

         5 UNASSIGNED                                        1          0  524288000        512          0 NO  UNASSIGNED
                            0

         6 UNASSIGNED                                        0          0  524288000        512          0 YES UNASSIGNED
                            0

         7 UNASSIGNED                                        0          0  524288000        512          0 YES UNASSIGNED
                            0
				
	
-- The cause of the issue is when the standby redo log groups are created, no thread is specified - Doc ID 1956103.1

-- Because groups 5-7 in standby(cdb2) are available now, not in used. Let's in primary, drop groups 5-7 to see whether it is okay
-- In cdb1,
alter database drop logfile group 5;
alter database drop logfile group 6;
alter database drop logfile group 7;

-- However, in cdb2 that groups 5-7 are NOT dropped automatically. Cannot also drop them manually
SQL> alter database drop logfile group 5;
alter database drop logfile group 5
*
ERROR at line 1:
ORA-01156: recovery or flashback in progress may need access to files

-- Let's stop the managed recovery in cdb2 first and try to drop them again. Yes, groups 5-7 can be dropped.
SQL> alter database recover managed standby database cancel;
SQL> alter database drop logfile group 5;
alter database drop logfile group 6;
alter database drop logfile group 7;

-- Now, let's put back cdb2 into managed recover mode
alter database recover managed standby database disconnect from session;

-- Now, let's re-create groups 5-7 in cdb1 by specifying the THREAD clause
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 5 ('/u02/app/oracle/fast_recovery_area/cdb1/srl02b.log','/u03/app/oracle/oradata/cdb1/srl02a.log') SIZE 500M REUSE;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 6 ('/u02/app/oracle/fast_recovery_area/cdb1/srl03b.log','/u03/app/oracle/oradata/cdb1/srl03a.log') SIZE 500M REUSE;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 7 ('/u02/app/oracle/fast_recovery_area/cdb1/srl04b.log','/u03/app/oracle/oradata/cdb1/srl04a.log') SIZE 500M REUSE;

-- Same again, groups 5-7 are not re-created automatically in cdb2, so need to create them manually in cdb2
alter database recover managed standby database cancel;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 5 ('/u02/app/oracle/fast_recovery_area/cdb2/srl02b.log','/u03/app/oracle/oradata/cdb2/srl02a.log') SIZE 500M REUSE;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 6 ('/u02/app/oracle/fast_recovery_area/cdb2/srl03b.log','/u03/app/oracle/oradata/cdb2/srl03a.log') SIZE 500M REUSE;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 7 ('/u02/app/oracle/fast_recovery_area/cdb2/srl04b.log','/u03/app/oracle/oradata/cdb2/srl04a.log') SIZE 500M REUSE;
alter database recover managed standby database disconnect from session;

-- in cdb1, query again
SQL> select * from v$standby_log;

    GROUP# DBID                                        THREAD#  SEQUENCE#      BYTES  BLOCKSIZE       USED ARC STATUS     FIRST_CHANGE# FIRST_TIME         NEXT_CHANGE# NEXT_TIME     LAST_CHANGE#
---------- ---------------------------------------- ---------- ---------- ---------- ---------- ---------- --- ---------- ------------- ------------------ ------------ ------------------ ------------
LAST_TIME              CON_ID
------------------ ----------
         4 UNASSIGNED                                        0          0  524288000        512          0 YES UNASSIGNED
                            0

         5 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

         6 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

         7 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

							
-- in cdb2, query again
SQL> select * from v$standby_log;

    GROUP# DBID                                        THREAD#  SEQUENCE#      BYTES  BLOCKSIZE       USED ARC STATUS     FIRST_CHANGE# FIRST_TIME         NEXT_CHANGE# NEXT_TIME     LAST_CHANGE#
---------- ---------------------------------------- ---------- ---------- ---------- ---------- ---------- --- ---------- ------------- ------------------ ------------ ------------------ ------------
LAST_TIME              CON_ID
------------------ ----------
         4 915444010                                         1         23  524288000        512  205344768 YES ACTIVE           1428624 20-APR-17         1601656
21-APR-17                   0

         5 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

         6 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

         7 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

-- Now, let's drop and re-create group 4 in cdb1
alter database drop logfile group 4;
ALTER DATABASE ADD STANDBY LOGFILE THREAD 1 GROUP 4 ('/u02/app/oracle/fast_recovery_area/cdb1/srl01b.log','/u03/app/oracle/oradata/cdb1/srl01a.log') SIZE 500M REUSE;


-- in cdb1, query again. All threads now belong to THREAD 1.
SQL> select * from v$standby_log;

    GROUP# DBID                                        THREAD#  SEQUENCE#      BYTES  BLOCKSIZE       USED ARC STATUS     FIRST_CHANGE# FIRST_TIME         NEXT_CHANGE# NEXT_TIME     LAST_CHANGE#
---------- ---------------------------------------- ---------- ---------- ---------- ---------- ---------- --- ---------- ------------- ------------------ ------------ ------------------ ------------
LAST_TIME              CON_ID
------------------ ----------
         4 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

         5 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

         6 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

         7 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

-- Now, let's do a log switch in cdb1 and then check what happens in groups 5-7 in cdb2. Great! we see that group 5 because new ACTIVE.
SQL> select * from v$standby_log;

    GROUP# DBID                                        THREAD#  SEQUENCE#      BYTES  BLOCKSIZE       USED ARC STATUS     FIRST_CHANGE# FIRST_TIME         NEXT_CHANGE# NEXT_TIME     LAST_CHANGE#
---------- ---------------------------------------- ---------- ---------- ---------- ---------- ---------- --- ---------- ------------- ------------------ ------------ ------------------ ------------
LAST_TIME              CON_ID
------------------ ----------
         4 UNASSIGNED                                        1          0  524288000        512          0 NO  UNASSIGNED
                            0

         5 915444010                                         1         24  524288000        512      29184 YES ACTIVE           1602615 21-APR-17         1602645
21-APR-17                   0

         6 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

         7 UNASSIGNED                                        1          0  524288000        512          0 YES UNASSIGNED
                            0

							
-- Now, validate the database cdb1 and cdb2 again and we see no more insufficient SRLs
DGMGRL> validate database cdb1

  Database Role:    Primary database

  Ready for Switchover:  Yes

DGMGRL> validate database cdb2

  Database Role:     Physical standby database
  Primary Database:  cdb1

  Ready for Switchover:  Yes
  Ready for Failover:    Yes (Primary Running)

DGMGRL>


-----------------------------------------------------------------------------------------------------------------------
-- Problem: ORA-20079: full resync from primary database is not done. RMAN-20051: datafile resync not completed
-----------------------------------------------------------------------------------------------------------------------
-- In standby databases, RMAN command such as "REPORT SCHEMA" failed ...

[oracle@gdat8135 script]$ rman target sys/rGIH201704@cdb2 catalog rmancat/rmancat@rmancat

Recovery Manager: Release 12.1.0.2.0 - Production on Wed Apr 26 14:26:51 2017

Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights reserved.

connected to target database: CDB1 (DBID=915444010, not open)
connected to recovery catalog database

RMAN> report schema;

ORA-20079: full resync from primary database is not done

doing automatic resync from primary
resyncing from database with DB_UNIQUE_NAME cdb1
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of report command at 04/26/2017 14:27:07
RMAN-03014: implicit resync of recovery catalog failed
RMAN-03009: failure of partial resync command on default channel at 04/26/2017 14:27:07
RMAN-20051: datafile resync not completed

[oracle@gdat8144 script]$ rman target sys/rGIH201704@cdb3 catalog rmancat/rmancat@rmancat

Recovery Manager: Release 12.1.0.2.0 - Production on Wed Apr 26 14:27:16 2017

Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights reserved.

connected to target database: CDB1 (DBID=915444010, not open)
connected to recovery catalog database

RMAN> report schema;

ORA-20079: full resync from primary database is not done

doing automatic resync from primary
resyncing from database with DB_UNIQUE_NAME cdb1
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of report command at 04/26/2017 14:27:27
RMAN-03014: implicit resync of recovery catalog failed
RMAN-03009: failure of partial resync command on default channel at 04/26/2017 14:27:27
RMAN-20051: datafile resync not completed


Reason:
Bug 20848335  ORA-20079 / RMAN-20051 raised by rman on standby

Description
In CDB+ADG, first resync from standby will fail with RMAN-20051 if curent_scn of standby has risen from last_full_ckp_scn.
Rediscovery Notes
RMAN> resync catalog;
RMAN-01005: starting partial resync of recovery catalog
RMAN-01005: ORA-20079: full resync from primary database is not done
RMAN-01005: doing automatic resync from primary
....
RMAN-20051: datafile resync not completed

Fixed:

The fix for 20848335 is first included in	
12.2.0.1 (Base Release)
12.1.0.2.160719 (Jul 2016) Database Patch Set Update (DB PSU)
12.1.0.2.160119 (Jan 2016) Bundle Patch for Engineered Systems / DB In-Memory (DBBP)
12.1.0.2.160719 (Jul 2016) Bundle Patch for Windows Platforms

or we do not turn on ADG.

-----------------------------------------------------------------------------------------------------------------------
-- Problem: Error: ORA-16655: specified target standby database invalid
-----------------------------------------------------------------------------------------------------------------------
DGMGRL> switchover to cdb3
Performing switchover NOW, please wait...
Operation requires a connection to instance "cdb3" on database "cdb3"
Connecting to instance "cdb3"...
Connected as SYSDBA.
Error: ORA-16655: specified target standby database invalid

Failed.
Unable to switchover, primary database is still "cdb2"

Reason:
Because fast start failover is enabled and cdb3 is not the valid target database.

Solution:
DGMGRL> disable fast_start failover
Disabled.
DGMGRL> switchover to cdb3
Performing switchover NOW, please wait...
...

-----------------------------------------------------------------------------------------------------------------------
-- Problem: ORA-00326 on the two standbys after powering up the Primary which has been shut down for a long time 
-----------------------------------------------------------------------------------------------------------------------

Media Recovery Log /u02/app/oracle/fast_recovery_area/CDB2/archivelog/2017_08_08/o1_mf_1_384_drm1sycr_.arc
Errors with log /u02/app/oracle/fast_recovery_area/CDB2/archivelog/2017_08_08/o1_mf_1_384_drm1sycr_.arc
MRP0: Background Media Recovery terminated with error 326
Tue Aug 08 17:47:36 2017
Errors in file /u01/app/oracle/diag/rdbms/cdb2/cdb2/trace/cdb2_pr00_22486.trc:
ORA-00326: ¤é»x©l¦ÛÅÜ§ó 24027811, »Ý­nªº¬O§ó¦­ªºÅÜ§ó 23994932
ORA-00334: ¦sÀÉ¤é»x: '/u02/app/oracle/fast_recovery_area/CDB2/archivelog/2017_08_08/o1_mf_1_384_drm1sycr_.arc'
Managed Standby Recovery not using Real Time Apply
Recovery interrupted!
Some recovered datafiles maybe left media fuzzy
Media recovery may continue but open resetlogs may fail
Tue Aug 08 17:47:36 2017
Errors in file /u01/app/oracle/diag/rdbms/cdb2/cdb2/trace/cdb2_pr00_22486.trc:
ORA-00326: ¤é»x©l¦ÛÅÜ§ó 24027811, »Ý­nªº¬O§ó¦­ªºÅÜ§ó 23994932
ORA-00334: ¦sÀÉ¤é»x: '/u02/app/oracle/fast_recovery_area/CDB2/archivelog/2017_08_08/o1_mf_1_384_drm1sycr_.arc'
Completed: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT  NODELAY
Tue Aug 08 17:47:37 2017
MRP0: Background Media Recovery process shutdown (cdb2)
Starting background process NSV2
Tue Aug 08 17:53:06 2017
NSV2 started with pid=62, OS id=22667


Errors in file /u01/app/oracle/diag/rdbms/cdb3/cdb3/trace/cdb3_pr00_1559.trc:
ORA-00326: ¤é»x©l¦ÛÅÜ§ó 24027811, »Ý­nªº¬O§ó¦­ªºÅÜ§ó 23994932
ORA-00334: ¦sÀÉ¤é»x: '/u02/app/oracle/fast_recovery_area/CDB3/archivelog/2017_08_08/o1_mf_1_384_drm03lxb_.arc'
Recovery interrupted!
Tue Aug 08 17:47:35 2017
Errors in file /u01/app/oracle/diag/rdbms/cdb3/cdb3/trace/cdb3_pr00_1559.trc:
ORA-00326: ¤é»x©l¦ÛÅÜ§ó 24027811, »Ý­nªº¬O§ó¦­ªºÅÜ§ó 23994932
ORA-00334: ¦sÀÉ¤é»x: '/u02/app/oracle/fast_recovery_area/CDB3/archivelog/2017_08_08/o1_mf_1_384_drm03lxb_.arc'
Completed: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT  USING ARCHIVED LOGFILE
Tue Aug 08 17:47:35 2017
ALTER SYSTEM SET log_archive_trace=0 SCOPE=BOTH SID='cdb3';
Tue Aug 08 17:47:35 2017
ALTER SYSTEM SET log_archive_format='%t_%s_%r.dbf' SCOPE=SPFILE SID='cdb3';
Tue Aug 08 17:47:36 2017
MRP0: Background Media Recovery process shutdown (cdb3)
Starting background process NSV1
Tue Aug 08 17:53:02 2017
NSV1 started with pid=61, OS id=1665


According to 
Bug 6762914 - ORA-326 during Managed Standby Recovery after thread disable (Doc ID 6762914.8)

Let's login to dgl and try to reinstate the standby databases.

DGMGRL> reinstate database cdb2
Reinstating database "cdb2", please wait...
Error: ORA-16653: failed to reinstate database

Failed.
Reinstatement of database "cdb2" failed

Let's try flashback the standby database to older SCN

-- show_fra.sql to list the old scn
flashback database to scn 22597466;

flashback database to scn 22597466
*
ERROR at line 1:
ORA-00283: µo¥Í¿ù»~, ¨ú®ø´_­ì¶¥¬q§@·~ ORA-38861:
¹F¨ì´_­ì¥Ø¼Ð«e¤w°±¤î­Ë·¹´_­ì ORA-16016:
µLªk¨Ï¥ÎÃ´½u 1 §Ç¸¹ 338 ªº¦sÀÉ¤é»x ORA-38861:
flashback recovery stopped before reaching recovery target

-- show_fra.sql to list the old scn
flashback database to scn 21760266;

flashback database to scn 21760266
*
ERROR at line 1:
ORA-00283: µo¥Í¿ù»~, ¨ú®ø´_­ì¶¥¬q§@·~ ORA-38861:
¹F¨ì´_­ì¥Ø¼Ð«e¤w°±¤î­Ë·¹´_­ì ORA-16016:
µLªk¨Ï¥ÎÃ´½u 1 §Ç¸¹ 311 ªº¦sÀÉ¤é»x ORA-38861:
flashback recovery stopped before reaching recovery target

-- shutdown and startup mount the standbys

-- Check config
DGMGRL> show configuration verbose

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    Error: ORA-16810: multiple errors or warnings detected for the database

    cdb2 - Physical standby database
    cdb3 - Physical standby database

DGMGRL> show database verbose cdb1

Database - cdb1

  Role:               PRIMARY
  Intended State:     TRANSPORT-ON
  Instance(s):
    cdb1

  Database Error(s):
    ORA-16783: cannot resolve gap for database cdb2, cdb3

  Database Warning(s):
    ORA-16629: database reports a different protection level from the protection mode

-- Now, there is unresolvalbe gap in cdb2 and cdb3 - as stated in cdb2 and cdb3's alertlogs

FAL[client]: Failed to request gap sequence
 GAP - thread 1 sequence 338-371
 DBID 915444010 branch 946858208
FAL[client]: All defined FAL servers have been attempted.
------------------------------------------------------------
Check that the CONTROL_FILE_RECORD_KEEP_TIME initialization
parameter is defined to a value that's sufficiently large
enough to maintain adequate log switch information to resolve
archivelog gaps.
------------------------------------------------------------


Fetching gap sequence in thread 1, gap sequence 311-371
Wed Aug 09 11:02:47 2017
FAL[client]: Failed to request gap sequence
 GAP - thread 1 sequence 311-371
 DBID 915444010 branch 946858208
FAL[client]: All defined FAL servers have been attempted.
------------------------------------------------------------
Check that the CONTROL_FILE_RECORD_KEEP_TIME initialization
parameter is defined to a value that's sufficiently large
enough to maintain adequate log switch information to resolve
archivelog gaps.
------------------------------------------------------------

-- How to solve gap
ORA-16824 Reported in DGMGRL for SHOW CONFIGURATION Command (Doc ID 1531217.1)
	
	
-- Let's try to re-instate cdb2 and cdb3 if there is any luck
DGMGRL> reinstate database cdb2
Reinstating database "cdb2", please wait...
Error: ORA-16653: failed to reinstate database

Failed.
Reinstatement of database "cdb2" failed


-- Well there is no luck. We got to restore the old VM snapshot or re-create the standbys

-- I just restore the old safe snapshots

-----------------------------------------------------------------------------------------------------------------------
--   Problem: RMAN-20033: control file SEQUENCE# too low, RMAN-20036: invalid record order during resync catalog
-----------------------------------------------------------------------------------------------------------------------
The daily backup in production DG env has below errors during resync catalog

RMAN-20033: control file SEQUENCE# too low
RMAN-20036: invalid record order

Solution:
Drop and re-create the catalog

-----------------------------------------------------------------------------------------------------------------------
--   Problem: "ORA-16198: é€²è¡Œé ç«¯å­˜æª”æ™‚å…§éƒ¨é€šé“é€¾æ™‚" in primary(gdat1220) and "CORRUPTION DETECTED: In redo blocks starting at block..." in standby(gdat1237)
-----------------------------------------------------------------------------------------------------------------------
-- in dg broker, it showed below errors intermittently from Nov 23 08:08 to Nov 24 08:02 in year 2021.
DGMGRL> show configuration verbose;

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb2 - Primary database
    Error: ORA-16778: redo transport error for one or more databases

    cdb1 - Physical standby database
    cdb3 - Physical standby database
      Warning: ORA-16857: standby disconnected from redo source for longer than specified threshold

  Properties:
    FastStartFailoverThreshold      = '600'
    OperationTimeout                = '30'
    TraceLevel                      = 'USER'
    FastStartFailoverLagLimit       = '30'
    CommunicationTimeout            = '180'
    ObserverReconnect               = '0'
    FastStartFailoverAutoReinstate  = 'FALSE'
    FastStartFailoverPmyShutdown    = 'TRUE'
    BystandersFollowRoleChange      = 'ALL'
    ObserverOverride                = 'FALSE'
    ExternalDestination1            = ''
    ExternalDestination2            = ''
    PrimaryLostWriteAction          = 'CONTINUE'

Fast-Start Failover: DISABLED

Configuration Status:
ERROR


-- in primary cdb2's alertlog, it showed ora-16198 intermittently and the LOG_ARCHIVE_DEST_3 became UNSYNCHRONIZED intermittently.
-- Failed to archive sequence 29146 to cdb3. It succeeded later, then failed to archive sequence 29150 to cdb3. It repeated.
Tue Nov 23 08:08:03 2021
ORA-16198: LGWR received timedout error from KSR
LGWR: Attempting destination LOG_ARCHIVE_DEST_3 network reconnect (16198)
LGWR: Destination LOG_ARCHIVE_DEST_3 network reconnect abandoned
Tue Nov 23 08:08:03 2021
Errors in file /u01/app/oracle/diag/rdbms/cdb2/cdb2/trace/cdb2_lgwr_1935.trc:
ORA-16198: é€²è¡Œé ç«¯å­˜æª”æ™‚å…§éƒ¨é€šé“é€¾æ™‚
Error 16198 for archive log file 1 to 'cdb3'
ORA-16198: LGWR received timedout error from KSR
LGWR: Error 16198 disconnecting from destination LOG_ARCHIVE_DEST_3 standby host 'cdb3'
Tue Nov 23 08:08:03 2021
Destination LOG_ARCHIVE_DEST_3 is UNSYNCHRONIZED
LGWR: Failed to archive log 1 thread 1 sequence 29135 (16198)
Tue Nov 23 08:51:16 2021
Errors in file /u01/app/oracle/diag/rdbms/cdb2/cdb2/trace/cdb2_lgwr_1935.trc:
ORA-16198: é€²è¡Œé ç«¯å­˜æª”æ™‚å…§éƒ¨é€šé“é€¾æ™‚
Error 16198 for archive log file 3 to 'cdb3'
ORA-16198: LGWR received timedout error from KSR
LGWR: Error 16198 disconnecting from destination LOG_ARCHIVE_DEST_3 standby host 'cdb3'
LGWR: Failed to archive log 3 thread 1 sequence 29146 (16198)
LGWR: Standby redo logfile selected to archive thread 1 sequence 29147
LGWR: Standby redo logfile selected for thread 1 sequence 29147 for destination LOG_ARCHIVE_DEST_2
Tue Nov 23 08:51:16 2021
Thread 1 advanced to log sequence 29147 (LGWR switch)
  Current log# 1 seq# 29147 mem# 0: /u03/app/oracle/oradata/cdb2/redo01a.log
  Current log# 1 seq# 29147 mem# 1: /u02/app/oracle/fast_recovery_area/cdb2/redo01b.log
Tue Nov 23 08:51:16 2021
Archived Log entry 89046 added for thread 1 sequence 29146 ID 0x3cae9811 dest 1:
Tue Nov 23 08:55:02 2021
LGWR: Standby redo logfile selected to archive thread 1 sequence 29148
LGWR: Standby redo logfile selected for thread 1 sequence 29148 for destination LOG_ARCHIVE_DEST_2
Tue Nov 23 08:55:02 2021
Thread 1 advanced to log sequence 29148 (LGWR switch)
  Current log# 2 seq# 29148 mem# 0: /u03/app/oracle/oradata/cdb2/redo02a.log
  Current log# 2 seq# 29148 mem# 1: /u02/app/oracle/fast_recovery_area/cdb2/redo02b.log
Tue Nov 23 08:55:02 2021
Archived Log entry 89048 added for thread 1 sequence 29147 ID 0x3cae9811 dest 1:
Tue Nov 23 08:56:41 2021
LGWR: Standby redo logfile selected to archive thread 1 sequence 29149
LGWR: Standby redo logfile selected for thread 1 sequence 29149 for destination LOG_ARCHIVE_DEST_3
LGWR: Standby redo logfile selected to archive thread 1 sequence 29149
LGWR: Standby redo logfile selected for thread 1 sequence 29149 for destination LOG_ARCHIVE_DEST_2
Tue Nov 23 08:56:41 2021
Tue Nov 23 08:59:14 2021
Archived Log entry 89056 added for thread 1 sequence 29149 ID 0x3cae9811 dest 1:
Tue Nov 23 09:04:50 2021
ORA-16198: LGWR received timedout error from KSR
LGWR: Attempting destination LOG_ARCHIVE_DEST_3 network reconnect (16198)
LGWR: Destination LOG_ARCHIVE_DEST_3 network reconnect abandoned
Tue Nov 23 09:04:50 2021
Errors in file /u01/app/oracle/diag/rdbms/cdb2/cdb2/trace/cdb2_lgwr_1935.trc:
ORA-16198: é€²è¡Œé ç«¯å­˜æª”æ™‚å…§éƒ¨é€šé“é€¾æ™‚
Error 16198 for archive log file 1 to 'cdb3'
ORA-16198: LGWR received timedout error from KSR
LGWR: Error 16198 disconnecting from destination LOG_ARCHIVE_DEST_3 standby host 'cdb3'
Tue Nov 23 09:04:50 2021
Destination LOG_ARCHIVE_DEST_3 is UNSYNCHRONIZED
LGWR: Failed to archive log 1 thread 1 sequence 29150 (16198)



-- standby cdb3's alertlog, it showed CORRUPTION DETECTED for sequence 29146 and 29150.
Media Recovery Waiting for thread 1 sequence 29146 (in transit)
Tue Nov 23 08:51:16 2021
CORRUPTION DETECTED: In redo blocks starting at block 140644count 2048 for thread 1 sequence 29146
Errors in file /u01/app/oracle/diag/rdbms/cdb3/cdb3/trace/cdb3_rfs_28153.trc  (incident=612627) (PDBNAME=CDB$ROOT):
ORA-00600: å…§éƒ¨éŒ¯èª¤ä»£ç¢¼, å¼•æ•¸: [krsr_rfs_wda.9], [2], [], [], [], [], [], [], [], [], [], []
Incident details in: /u01/app/oracle/diag/rdbms/cdb3/cdb3/incident/incdir_612627/cdb3_rfs_28153_i612627.trc
Use ADRCI or Support Workbench to package the incident.
...
Tue Nov 23 08:56:51 2021
Media Recovery Log /u02/app/oracle/fast_recovery_area/CDB3/archivelog/2021_11_23/o1_mf_1_29146_jsrh2m0p_.arc
Media Recovery Waiting for thread 1 sequence 29147 (in transit)
Tue Nov 23 08:59:08 2021
Archived Log entry 32888 added for thread 1 sequence 29147 rlc 972464690 ID 0x3cae9811 dest 3:
Tue Nov 23 08:59:08 2021
Media Recovery Log /u02/app/oracle/fast_recovery_area/CDB3/archivelog/2021_11_23/o1_mf_1_29147_jsrh29dr_.arc
Tue Nov 23 08:59:09 2021
Media Recovery Log /u02/app/oracle/fast_recovery_area/CDB3/archivelog/2021_11_23/o1_mf_1_29148_jsrh2b79_.arc
Media Recovery Waiting for thread 1 sequence 29149 (in transit)
...
Tue Nov 23 09:04:50 2021
CORRUPTION DETECTED: In redo blocks starting at block 140296count 2048 for thread 1 sequence 29150
Tue Nov 23 09:10:42 2021
...
Wed Nov 24 08:02:50 2021
CORRUPTION DETECTED: In redo blocks starting at block 495782count 2048 for thread 1 sequence 29361
Wed Nov 24 08:08:11 2021


-- Reason
It can occur where there is a disconnect between the sites from a network perspective and you are writing your redo stream to standby redo logs.
Your primary database is showing that LNS/NSA has had a problem sending the redo to the destination hostp_standby.

-- Solution
Called Rogner to investigate and found that the network was busy copying data. This problem stopped at Nov 24 08:02.
The corruption happened in the standby redo log and was fixed and re-applied using archived log.


Reference
https://community.oracle.com/mosc/discussion/3376266/corruption-detected-in-redo-blocks-starting-at-block


==========================================================================================================================
===  FAQ 
==========================================================================================================================
How to re-create physical standby database in DG configuration with 3 databases?

Current setting of cdb1(primary)
log_archive_config             dg_config=(cdb1,cdb2,cdb3)
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2             service="cdb2"
log_archive_dest_2             SYNC AFFIRM delay=0 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb2" net_timeout=30
log_archive_dest_2             valid_for=(online_logfile,all_roles)
log_archive_dest_3             service="cdb3"
log_archive_dest_3             SYNC AFFIRM delay=1 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb3" net_timeout=30
log_archive_dest_3             valid_for=(online_logfile,all_roles)






--------------------------------------------------------------------------------------------------------------------------
What does "disable database" command mean?

-- Current setting of cdb1(primary)
log_archive_config             dg_config=(cdb1,cdb2,cdb3)
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2             service="cdb2"
log_archive_dest_2             SYNC AFFIRM delay=0 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb2" net_timeout=30
log_archive_dest_2             valid_for=(online_logfile,all_roles)
log_archive_dest_3             service="cdb3"
log_archive_dest_3             SYNC AFFIRM delay=1 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb3" net_timeout=30
log_archive_dest_3             valid_for=(online_logfile,all_roles)

-- We are now to "disable database cdb3" where cdb3 is a standby database now.

DGMGRL> disable database cdb3
Disabled.
DGMGRL> show configuration verbose

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    cdb2 - Physical standby database
    cdb3 - Physical standby database (disabled)

-- In cdb1, the log_archive_dest_3, for cdb3 is still valid
log_archive_config             dg_config=(cdb1,cdb2,cdb3)
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2             service="cdb2"
log_archive_dest_2             SYNC AFFIRM delay=0 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb2" net_timeout=30
log_archive_dest_2             valid_for=(online_logfile,all_roles)
log_archive_dest_3             service="cdb3"
log_archive_dest_3             SYNC AFFIRM delay=1 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb3" net_timeout=30
log_archive_dest_3             valid_for=(online_logfile,all_roles)
log_archive_dest_state_1       enable
log_archive_dest_state_2       ENABLE
log_archive_dest_state_3       ENABLE


-- Let's have a log switch in cdb1 and then check the redo apply in cdb3... Redo apply still valid even after "disable database cdb3" command.

-- Let's check "show database" status...
DGMGRL> show database cdb3

Database - cdb3

  Role:               PHYSICAL STANDBY
  Intended State:     APPLY-ON
  Transport Lag:      (unknown)
  Apply Lag:          (unknown)
  Average Apply Rate: (unknown)
  Real Time Query:    OFF
  Instance(s):
    cdb3

Database Status:
DISABLED

-- Let's check "validate database" status...
DGMGRL> validate database cdb3
Error: ORA-16548: database not enabled

-- Now let's enable the database again...
DGMGRL> enable database cdb3
Enabled.
DGMGRL>


-- Conclusion
1. "disable database" commands does not affect existing redo apply - cdb3 can still apply the redo from Primary.
2. This means that broker directed state changes will be disallowed for this database, and the broker will not monitor the database for health status or for monitorable database properties.


--------------------------------------------------------------------------------------------------------------------------
What does "remove database" command mean?

-- Current setting of cdb1(primary)
log_archive_config             dg_config=(cdb1,cdb2,cdb3)
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2             service="cdb2"
log_archive_dest_2             SYNC AFFIRM delay=0 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb2" net_timeout=30
log_archive_dest_2             valid_for=(online_logfile,all_roles)
log_archive_dest_3             service="cdb3"
log_archive_dest_3             SYNC AFFIRM delay=1 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb3" net_timeout=30
log_archive_dest_3             valid_for=(online_logfile,all_roles)

-- We are now to "remove database cdb3" where cdb3 is a standby database now.
DGMGRL> remove database cdb3
Removed database "cdb3" from the configuration

-- Check configuration... cdb3 is gone.
DGMGRL> show configuration verbose

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    cdb2 - Physical standby database

-- Check dgpara in cdb1... cdb3 entry log_archive_dest_3 is gone... so redo transport to cdb3 is gone.
log_archive_config             dg_config=(cdb1,cdb2)
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2             service="cdb2"
log_archive_dest_2             SYNC AFFIRM delay=0 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb2" net_timeout=30
log_archive_dest_2             valid_for=(online_logfile,all_roles)
log_archive_dest_3

-- Let's do a logfile switch in cdb1... the redo is not transported to cdb3...
-- In cdb1, log archive status
PROCESS   STATUS             THREAD#  SEQUENCE#     BLOCK#     BLOCKS
--------- --------------- ---------- ---------- ---------- ----------
ARCH      CLOSING                  1        305          1        246
LGWR      WRITING                  1        306          3          1

-- In cdb3, log archive status... Lag behind cdb1...
PROCESS   STATUS             THREAD#  SEQUENCE#     BLOCK#     BLOCKS
--------- --------------- ---------- ---------- ---------- ----------
ARCH      CLOSING                  1        302       2048        936
MRP0      WAIT_FOR_LOG             1        303          0          0



-- Let's create a test table in cdb1 and then add cdb3 back to the DG configuration and see whether cdb3 can pick up the test table...
DGMGRL> connect sys@cdb1
Password:
Connected as SYSDBA.
DGMGRL> show configuration

DGMGRL> add database 'cdb3' as connect identifier is cdb3;

DGMGRL> enable database cdb3
Enabled.

DGMGRL> show configuration verbose

Configuration - DGCONFIG

  Protection Mode: MaxAvailability
  Members:
  cdb1 - Primary database
    cdb2 - Physical standby database
    cdb3 - Physical standby database


-- Check log archive status in cdb1 ...
PROCESS   STATUS             THREAD#  SEQUENCE#     BLOCK#     BLOCKS
--------- --------------- ---------- ---------- ---------- ----------
LNS       WRITING                  1        307        303          2
LGWR      WRITING                  1        307        303          2

-- Check log archive status in cdb3 ...
PROCESS   STATUS             THREAD#  SEQUENCE#     BLOCK#     BLOCKS
--------- --------------- ---------- ---------- ---------- ----------
RFS       IDLE                     1        307        308          1
MRP0      APPLYING_LOG             1        307        308    1024000

-- cdb3 can be added back to the DG configuration

-- Open cdb3 in read only mode and check the test table there
SQL> alter database open;
SQL> select * from test_dg;

         A
----------
         1

-- conclusion
1. After "remove database" command, the redo transport to that standby ceases.
2. If add the standby database back to the DG config, the redo transport resumes and can pick up from the missing point...
3. Can use the command to stop redo transport to the standby database

--------------------------------------------------------------------------------------------------------------------------
What does "remove configuration" command mean?

Note: This testing is done in DG_CONFIG(cdb1,cdb2) - MY DG VMs, not rGIH SIT DG(cdb1,cdb2,cdb3) VMs

-- Current setting of cdb1(primary)
log_archive_config             dg_config=(cdb1,cdb2)
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2             service="cdb2"
log_archive_dest_2             SYNC AFFIRM delay=0 optional compression=disable max_failure=0 max_connections=1 reopen=300 db_unique_name="cdb2" net_timeout=30
log_archive_dest_2             valid_for=(online_logfile,all_roles)

-- We are now to "remove configuration".
DGMGRL> remove configuration
Error: ORA-16627: operation disallowed since no standby databases would remain to support protection mode

Failed.

-- Change to MaxPerformance mode first, and then remove configuration
DGMGRL> edit configuration set protection mode as MaxPerformance;
Succeeded.
DGMGRL> remove configuration
Removed configuration

-- Check configuration in Primary and standby, the DG config is gone.
log_archive_config             nodg_config
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2
log_archive_dest_state_1       enable
log_archive_dest_state_2       ENABLE

-- Now, let create a test table in Primary... alter logfile switch a few times ... Can see that no more LNS/LGWR in Primary, but MRP0 still in standby

-- Check log archive status in Primary. The LGWR process responsible for redo transport is not there. It is normal.
PROCESS   STATUS             THREAD#  SEQUENCE#     BLOCK#     BLOCKS
--------- --------------- ---------- ---------- ---------- ----------
ARCH      CLOSING                  1         64          1          1
ARCH      CLOSING                  1         65          1          5

-- Check log archive status in standby. The MRP0 is still in standby.
PROCESS   STATUS             THREAD#  SEQUENCE#     BLOCK#     BLOCKS
--------- --------------- ---------- ---------- ---------- ----------
ARCH      CLOSING                  1         61          1       1293
MRP0      WAIT_FOR_LOG             1         62          0          0


-- Now, let's re-create the DG configuration and enable it...
DGMGRL> create configuration 'DGCONFIG' as primary database is 'cdb1' connect identifier is cdb1;
Configuration "DGCONFIG" created with primary database "cdb1"
DGMGRL> add database 'cdb2' as connect identifier is cdb2;
Database "cdb2" added
DGMGRL> enable configuration
Enabled.

-- Open the standby in read only mode to check test table... The test table is there.
SQL> select * from test_dg;

         A
----------
         1
         2

-- Check log archive status in Primary
PROCESS   STATUS             THREAD#  SEQUENCE#     BLOCK#     BLOCKS
--------- --------------- ---------- ---------- ---------- ----------
ARCH      CLOSING                  1         70      14336       1611
LNS       WRITING                  1         71        768          1

-- Check log archive status in standby... They are in sync
PROCESS   STATUS             THREAD#  SEQUENCE#     BLOCK#     BLOCKS
--------- --------------- ---------- ---------- ---------- ----------
RFS       IDLE                     1         71        773          1
MRP0      APPLYING_LOG             1         71        773     102400


-- However, the dg_archive_config in standby is a bit weired... only cdb1 there...
log_archive_config             dg_config=(cdb1)
log_archive_dest_1             LOCATION=USE_DB_RECOVERY_FILE_DEST
log_archive_dest_2
log_archive_dest_state_1       enable
log_archive_dest_state_2       ENABLE

-- Let's add it back to the standby... Login standby...
alter system set log_archive_config='dg_config=(cdb1,cdb2)' scope=both;		 


-- conclusion
1. Need in MaxPerformance mode to run "remove configuration"
2. After "remove configuration", the LOG_ARCHIVE_DEST_n on primary are removed. The LOG_ARCHIVE_CONFIG initialization parameters on all databases are removed.
3. The redo transport ceases. However, the media recovery in standby is still there.
4. Can re-create the configuration and add back database. The redo apply can resume from the missing point - SEQUENCE# 62 in this case. 
5. The log_archive_config in standby may be incorrectly set. Need to fix it - alter system set log_archive_config='dg_config=(cdb1,cdb2)' scope=both;	

--------------------------------------------------------------------------------------------------------------------------


==========================================================================================================================
===  Appendix 
==========================================================================================================================
-----------------------------------------------------------------------------------------------------------------------
-- dupstby.rcv 
-----------------------------------------------------------------------------------------------------------------------
run {
duplicate target database for standby from active database
dorecover
spfile
parameter_value_convert 'cdb1','cdb2'
set db_unique_name='cdb2'
set db_recovery_file_dest='/u02/app/oracle/fast_recovery_area'
set db_file_name_convert='/cdb1/','/cdb2/'
set log_file_name_convert='/cdb1/','/cdb2/'
set fal_client='cdb2'
set fal_server='cdb1'
set standby_file_management='AUTO'
set log_archive_config='dg_config=(cdb1,cdb2)'
set log_archive_dest_2='service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'
;
}

-----------------------------------------------------------------------------------------------------------------------
-- orainstRoot.sh & root.sh 
-----------------------------------------------------------------------------------------------------------------------

[root@gdat8124 ~]# /u01/app/oraInventory/orainstRoot.sh
Changing permissions of /u01/app/oraInventory.
Adding read,write permissions for group.
Removing read,write,execute permissions for world.

Changing groupname of /u01/app/oraInventory to oinstall.
The execution of the script is complete.
[root@gdat8124 ~]# /u01/app/oracle/product/12.1.0/dbhome_1/root.sh
Performing root user operation.

The following environment variables are set as:
    ORACLE_OWNER= oracle
    ORACLE_HOME=  /u01/app/oracle/product/12.1.0/dbhome_1

Enter the full pathname of the local bin directory: [/usr/local/bin]:
   Copying dbhome to /usr/local/bin ...
   Copying oraenv to /usr/local/bin ...
   Copying coraenv to /usr/local/bin ...


Creating /etc/oratab file...
Entries will be added to the /etc/oratab file as needed by
Database Configuration Assistant when a database is created
Finished running generic part of root script.
Now product-specific root actions will be performed.
[root@gdat8124 ~]#


-----------------------------------------------------------------------------------------------------------------------
-- XRDP 
-----------------------------------------------------------------------------------------------------------------------

rpm -Uvh http://li.nux.ro/download/nux/dextop/el7/x86_64/nux-dextop-release-0-1.el7.nux.noarch.rpm
yum -y install xrdp tigervnc-server
systemctl start xrdp.service
systemctl enable xrdp.service


-----------------------------------------------------------------------------------------------------------------------
-- Create DG configuration 
-----------------------------------------------------------------------------------------------------------------------
[oracle@gdat8124 script]$ dgmgrl
DGMGRL for Linux: Version 12.1.0.2.0 - 64bit Production

Copyright (c) 2000, 2013, Oracle. All rights reserved.

Welcome to DGMGRL, type "help" for information.
DGMGRL> connect sys/rGIH201704@cdb1
Connected as SYSDBA.
DGMGRL> create configuration 'DGCONFIG' as primary database is 'cdb1' connect identifier is cdb1;
Configuration "DGCONFIG" created with primary database "cdb1"
DGMGRL> add database 'cdb2' as connect identifier is cdb2;
Database "cdb2" added
DGMGRL> enable configuration;
Enabled.
DGMGRL>
DGMGRL> edit database cdb1 set property FastStartFailoverTarget=cdb2;
Property "faststartfailovertarget" updated
DGMGRL> edit database cdb2 set property FastStartFailoverTarget=cdb1;
Property "faststartfailovertarget" updated
DGMGRL> enable fast_start failover


-----------------------------------------------------------------------------------------------------------------------
-- dupstdb.rcv output 
-----------------------------------------------------------------------------------------------------------------------
[oracle@gdat8124 script]$ rman<<EOF
> connect target sys/rGIH201704@cdb1
> connect auxiliary sys/rGIH201704@cdb2
> @dupstby.rcv
> EOF

Recovery Manager: Release 12.1.0.2.0 - Production on Thu Apr 20 15:38:49 2017

Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights reserved.

RMAN>
connected to target database: CDB1 (DBID=915444010)

RMAN>
connected to auxiliary database: CDB1 (not mounted)

RMAN>
RMAN> run {
2> duplicate target database for standby from active database
3> dorecover
4> spfile
5> parameter_value_convert 'cdb1','cdb2'
6> set db_unique_name='cdb2'
7> set db_recovery_file_dest='/u02/app/oracle/fast_recovery_area'
8> set db_file_name_convert='/cdb1/','/cdb2/'
9> set log_file_name_convert='/cdb1/','/cdb2/'
10> set fal_client='cdb2'
11> set fal_server='cdb1'
12> set standby_file_management='AUTO'
13> set log_archive_config='dg_config=(cdb1,cdb2)'
14> set log_archive_dest_2='service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'
15> ;
16> }
Starting Duplicate Db at 20-APR-17
using target database control file instead of recovery catalog
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=1705 device type=DISK
current log archived

contents of Memory Script:
{
   backup as copy reuse
   targetfile  '/u01/app/oracle/product/12.1.0/dbhome_1/dbs/orapwcdb1' auxiliary format
 '/u01/app/oracle/product/12.1.0/dbhome_1/dbs/orapwcdb2'   ;
   restore clone from service  'cdb1' spfile to
 '/u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb2.ora';
   sql clone "alter system set spfile= ''/u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb2.ora''";
}
executing Memory Script

Starting backup at 20-APR-17
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=41 device type=DISK
Finished backup at 20-APR-17

Starting restore at 20-APR-17
using channel ORA_AUX_DISK_1

channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: restoring SPFILE
output file name=/u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb2.ora
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:01
Finished restore at 20-APR-17

sql statement: alter system set spfile= ''/u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb2.ora''

contents of Memory Script:
{
   sql clone "alter system set  audit_file_dest =
 ''/u01/app/oracle/admin/cdb2/adump'' comment=
 '''' scope=spfile";
   sql clone "alter system set  control_files =
 ''/u03/app/oracle/oradata/cdb2/control01.ctl'', ''/u02/app/oracle/fast_recovery_area/cdb2/control02.ctl'' comment=
 '''' scope=spfile";
   sql clone "alter system set  dispatchers =
 ''(PROTOCOL=TCP) (SERVICE=cdb2XDB)'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_unique_name =
 ''cdb2'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_recovery_file_dest =
 ''/u02/app/oracle/fast_recovery_area'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_file_name_convert =
 ''/cdb1/'', ''/cdb2/'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_file_name_convert =
 ''/cdb1/'', ''/cdb2/'' comment=
 '''' scope=spfile";
   sql clone "alter system set  fal_client =
 ''cdb2'' comment=
 '''' scope=spfile";
   sql clone "alter system set  fal_server =
 ''cdb1'' comment=
 '''' scope=spfile";
   sql clone "alter system set  standby_file_management =
 ''AUTO'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_archive_config =
 ''dg_config=(cdb1,cdb2)'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_archive_dest_2 =
 ''service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'' comment=
 '''' scope=spfile";
   shutdown clone immediate;
   startup clone nomount;
}
executing Memory Script

sql statement: alter system set  audit_file_dest =  ''/u01/app/oracle/admin/cdb2/adump'' comment= '''' scope=spfile

sql statement: alter system set  control_files =  ''/u03/app/oracle/oradata/cdb2/control01.ctl'', ''/u02/app/oracle/fast_recovery_area/cdb2/control02.ctl'' comment= '''' scope=spfile

sql statement: alter system set  dispatchers =  ''(PROTOCOL=TCP) (SERVICE=cdb2XDB)'' comment= '''' scope=spfile

sql statement: alter system set  db_unique_name =  ''cdb2'' comment= '''' scope=spfile

sql statement: alter system set  db_recovery_file_dest =  ''/u02/app/oracle/fast_recovery_area'' comment= '''' scope=spfile

sql statement: alter system set  db_file_name_convert =  ''/cdb1/'', ''/cdb2/'' comment= '''' scope=spfile

sql statement: alter system set  log_file_name_convert =  ''/cdb1/'', ''/cdb2/'' comment= '''' scope=spfile

sql statement: alter system set  fal_client =  ''cdb2'' comment= '''' scope=spfile

sql statement: alter system set  fal_server =  ''cdb1'' comment= '''' scope=spfile

sql statement: alter system set  standby_file_management =  ''AUTO'' comment= '''' scope=spfile

sql statement: alter system set  log_archive_config =  ''dg_config=(cdb1,cdb2)'' comment= '''' scope=spfile

sql statement: alter system set  log_archive_dest_2 =  ''service=cdb1 ASYNC valid_for=(ONLINE_LOGFILE,PRIMARY_ROLE) db_unique_name=cdb1'' comment= '''' scope=spfile

Oracle instance shut down

connected to auxiliary database (not started)
Oracle instance started

Total System Global Area    4026531840 bytes

Fixed Size                     2931856 bytes
Variable Size               1291846512 bytes
Database Buffers            2717908992 bytes
Redo Buffers                  13844480 bytes

contents of Memory Script:
{
   restore clone from service  'cdb1' standby controlfile;
}
executing Memory Script

Starting restore at 20-APR-17
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=1705 device type=DISK

channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: restoring control file
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:02
output file name=/u03/app/oracle/oradata/cdb2/control01.ctl
output file name=/u02/app/oracle/fast_recovery_area/cdb2/control02.ctl
Finished restore at 20-APR-17

contents of Memory Script:
{
   sql clone 'alter database mount standby database';
}
executing Memory Script

sql statement: alter database mount standby database

contents of Memory Script:
{
   set newname for tempfile  1 to
 "/u03/app/oracle/oradata/cdb2/temp01.dbf";
   set newname for tempfile  2 to
 "/u03/app/oracle/oradata/cdb2/pdbseed/temp01.dbf";
   set newname for tempfile  3 to
 "/u03/app/oracle/oradata/cdb2/rgihw/temp01.dbf";
   switch clone tempfile all;
   set newname for datafile  1 to
 "/u03/app/oracle/oradata/cdb2/system01.dbf";
   set newname for datafile  2 to
 "/u03/app/oracle/oradata/cdb2/pdbseed/system01.dbf";
   set newname for datafile  3 to
 "/u03/app/oracle/oradata/cdb2/sysaux01.dbf";
   set newname for datafile  4 to
 "/u03/app/oracle/oradata/cdb2/pdbseed/sysaux01.dbf";
   set newname for datafile  5 to
 "/u03/app/oracle/oradata/cdb2/undotbs01.dbf";
   set newname for datafile  6 to
 "/u03/app/oracle/oradata/cdb2/users01.dbf";
   set newname for datafile  7 to
 "/u03/app/oracle/oradata/cdb2/rgihw/system01.dbf";
   set newname for datafile  8 to
 "/u03/app/oracle/oradata/cdb2/rgihw/sysaux01.dbf";
   set newname for datafile  9 to
 "/u03/app/oracle/oradata/cdb2/rgihw/rgihw_users01.dbf";
   restore
   from service  'cdb1'   clone database
   ;
   sql 'alter system archive log current';
}
executing Memory Script

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

renamed tempfile 1 to /u03/app/oracle/oradata/cdb2/temp01.dbf in control file
renamed tempfile 2 to /u03/app/oracle/oradata/cdb2/pdbseed/temp01.dbf in control file
renamed tempfile 3 to /u03/app/oracle/oradata/cdb2/rgihw/temp01.dbf in control file

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

Starting restore at 20-APR-17
using channel ORA_AUX_DISK_1

channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00001 to /u03/app/oracle/oradata/cdb2/system01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:35
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00002 to /u03/app/oracle/oradata/cdb2/pdbseed/system01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:16
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00003 to /u03/app/oracle/oradata/cdb2/sysaux01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:25
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00004 to /u03/app/oracle/oradata/cdb2/pdbseed/sysaux01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:15
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00005 to /u03/app/oracle/oradata/cdb2/undotbs01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:45
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00006 to /u03/app/oracle/oradata/cdb2/users01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:01
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00007 to /u03/app/oracle/oradata/cdb2/rgihw/system01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:16
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00008 to /u03/app/oracle/oradata/cdb2/rgihw/sysaux01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:15
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00009 to /u03/app/oracle/oradata/cdb2/rgihw/rgihw_users01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:01
Finished restore at 20-APR-17

sql statement: alter system archive log current
current log archived

contents of Memory Script:
{
   restore clone force from service  'cdb1'
           archivelog from scn  1424434;
   switch clone datafile all;
}
executing Memory Script

Starting restore at 20-APR-17
using channel ORA_AUX_DISK_1

channel ORA_AUX_DISK_1: starting archived log restore to default destination
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: restoring archived log
archived log thread=1 sequence=18
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:01
channel ORA_AUX_DISK_1: starting archived log restore to default destination
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: restoring archived log
archived log thread=1 sequence=19
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:02
channel ORA_AUX_DISK_1: starting archived log restore to default destination
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: restoring archived log
archived log thread=1 sequence=20
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:01
Finished restore at 20-APR-17

datafile 1 switched to datafile copy
input datafile copy RECID=1 STAMP=941816631 file name=/u03/app/oracle/oradata/cdb2/system01.dbf
datafile 2 switched to datafile copy
input datafile copy RECID=2 STAMP=941816631 file name=/u03/app/oracle/oradata/cdb2/pdbseed/system01.dbf
datafile 3 switched to datafile copy
input datafile copy RECID=3 STAMP=941816631 file name=/u03/app/oracle/oradata/cdb2/sysaux01.dbf
datafile 4 switched to datafile copy
input datafile copy RECID=4 STAMP=941816631 file name=/u03/app/oracle/oradata/cdb2/pdbseed/sysaux01.dbf
datafile 5 switched to datafile copy
input datafile copy RECID=5 STAMP=941816631 file name=/u03/app/oracle/oradata/cdb2/undotbs01.dbf
datafile 6 switched to datafile copy
input datafile copy RECID=6 STAMP=941816631 file name=/u03/app/oracle/oradata/cdb2/users01.dbf
datafile 7 switched to datafile copy
input datafile copy RECID=7 STAMP=941816631 file name=/u03/app/oracle/oradata/cdb2/rgihw/system01.dbf
datafile 8 switched to datafile copy
input datafile copy RECID=8 STAMP=941816631 file name=/u03/app/oracle/oradata/cdb2/rgihw/sysaux01.dbf
datafile 9 switched to datafile copy
input datafile copy RECID=9 STAMP=941816631 file name=/u03/app/oracle/oradata/cdb2/rgihw/rgihw_users01.dbf

contents of Memory Script:
{
   set until scn  1424970;
   recover
   standby
   clone database
    delete archivelog
   ;
}
executing Memory Script

executing command: SET until clause

Starting recover at 20-APR-17
using channel ORA_AUX_DISK_1

starting media recovery

archived log for thread 1 with sequence 18 is already on disk as file /u02/app/oracle/fast_recovery_area/CDB2/archivelog/2017_04_20/o1_mf_1_18_dhjsomvv_.arc
archived log for thread 1 with sequence 19 is already on disk as file /u02/app/oracle/fast_recovery_area/CDB2/archivelog/2017_04_20/o1_mf_1_19_dhjsoo0y_.arc
archived log for thread 1 with sequence 20 is already on disk as file /u02/app/oracle/fast_recovery_area/CDB2/archivelog/2017_04_20/o1_mf_1_20_dhjsop52_.arc
archived log file name=/u02/app/oracle/fast_recovery_area/CDB2/archivelog/2017_04_20/o1_mf_1_18_dhjsomvv_.arc thread=1 sequence=18
archived log file name=/u02/app/oracle/fast_recovery_area/CDB2/archivelog/2017_04_20/o1_mf_1_19_dhjsoo0y_.arc thread=1 sequence=19
archived log file name=/u02/app/oracle/fast_recovery_area/CDB2/archivelog/2017_04_20/o1_mf_1_20_dhjsop52_.arc thread=1 sequence=20
media recovery complete, elapsed time: 00:00:00
Finished recover at 20-APR-17
Finished Duplicate Db at 20-APR-17

RMAN>
RMAN> **end-of-file**

RMAN>

Recovery Manager complete.
[oracle@gdat8124 script]$


-----------------------------------------------------------------------------------------------------------------------
-- dup2ndstby.rcv 
-----------------------------------------------------------------------------------------------------------------------
run {
duplicate target database for standby from active database
dorecover
spfile
parameter_value_convert 'cdb1','cdb3'
set db_unique_name='cdb3'
set db_recovery_file_dest='/u02/app/oracle/fast_recovery_area'
set db_file_name_convert='/cdb1/','/cdb3/'
set log_file_name_convert='/cdb1/','/cdb3/'
set fal_client='cdb3'
set fal_server='cdb1'
set standby_file_management='AUTO'
;
}


-----------------------------------------------------------------------------------------------------------------------
-- dup2ndstby.rcv output
-----------------------------------------------------------------------------------------------------------------------
[oracle@gdat8124 script]$ rman

Recovery Manager: Release 12.1.0.2.0 - Production on Mon Apr 24 11:15:01 2017

Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights reserved.

RMAN> connect target sys/rGIH201704@cdb1

connected to target database: CDB1 (DBID=915444010)

RMAN> connect auxiliary sys/rGIH201704@cdb3

connected to auxiliary database: CDB1 (not mounted)

RMAN> @dup2ndstby.rcv

RMAN> run {
2> duplicate target database for standby from active database
3> dorecover
4> spfile
5> parameter_value_convert 'cdb1','cdb3'
6> set db_unique_name='cdb3'
7> set db_recovery_file_dest='/u02/app/oracle/fast_recovery_area'
8> set db_file_name_convert='/cdb1/','/cdb3/'
9> set log_file_name_convert='/cdb1/','/cdb3/'
10> set fal_client='cdb3'
11> set fal_server='cdb1'
12> set standby_file_management='AUTO'
13> ;
14> }
Starting Duplicate Db at 24-APR-17
using target database control file instead of recovery catalog
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=12 device type=DISK
current log archived

contents of Memory Script:
{
   backup as copy reuse
   targetfile  '/u01/app/oracle/product/12.1.0/dbhome_1/dbs/orapwcdb1' auxiliary format
 '/u01/app/oracle/product/12.1.0/dbhome_1/dbs/orapwcdb3'   ;
   restore clone from service  'cdb1' spfile to
 '/u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb3.ora';
   sql clone "alter system set spfile= ''/u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb3.ora''";
}
executing Memory Script

Starting backup at 24-APR-17
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=1202 device type=DISK
Finished backup at 24-APR-17

Starting restore at 24-APR-17
using channel ORA_AUX_DISK_1

channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: restoring SPFILE
output file name=/u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb3.ora
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:01
Finished restore at 24-APR-17

sql statement: alter system set spfile= ''/u01/app/oracle/product/12.1.0/dbhome_1/dbs/spfilecdb3.ora''

contents of Memory Script:
{
   sql clone "alter system set  audit_file_dest =
 ''/u01/app/oracle/admin/cdb3/adump'' comment=
 '''' scope=spfile";
   sql clone "alter system set  control_files =
 ''/u03/app/oracle/oradata/cdb3/control01.ctl'', ''/u02/app/oracle/fast_recovery_area/cdb3/control02.ctl'' comment=
 '''' scope=spfile";
   sql clone "alter system set  dispatchers =
 ''(PROTOCOL=TCP) (SERVICE=cdb3XDB)'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_unique_name =
 ''cdb3'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_recovery_file_dest =
 ''/u02/app/oracle/fast_recovery_area'' comment=
 '''' scope=spfile";
   sql clone "alter system set  db_file_name_convert =
 ''/cdb1/'', ''/cdb3/'' comment=
 '''' scope=spfile";
   sql clone "alter system set  log_file_name_convert =
 ''/cdb1/'', ''/cdb3/'' comment=
 '''' scope=spfile";
   sql clone "alter system set  fal_client =
 ''cdb3'' comment=
 '''' scope=spfile";
   sql clone "alter system set  fal_server =
 ''cdb1'' comment=
 '''' scope=spfile";
   sql clone "alter system set  standby_file_management =
 ''AUTO'' comment=
 '''' scope=spfile";
   shutdown clone immediate;
   startup clone nomount;
}
executing Memory Script

sql statement: alter system set  audit_file_dest =  ''/u01/app/oracle/admin/cdb3/adump'' comment= '''' scope=spfile

sql statement: alter system set  control_files =  ''/u03/app/oracle/oradata/cdb3/control01.ctl'', ''/u02/app/oracle/fast_recovery_area/cdb3/control02.ctl'' comment= '''' scope=spfile

sql statement: alter system set  dispatchers =  ''(PROTOCOL=TCP) (SERVICE=cdb3XDB)'' comment= '''' scope=spfile

sql statement: alter system set  db_unique_name =  ''cdb3'' comment= '''' scope=spfile

sql statement: alter system set  db_recovery_file_dest =  ''/u02/app/oracle/fast_recovery_area'' comment= '''' scope=spfile

sql statement: alter system set  db_file_name_convert =  ''/cdb1/'', ''/cdb3/'' comment= '''' scope=spfile

sql statement: alter system set  log_file_name_convert =  ''/cdb1/'', ''/cdb3/'' comment= '''' scope=spfile

sql statement: alter system set  fal_client =  ''cdb3'' comment= '''' scope=spfile

sql statement: alter system set  fal_server =  ''cdb1'' comment= '''' scope=spfile

sql statement: alter system set  standby_file_management =  ''AUTO'' comment= '''' scope=spfile

Oracle instance shut down

connected to auxiliary database (not started)
Oracle instance started

Total System Global Area    4026531840 bytes

Fixed Size                     2931856 bytes
Variable Size               1275069296 bytes
Database Buffers            2734686208 bytes
Redo Buffers                  13844480 bytes

contents of Memory Script:
{
   restore clone from service  'cdb1' standby controlfile;
}
executing Memory Script

Starting restore at 24-APR-17
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=13 device type=DISK

channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: restoring control file
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:04
output file name=/u03/app/oracle/oradata/cdb3/control01.ctl
output file name=/u02/app/oracle/fast_recovery_area/cdb3/control02.ctl
Finished restore at 24-APR-17

contents of Memory Script:
{
   sql clone 'alter database mount standby database';
}
executing Memory Script

sql statement: alter database mount standby database

contents of Memory Script:
{
   set newname for tempfile  1 to
 "/u03/app/oracle/oradata/cdb3/temp01.dbf";
   set newname for tempfile  2 to
 "/u03/app/oracle/oradata/cdb3/pdbseed/temp01.dbf";
   set newname for tempfile  3 to
 "/u03/app/oracle/oradata/cdb3/rgihw/temp01.dbf";
   switch clone tempfile all;
   set newname for datafile  1 to
 "/u03/app/oracle/oradata/cdb3/system01.dbf";
   set newname for datafile  2 to
 "/u03/app/oracle/oradata/cdb3/pdbseed/system01.dbf";
   set newname for datafile  3 to
 "/u03/app/oracle/oradata/cdb3/sysaux01.dbf";
   set newname for datafile  4 to
 "/u03/app/oracle/oradata/cdb3/pdbseed/sysaux01.dbf";
   set newname for datafile  5 to
 "/u03/app/oracle/oradata/cdb3/undotbs01.dbf";
   set newname for datafile  6 to
 "/u03/app/oracle/oradata/cdb3/users01.dbf";
   set newname for datafile  7 to
 "/u03/app/oracle/oradata/cdb3/rgihw/system01.dbf";
   set newname for datafile  8 to
 "/u03/app/oracle/oradata/cdb3/rgihw/sysaux01.dbf";
   set newname for datafile  9 to
 "/u03/app/oracle/oradata/cdb3/rgihw/rgihw_users01.dbf";
   restore
   from service  'cdb1'   clone database
   ;
   sql 'alter system archive log current';
}
executing Memory Script

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

renamed tempfile 1 to /u03/app/oracle/oradata/cdb3/temp01.dbf in control file
renamed tempfile 2 to /u03/app/oracle/oradata/cdb3/pdbseed/temp01.dbf in control file
renamed tempfile 3 to /u03/app/oracle/oradata/cdb3/rgihw/temp01.dbf in control file

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

Starting restore at 24-APR-17
using channel ORA_AUX_DISK_1

channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00001 to /u03/app/oracle/oradata/cdb3/system01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:36
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00002 to /u03/app/oracle/oradata/cdb3/pdbseed/system01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:15
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00003 to /u03/app/oracle/oradata/cdb3/sysaux01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:46
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00004 to /u03/app/oracle/oradata/cdb3/pdbseed/sysaux01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:15
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00005 to /u03/app/oracle/oradata/cdb3/undotbs01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:35
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00006 to /u03/app/oracle/oradata/cdb3/users01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:02
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00007 to /u03/app/oracle/oradata/cdb3/rgihw/system01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:15
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00008 to /u03/app/oracle/oradata/cdb3/rgihw/sysaux01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:15
channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: specifying datafile(s) to restore from backup set
channel ORA_AUX_DISK_1: restoring datafile 00009 to /u03/app/oracle/oradata/cdb3/rgihw/rgihw_users01.dbf
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:01
Finished restore at 24-APR-17

sql statement: alter system archive log current
current log archived

contents of Memory Script:
{
   restore clone force from service  'cdb1'
           archivelog from scn  2454893;
   switch clone datafile all;
}
executing Memory Script

Starting restore at 24-APR-17
using channel ORA_AUX_DISK_1

channel ORA_AUX_DISK_1: starting archived log restore to default destination
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: restoring archived log
archived log thread=1 sequence=43
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:01
channel ORA_AUX_DISK_1: starting archived log restore to default destination
channel ORA_AUX_DISK_1: using network backup set from service cdb1
channel ORA_AUX_DISK_1: restoring archived log
archived log thread=1 sequence=44
channel ORA_AUX_DISK_1: restore complete, elapsed time: 00:00:01
Finished restore at 24-APR-17

datafile 1 switched to datafile copy
input datafile copy RECID=1 STAMP=942146455 file name=/u03/app/oracle/oradata/cdb3/system01.dbf
datafile 2 switched to datafile copy
input datafile copy RECID=2 STAMP=942146455 file name=/u03/app/oracle/oradata/cdb3/pdbseed/system01.dbf
datafile 3 switched to datafile copy
input datafile copy RECID=3 STAMP=942146455 file name=/u03/app/oracle/oradata/cdb3/sysaux01.dbf
datafile 4 switched to datafile copy
input datafile copy RECID=4 STAMP=942146455 file name=/u03/app/oracle/oradata/cdb3/pdbseed/sysaux01.dbf
datafile 5 switched to datafile copy
input datafile copy RECID=5 STAMP=942146455 file name=/u03/app/oracle/oradata/cdb3/undotbs01.dbf
datafile 6 switched to datafile copy
input datafile copy RECID=6 STAMP=942146455 file name=/u03/app/oracle/oradata/cdb3/users01.dbf
datafile 7 switched to datafile copy
input datafile copy RECID=7 STAMP=942146455 file name=/u03/app/oracle/oradata/cdb3/rgihw/system01.dbf
datafile 8 switched to datafile copy
input datafile copy RECID=8 STAMP=942146455 file name=/u03/app/oracle/oradata/cdb3/rgihw/sysaux01.dbf
datafile 9 switched to datafile copy
input datafile copy RECID=9 STAMP=942146455 file name=/u03/app/oracle/oradata/cdb3/rgihw/rgihw_users01.dbf

contents of Memory Script:
{
   set until scn  2455549;
   recover
   standby
   clone database
    delete archivelog
   ;
}
executing Memory Script

executing command: SET until clause

Starting recover at 24-APR-17
using channel ORA_AUX_DISK_1

starting media recovery

archived log for thread 1 with sequence 43 is already on disk as file /u02/app/oracle/fast_recovery_area/CDB3/archivelog/2017_04_24/o1_mf_1_43_dhtvrong_.arc
archived log for thread 1 with sequence 44 is already on disk as file /u02/app/oracle/fast_recovery_area/CDB3/archivelog/2017_04_24/o1_mf_1_44_dhtvrpfj_.arc
archived log file name=/u02/app/oracle/fast_recovery_area/CDB3/archivelog/2017_04_24/o1_mf_1_43_dhtvrong_.arc thread=1 sequence=43
archived log file name=/u02/app/oracle/fast_recovery_area/CDB3/archivelog/2017_04_24/o1_mf_1_44_dhtvrpfj_.arc thread=1 sequence=44
media recovery complete, elapsed time: 00:00:01
Finished recover at 24-APR-17

Finished Duplicate Db at 24-APR-17

RMAN>
RMAN> **end-of-file**

RMAN>
RMAN>



-----------------------------------------------------------------------------------------------------------------------
-- Create rmancat catalog output
-----------------------------------------------------------------------------------------------------------------------
SQL> alter session set container=rmancat;

Session altered.

SQL> @tsp1

                              Allocated          Used          Free            No. of     Largest    Smallest  Nxt Reqd
Tablespace Name      Auto        MBytes        MBytes        MBytes Used %% Free Exts   Exts (KB)   Exts (KB) Exts (KB)
-------------------- ---- ------------- ------------- ------------- ------- --------- ----------- ----------- ---------
SYSAUX               YES         834.41        793.66         40.75   95.12         2      41,600         128     1,024
SYSTEM               YES         614.41        298.28        316.13   48.55         1     323,712     323,712     1,024
TEMP                 YES       2,048.00      2,048.00           .00  100.00                                           0
USERS                YES           5.00          1.00          4.00   20.00         1       4,096       4,096         0
                          ------------- ------------- -------------
TOTAL                          3,501.81      3,140.94        360.88

create tablespace rman_data datafile '/u03/app/oracle/oradata/rmandb/rmancat/rman_data01.dbf' size 100M
  2  autoextend on next 100M maxsize 2G;
create user rmancat identified by rmancat
default tablespace rman_data
  3  quota unlimited on rman_data;
SQL>
SQL>
SQL> grant connect, recovery_catalog_owner to rmancat;
SQL>
SQL>
SQL> exit


[oracle@gfsf8232 script]$ rman catalog rmancat@rmancat

Recovery Manager: Release 12.1.0.2.0 - Production on Wed Apr 26 12:11:33 2017

Copyright (c) 1982, 2014, Oracle and/or its affiliates.  All rights reserved.

recovery catalog database Password:
connected to recovery catalog database

RMAN> create catalog;

recovery catalog created

RMAN> exit


Recovery Manager complete.
[oracle@gfsf8232 script]$ sqlplus / as sysdba

SQL*Plus: Release 12.1.0.2.0 Production on Wed Apr 26 12:13:20 2017

Copyright (c) 1982, 2014, Oracle.  All rights reserved.


Connected to:
Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production
With the Partitioning, OLAP, Advanced Analytics and Real Application Testing options

SQL> alter session set container=rmancat;

Session altered.

SQL> spool /home/oracle/script/create_rmancat.out
SQL> @?/rdbms/admin/dbmsrmansys.sql

Session altered.


PL/SQL procedure successfully completed.


PL/SQL procedure successfully completed.


Grant succeeded.


Grant succeeded.


Grant succeeded.


Grant succeeded.


Grant succeeded.


Grant succeeded.


Grant succeeded.


Grant succeeded.


Session altered.

SQL> @?/rdbms/admin/dbmsrmanvpc.sql -all

Checking the operating user... Passed

----------------------------------------
Removing old VPC views in the base catalog of RMANCAT...
========================================
UPGRADE STATUS
The VPC user schemas of these catalogs: RMANCAT
have been successfully upgraded to the new VPD model!

Disconnected from Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production
With the Partitioning, OLAP, Advanced Analytics and Real Application Testing options
[oracle@gfsf8232 script]$ sqlplus rmancat/rmancat@rmancat

SQL*Plus: Release 12.1.0.2.0 Production on Wed Apr 26 12:15:05 2017

Copyright (c) 1982, 2014, Oracle.  All rights reserved.

Last Successful login time: Wed Apr 26 2017 12:11:36 +08:00

Connected to:
Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production
With the Partitioning, OLAP, Advanced Analytics and Real Application Testing options

SQL> SELECT TABLE_NAME FROM USER_TABLES;

TABLE_NAME
--------------------------------------------------------------------------------------------------------------------------------
BASCHEMAVER
WATERMARKS
DO_SEQ
DELETED_OBJECT
TEMPRES
RCVER
ROUT
BCR
RRCACHE
ORSEVENT
RCFILE
SERVER
XMLSTORE
CFS
VPC_DATABASES
VPC_USERS
NRSP
GRSP
FB
RSR
XAL
CONFIG
SCRL
SCR
CCB
BCB
BRL
XDF
CDF
BDF
BSF
XCF
CCF
BCF
BP
BS
AL
RLH
ORL
RT
RR
OFFR
SITE_TFATT
TF
SITE_DFATT
DF
TSATT
TS
CKP
PDB_DBINC
PDBINC
PDB
DBINC
CONF
NODE
DB

56 rows selected.

SQL> select * from rcver;

VERSION
------------
12.01.00.02

SQL>



==========================================================================================================================
===  MISC
==========================================================================================================================

[oracle@gdat8124 oracle-software]$
Message from syslogd@gdat8124 at Apr 18 16:07:29 ...
 kernel:NMI watchdog: BUG: soft lockup - CPU#1 stuck for 22s! [watchdog/1:11]


 